<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Speaker Diarisation : VIA</title>
    <meta name="author" content="Abhishek Dutta">
    <meta name="description" content="VIA is a standalone image annotator application packaged as a single HTML file (< 400 KB) that runs on most modern web browsers.">

    <!--
    Development of VIA is supported by the EPSRC programme grant
    Seebibyte: Visual Search for the Era of Big Data (EP/M013774/1).
    Using Google Analytics, we record the usage of this application.
    This data is used in reporting of this programme grant.

    If you do not wish to share this data, you can safely remove the
    javascript code below.
    -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                               m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-20555581-2', 'auto');
      ga('set', 'page', '/via/3.0.0/speaker_diarisation');
      ga('send', 'pageview');
    </script>

<!-- Start of file: css/via_diarise_test_set.css-->
<style>
/*

CSS style definitions for VIA Speaker Diarisation tool

Theme: https://material.io/tools/color/#!/?view.left=0&view.right=0&primary.color=9E9E9E&secondary.color=FFEB3B
Primary:  #9e9e9e
  light:  #cfcfcf
  dark:   #707070
Secondary: #ffeb3b
  light:  #ffff72
  dark:   #c8b900
Text
  primary:    #000000
  secondary:  #000000



Author: Abhishek Dutta <adutta@robots.ox.ac.uk>
Date: 5 Mar. 2019
*/

html, body { margin:0; padding:0; box-sizing:border-box; font-family:Sans; font-size:1em; }

*, *:before, *:after { box-sizing:inherit; }

.via { position:relative; display:flex; flex-direction:column; flex-wrap:nowrap; padding:0.3em 0.2em; background-color:#ffffff; height:100vh; overflow:hidden; }

.cpanel { display:flex; border:1px solid #707070; padding:0.4em 0.5em; background-color:#ffeeaa; }
.cpanel .tool_group { display:inline-block; margin:0 1%; padding:0; }
.cpanel .tool_group:first-child { margin-left:0; }
.cpanel .tool_group:last-child { margin-right:0; }
.cpanel .logo { display:inline-block; line-height:1.4em;}
.cpanel .logo a { text-decoration:none; }
.cpanel .tool_group select { background-color:inherit; border:1px solid #cfcfcf; vertical-align:middle; width:10em; }
.cpanel .tool_group input { background-color:inherit; border:1px solid #cfcfcf; vertical-align:middle; width:4em;}
.cpanel .tool_group .project_name_container { display:inline-block; vertical-align:middle; font-size:small; width:10em; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; text-align:right; }

.annotator_container { flex:auto; padding-top:0em; margin-top:0.5em; }
.annotator_container > .file_container { display:none; height:100%; }
.annotator_container > .file_show { display:block !important; }
.annotator_container > .file_container > .region_annotator_container { display:block; position:relative; }
.annotator_container > .file_container > .region_annotator_container * { position:absolute; left:0; top:0; }
.annotator_container > .file_container > .region_annotator_container > .layer_region { pointer-events:none; }

.annotator_container > .file_container > .temporal_segmenter_container { position:relative; display:block; background-color:white; margin:0; padding:1em 0; }
.annotator_container > .file_container > .temporal_segmenter_container > .thumbnail_container { z-index:1000; }
.annotator_container > .file_container > .temporal_segmenter_container > .video_timeline { display:block; margin:0; padding:0;  }
.annotator_container > .file_container > .temporal_segmenter_container > .video_timeline_mark { display:block; margin:0; padding:0; }

.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container { border:1px solid #909090; margin-top:1em; }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container canvas { margin:0; padding:0; }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container .gtimeline { cursor:pointer; }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .header_container {}
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .header_container table { border-collapse:collapse; }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .header_container td { display:inline-block; overflow:hidden; margin:0; padding:0; }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .header_container select { width:100%; }

.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .metadata_container {}
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .metadata_container table { border-collapse:collapse; }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .metadata_container td { display:inline-block; overflow:hidden; margin:0; padding:0;  }
.annotator_container > .file_container > .temporal_segmenter_container > .tmetadata_container > .metadata_container input[type="text"] { width:100%; }

.annotator_container > .file_container > .temporal_segmenter_container > .toolbar_container { display:block; padding:1em 0.5em; font-size:small; }
.annotator_container > .file_container > .temporal_segmenter_container > .toolbar_container div { margin:0 2em; display:inline-block; }
.annotator_container > .file_container > .temporal_segmenter_container > .toolbar_container div:first-child { margin:0; }
.annotator_container > .file_container > .temporal_segmenter_container > .toolbar_container input {font-size:small; vertical-align:middle; }
.annotator_container > .file_container > .temporal_segmenter_container > .toolbar_container button {font-size:small; vertical-align:middle; margin-right:0.5em;}
.annotator_container > .file_container > .temporal_segmenter_container > .toolbar_container label {vertical-align:middle; }

/* Editor panel for add/update/view metadata and attributes */
.editor_container { display:none; position:absolute; bottom:0; left:0; right:0; height:30vh; overflow:auto; background-color:white; }
.editor_container .hide { display:none !important; }
.editor_container svg { font-size:large; margin:0 0.4em; }
.editor_container > .editor_content_selector { display:block; margin:0; padding:0.4em 1em;  }
.editor_container > .content_container {display:inline-block; padding:0 1em; }
.editor_container > .content_container table { border-collapse:collapse; border:1px solid #cccccc; }
.editor_container > .content_container th { border:1px solid #cccccc; }
.editor_container > .content_container td { border:1px solid #cccccc; padding:0.3em 0.4em; }
.editor_container > .content_container .attribute_entry { display:block; margin-bottom:0.4em; }

/* Misc */
.svg_button { width:1.2em; height:1.2em; fill:black; stroke:none; vertical-align:middle; }
.svg_button:hover { fill:#cfcfcf; cursor:pointer; }
.svg_button:active { fill:#707070; cursor:pointer; }
.disabled_button { fill:#cfcfcf !important; cursor:auto !important; }
.disabled_button:hover { fill:#cfcfcf !important; cursor:auto !important; }
.disabled_button:active { fill:#cfcfcf !important; cursor:auto !important; }
.text_button { border:none; color:blue; background-color:inherit; cursor:pointer; display:inline-block; }
.text_button:hover { color:black; }

/* info pages */
.info_page_container { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:1001; text-align:center; }
.info_page_container > .toolbar { position:relative; display:block; text-align:right; padding:1em; }
.info_page_container > .info_page { position:relative; display:inline-block; color:black; background-color:white; padding:1em 2em; overflow:auto; text-align:left; content:"close"; height:100vh;}
.info_page_container > .info_page .toolbar { display:block; text-align:right; }
.info_page_container > .info_page table { border-collapse:collapse; border:1px solid #cccccc; }
.info_page_container > .info_page th { border:1px solid #cccccc; padding:0.3em 0.4em; }
.info_page_container > .info_page td { border:1px solid #cccccc; padding:0.3em 0.4em; }
.info_page_container > .info_page div { width:45em; }

/* Message Panel */
#_via_message_container { display:none; width:100vw; position:fixed; bottom:0px; z-index:9999; text-align:center; }
#_via_message_container #_via_message { display:inline; margin:auto; background-color:#000000; color:#ffff00; font-size:medium; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:2rem; padding: 0.5rem 2rem;}
.key { font-family:monospace; padding:1px 6px; background:linear-gradient(to bottom,#f0f0f0,#fcfcfc);; border:1px solid #e0e0e0; white-space:nowrap; color:#303030; border-bottom-width:2px; border-radius:3px; font-size:1.2em; }
</style>
<!-- End of file: css/via_diarise_test_set.css-->
  </head>

  <body onresize="_via_on_browser_resize()">
    <div class="via">
      <div id="_via_message_container" class="message_container" onclick="_via_util_msg_hide()">
        <div id="_via_message"></div>
      </div>

      <div class="cpanel">
        <div class="tool_group">
          <div class="logo"><a href="http://www.robots.ox.ac.uk/~vgg/software/via/" title="VGG Image Annotator (VIA)">VIA</a></div>
        </div>

        <div id="project" class="tool_group">
          <!--
          <svg onclick="data.load_local()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_open"></use><title>Open Project</title></svg>
          <svg onclick="data.save_local()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_save"></use><title>Save Project</title></svg>

          <svg onclick="data.save_remote()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_upload"></use><title>Upload Project</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_settings"></use><title>Project Settings</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_upload"></use><title>Upload Project</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_download"></use><title>Download Project</title></svg>
              -->
        </div>

        <div id="import_export" class="tool_group">
          <!--
              <svg onclick="io.metadata_import_csv()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#icon_import"></use><title>Import Metadata from CSV</title></svg>

              <svg onclick="io.speaker_diarisation_export_csv()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#icon_export"></use><title>Download Metadata as CSV</title></svg>
              -->
        </div>

        <div id="file_manager_container" class="tool_group">
          <select id="project_list" title="List of Videos" style="width:12em;"></select>
          <div title="Current Video Id" id="_via_filemanager_project_name" class="project_name_container"></div>

          <select style="display:none;" id="file_manager_filelist" title="List of files in this project"></select>
          <input style="display:none;" type="text" placeholder="Search" oninput="file_manager._filelist_update_regex(this.value)">
          <!--
          <svg onclick="file_manager.on_file_show_prev()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_navigate_prev"></use><title>Show previous file</title></svg>
          <svg onclick="file_manager.on_file_show_next()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_navigate_next"></use><title>Show next file</title></svg>
          -->

          <!--
              <svg onclick="file_manager.on_file_select_local_video()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_add_video"></use><title>Add video file from this computer</title></svg>

              <svg onclick="file_manager.on_file_select_local_image()" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_add_image"></use><title>Add Image</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_add_audio"></use><title>Add Audio</title></svg>

              <svg onclick="file_manager.on_file_bulk_add_uri()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_lib_add"></use><title>Bulk add file URI ( e.g. file:///... or http://... ) contained in a local CSV file where each row is a remote or local filename.</title></svg>
              <svg onclick="file_manager.on_file_remove_current()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_remove_circle"></use><title>Remove the current file from project</title></svg>
              -->
        </div>


        <div id="content_tools" class="tool_group">
          <!--
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_zoomin"></use><title>Zoom In</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_zoomout"></use><title>Zoom Out</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_copy"></use><title>Copy Selected Regions</title></svg>
              <svg onclick="" class="svg_button disabled_button" viewbox="0 0 24 24"><use xlink:href="#micon_paste"></use><title>Paste Selected Regions</title></svg>
              <svg onclick="document.getElementById('editor_container').classList.toggle('hide')" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_insertcomment"></use><title>Show/hide metadata and attribute editor</title></svg>
              -->
        </div>

        <!--
            <div id="region_shape" class="tool_group" >
              <svg onclick="" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#shape_point"></use><title>Point</title></svg>
              <svg onclick="" class="svg_button" viewbox="0 0 24 24" ><use xlink:href="#shape_rectangle"></use><title>Rectangle</title></svg>
              <svg onclick="" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#shape_circle"></use><title>Circle</title></svg>
              <svg onclick="" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#shape_ellipse"></use><title>Ellipse</title></svg>
              <svg onclick="" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#shape_polygon"></use><title>Polygon</title></svg>
              <svg onclick="" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#shape_polyline"></use><title>Polyline</title></svg>
            </div>
            -->

            <!--            -->
            <div id="restore" class="tool_group" >
              <svg style="display:none;" id="_via_restore_load_button" onclick="store.prev_session_load()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_restore_load"></use><title>Restore to previous version that was not yet uploaded!</title></svg>

              <svg style="display:none;" id="_via_restore_save_button" onclick="store.prev_session_save()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_restore_save"></use><title>Restore and save VIA project data from previous session</title></svg>
            </div>

            <div id="help" class="tool_group" >
              <svg onclick="_via_util_show_info_page('keyboard_shortcuts')" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_help"></use><title>Help</title></svg>
            </div>

            <div id="remote" class="tool_group" >
              <input id="remote_push_username" type="text" title="To upload, you must enter your username (min 5 characters and no special characters or spaces)" placeholder="Enter username" style="width:10em;" autocomplete="on">
              <svg onclick="data.save_remote()" class="svg_button" viewbox="0 0 24 24"><use xlink:href="#micon_upload"></use><title>Upload</title></svg>

            </div>

            <div id="region_info_panel" class="tool_group" >
              <!--
                  display the (x,y) coordinate of current mouse cursor
                  display the boundaries of current selected region
                  ...
                -->
            </div>
      </div>
      <div id="annotator_container" class="annotator_container"></div>
      <div id="editor_container" class="editor_container"></div>

      <!-- Information Panel (displayed when user wants to see them) -->
      <div id="_via_info_page_container" class="info_page_container">
        <div data-pageid="keyboard_shortcuts" class="info_page">
          <div class="toolbar"><span onclick="_via_util_hide_info_page()" class="text_button">&times;</span></div>
          <h1>Keyboard Shortcuts</h1>
          <h3>General</h3>
          <table>
            <thead>
              <tr>
                <th>Command</th>
                <th>Shortcut</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Play/Pause Media</td><td><span class="key">Space</span></td></tr>
              <tr><td>Toggle Media Mute</td><td><span class="key">m</span></td></tr>
              <tr><td>Increase / Decrease Media Playback Speed</td><td><span class="key">+</span> / <span class="key">-</span></td></tr>
              <tr><td>Move Media Time Backward by 1, ..., 9 sec. (Ctrl to move forward)</td><td><span class="key">Ctrl</span> + <span class="key">1</span>, <span class="key">2</span>, ..., <span class="key">9</span</td></tr>
                                                                                                                                                                                                                  <tr><td>Add Temporal Segment at Current Time</td><td><span class="key">a</span></td></tr>
              <tr><td>Update the edge (left or right) of last added segment to current time</td><td><span class="key">Shift</span> + <span class="key">a</span></td></tr>

              <tr><td>Select Previous / Next Temporal Group (e.g. Speaker)</td><td><span class="key">&uarr;</span> / <span class="key">&darr;</span></td></tr>

              <tr><td>Select [Previous] Next Temporal Segment (e.g. 3sec to 5sec)</td><td><span class="key">Shift</span> + <span class="key">Tab</span></td></tr>
              <tr><td>Select Temporal Segment at Current Time (if any)</td><td><span class="key">Enter</span></td></tr>

              <tr><td>Move to Previous / Next Video Frame</td><td><span class="key">l</span> / <span class="key">r</span></td></tr>
              <tr><td>Jump to Start/End of Video</td><td><span class="key">Shift</span> + <span class="key">s</span> / <span class="key">e</span></td></tr>
              <tr><td>Shift Visible Timeline by 1 sec.</td><td><span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
              <tr><td>Shift Visible Timeline by 60 sec.</td><td><span class="key">Shift</span> + <span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
              <tr><td>Zoom In/Out the Temporal Segment Timeline</td><td>Mouse Wheel<br/></td></tr>
              <tr><td>Pan the Temporal Segment Timeline Horizontally</td><td><span class="key">Shift</span> + Mouse Wheel</td></tr>
            </tbody>
          </table>
          <h3>When a Temporal Segment is Selected</h3>
          <table>
            <thead>
              <tr>
                <th>Command</th>
                <th>Shortcut</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Video Play/Pause Locked to Segment Boundary</td><td><span class="key">Spc</span></td></tr>
              <tr><td>Delete Selected Temporal Segment</td><td><span class="key">Backspace</span></td></tr>
              <tr><td>Select [Previous] Next Temporal Segment</td><td>[<span class="key">Shift</span>] + <span class="key">Tab</span></td></tr>
              <tr><td>Unselect Temporal Segment</td><td><span class="key">Esc</span></td></tr>
              <tr><td>Increase/Decrease the Extent of Left Edge (Ctrl updates by 1 sec.)</td><td>[<span class="key">Ctrl</span>] + <span class="key">l</span> / <span class="key">L</span></td></tr>
              <tr><td>Increase/Decrease the Extent of Right edge (Ctrl updates by 1 sec.)</td><td>[<span class="key">Ctrl</span>] + <span class="key">r</span> / <span class="key">R</span></td></tr>

              <tr><td>Jump to Start/End of Temporal Segment</td><td><span class="key">s</span> / <span class="key">e</span></td></tr>
              <tr><td>Move Selected Temporal Segment (Ctrl updates by 1 sec.)</td><td>[<span class="key">Ctrl</span>] + <span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
              <tr><td>Merge Selected Temporal Segment with the Segment on Left/Right</td><td><span class="key">Shift</span> + <span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
            </tbody>
          </table>
          <p>&nbsp;</p>

          <h1>About VIA</h1>
          <div>This is a preview release of version 3.0.0 of the VGG Image Annotator (VIA). VIA is an open source project developed at the <a href="http://www.robots.ox.ac.uk/~vgg/">Visual Geometry Group</a> and released under the BSD-2 clause license. For more details, visit the <a href="http://www.robots.ox.ac.uk/~vgg/software/via/">VIA project website</a>.</div>
          <div>
          <h3>License</h3>
          <pre>Copyright (c) 2019, Abhishek Dutta, Visual Geometry Group, Oxford University.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
          </pre>
          </div>
        </div>
      </div>
    </div>

<!-- Start of file: js/_via_util.js-->
<script>
/**
 * Utilities used by VIA default user interface
 *
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 */

'use strict'

var _via_msg_clear_timer; // holds a reference to current message timoout

function _via_util_get_svg_button(id, title, viewbox) {
  var svg_viewbox = viewbox;
  if ( typeof(svg_viewbox) === 'undefined' ) {
    svg_viewbox = '0 0 24 24';
  }

  var el = document.createElementNS(_VIA_SVG_NS, 'svg');
  el.setAttributeNS(null, 'viewbox', svg_viewbox);
  el.innerHTML = '<use xlink:href="#' + id + '"></use><title>' + title + '</title>';
  el.setAttributeNS(null, 'class', 'svg_button');
  return el;
}

function _via_util_get_html_input_element_value(el) {
  switch(el.tagName) {
  case 'TEXTAREA':
    return el.value;

  case 'SELECT':
    return el.options[el.selectedIndex].value;

  case 'INPUT':
    return el.value;
  }
}

function _via_util_get_filename_from_uri(uri) {
  if ( uri.includes('/') ) {
    var tokens = uri.split('/');
    return tokens[ tokens.length - 1 ];
  } else {
    return uri;
  }
}

function _via_util_file_type_to_str(type) {
  switch(type) {
    case _VIA_FILE_TYPE.IMAGE:
      return 'image';
      break;
    case _VIA_FILE_TYPE.VIDEO:
      return 'video';
      break;
    case _VIA_FILE_TYPE.AUDIO:
      return 'audio';
      break;
    default:
      return 'unknown ' + type.toString();
  }
}

function _via_util_file_type_str_to_id(type) {
  switch(type) {
    case 'image':
      return _VIA_FILE_TYPE.IMAGE;
      break;
    case 'video':
      return _VIA_FILE_TYPE.VIDEO;
      break;
    case 'audio':
      return _VIA_FILE_TYPE.AUDIO;
      break;
    default:
      return -1;
  }
}

function _via_util_file_loc_to_str(loc) {
  switch(loc) {
    case _VIA_FILE_TYPE.LOCAL:
      return 'local';
      break;
    case _VIA_FILE_TYPE.URIHTTP:
      return 'http://';
      break;
    case _VIA_FILE_TYPE.URIFILE:
      return 'file://';
      break;
    case _VIA_FILE_TYPE.URIFILE:
      return 'inline';
      break;
    default:
      return 'unknown-type-id=' + type.toString();
  }
}

function _via_util_file_loc_str_to_id(loc) {
  switch(loc) {
    case 'local':
      return _VIA_FILE_TYPE.LOCAL;
      break;
    case 'http://':
      return _VIA_FILE_TYPE.URIHTTP;
      break;
    case 'file://':
      return _VIA_FILE_TYPE.URIFILE;
      break;
    case 'inline':
      return _VIA_FILE_TYPE.URIFILE;
      break;
    default:
      return -1;
  }
}

function _via_util_metadata_target_str(target_id) {
  switch(target_id) {
    case _VIA_WHERE_TARGET.SEGMENT:
      return 'segment';
      break;
    case _VIA_WHERE_TARGET.FRAME:
      return 'frame';
      break;
    case _VIA_WHERE_TARGET.IMAGE:
      return 'image';
      break;
    default:
      return 'unknown';
  }
}

function _via_util_metadata_shape_str(shape_id) {
  switch(shape_id) {
    case _VIA_WHERE_SHAPE.TIME:
      return 'time';
      break;
    case _VIA_WHERE_SHAPE.RECT:
      return 'rect';
      break;
    case _VIA_WHERE_SHAPE.CIRCLE:
      return 'circle';
      break;
    case _VIA_WHERE_SHAPE.ELLIPSE:
      return 'ellipse';
      break;
    case _VIA_WHERE_SHAPE.POINT:
      return 'point';
      break;
    case _VIA_WHERE_SHAPE.POLYLINE:
      return 'polyline';
      break;
    case _VIA_WHERE_SHAPE.POLYGON:
      return 'polygon';
      break;
    default:
      return 'unknown';
  }
}

function _via_util_escape_quote_for_csv(s) {
  return s.replace(/["]/g, '""');
}

function _via_util_load_text_file(text_file, callback_function) {
  if (text_file) {
    var text_reader = new FileReader();

    text_reader.addEventListener( 'error', function() {
      console.log('Error loading data text file :  ' + text_file.name + ' !');
      callback_function('');
    }, false);

    text_reader.addEventListener( 'load', function() {
      callback_function(text_reader.result);
    }, false);
    text_reader.readAsText(text_file, 'utf-8');
  }
}

function _via_util_file_ext(filename) {
  return filename.substr( filename.lastIndexOf('.') + 1 );
}

function _via_util_infer_file_loc_from_filename(filename) {
  if ( filename.startsWith('http://') ) {
    return _VIA_FILE_LOC.URIHTTP;
  } else {
    if ( filename.startsWith('file://') ) {
      return _VIA_FILE_LOC.URIFILE;
    } else {
      return _VIA_FILE_LOC.LOCAL;
    }
  }
}

function _via_util_infer_file_type_from_filename(filename) {
  var ext = _via_util_file_ext(filename);
  switch( ext ) {
  case 'ogv':
  case 'mp4':
  case 'avi':
    return _VIA_FILE_TYPE.VIDEO;
    break;
  case 'jpg':
  case 'png':
  case 'bmp':
    return _VIA_FILE_TYPE.IMAGE;
    break;
  }
}


function _via_util_download_as_file(data, filename) {
  var a      = document.createElement('a');
  a.href     = URL.createObjectURL(data);
  a.download = filename;

  // simulate a mouse click event
  var event = new MouseEvent('click', {
    view: window,
    bubbles: true,
    cancelable: true
  });
  a.dispatchEvent(event);
}

function _via_util_file_select_local(type, handler, multiple) {
  var fsel = document.createElement('input');
  fsel.setAttribute('type', 'file');
  fsel.setAttribute('name', 'files[]');
  if ( typeof(multiple) === 'undefined' ||
       multiple === true ) {
    fsel.setAttribute('multiple', 'multiple')
  }

  switch(type) {
  case _VIA_FILE_TYPE.IMAGE:
    fsel.accept = 'image/*';
    break;
  case _VIA_FILE_TYPE.VIDEO:
    fsel.accept = 'video/*';
    break;
  case _VIA_FILE_TYPE.AUDIO:
    fsel.accept = 'audio/*';
    break;
  case _VIA_FILE_TYPE.TEXT:
    fsel.accept = '.csv';
    break;
  case _VIA_FILE_TYPE.JSON:
    fsel.accept = '.json';
    break;
  }

  fsel.onchange = handler;
  fsel.click();
}

// see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
function _via_util_rand_int(min_inclusive, max_exclusive) {
  return Math.floor(Math.random() * (max_exclusive - min_inclusive)) + min_inclusive;
}

function _via_util_show_info_page(page_id) {
  var el = document.getElementById('_via_info_page_container');

  var pages = el.getElementsByClassName('info_page');
  var n = pages.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    if ( pages[i].dataset.pageid === page_id ) {
      pages[i].style.display = 'inline-block';
      el.style.display = 'block';
      el.addEventListener('mousedown', _via_util_hide_info_page);
    } else {
      pages[i].style.display = 'none';
    }
  }
}

function _via_util_hide_info_page() {
  var el = document.getElementById('_via_info_page_container');
  if ( el.style.display === 'block' ) {
    el.removeEventListener('mousedown', _via_util_hide_info_page);
    el.style.display = 'none';
  }
}

function _via_util_msg_show(msg, sticky) {
  var container = document.getElementById('_via_message_container');
  var content = document.getElementById('_via_message');
  if ( container && content ) {
    if ( _via_msg_clear_timer ) {
      clearTimeout(_via_msg_clear_timer);
    }
    if ( typeof(sticky) === 'undefined' ||
         sticky === false
       ) {
      _via_msg_clear_timer = setTimeout( function() {
        document.getElementById('_via_message_container').style.display = 'none';
      }, _VIA_CONFIG.MSG_TIMEOUT);
    }

    content.innerHTML = msg;
    container.style.display = 'block';
  }
}

function _via_util_msg_hide() {
  document.getElementById('_via_message_container').style.display = 'none';
  if ( _via_msg_clear_timer ) {
    clearTimeout(_via_msg_clear_timer);
  }
}

function _via_util_pad10(x) {
  if ( x < 10 ) {
    return '0' + x.toString();
  } else {
    return x;
  }
}

function _via_util_date_to_filename_str(date_str) {
  var t = new Date(date_str);
  var month_list = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var ts
  return _via_util_pad10(t.getDate()) + month_list[t.getMonth()] + t.getFullYear() + '_at_' + _via_util_pad10(t.getHours()) + 'h' + _via_util_pad10(t.getMinutes()) + 'm' + _via_util_pad10(t.getSeconds())+'s';
}

function _via_util_remote_get(uri) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function() {
      ok_callback(xhr.responseText);
    });
    xhr.addEventListener('error', function(e) {
      err_callback(e)
    });
    xhr.open('GET', uri);
    xhr.send();
  });
}

function _via_util_float_arr_to_fixed(arr, fixed) {
  for ( var i in arr ) {
    arr[i] = parseFloat( arr[i].toFixed(fixed) );
  }
  return arr;
}

function _via_util_float_to_fixed(value, fixed) {
  return parseFloat( value.toFixed(fixed) );
}
</script>
<!-- End of file: js/_via_util.js-->
<!-- Start of file: js/_via_const.js-->
<script>
'use strict'

// definition of contants that are used by all modules
const _VIA_USER_ROLE = { 'ADMIN':1, 'ANNOTATOR':2, 'REVIEWER':3 };
const _VIA_STORE_TYPE = { 'LOCALSTORAGE':1, 'COUCHDB':2 };

var _VIA_SVG_NS = "http://www.w3.org/2000/svg";
</script>
<!-- End of file: js/_via_const.js-->
<!-- Start of file: js/_via_config.js-->
<script>
'use strict'

const _VIA_CONFIG = { MSG_TIMEOUT:1500 };

</script>
<!-- End of file: js/_via_config.js-->

<!-- Start of file: js/_via_event.js-->
<script>
/**
 * @class
 * @classdesc Implements a basic event emitter and event listener
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 15 Jan. 2019
 */

'use strict';

function _via_event() {
  this.on_event       = _via_event.prototype.on_event;
  this.emit_event     = _via_event.prototype.emit_event;
  this.disable_events = _via_event.prototype.disable;
  this.enable_events  = _via_event.prototype.enable;
  this.clear_events   = _via_event.prototype.clear;

  this._event = { 'enabled':true, 'targets':{} };
  if ( typeof(this._EVENT_ID_PREFIX) === 'undefined' ) {
    this._EVENT_ID_PREFIX = '';
  }
}

_via_event.prototype.on_event = function(event_id_suffix, listener_method, listener_param) {
  // initialise event handlers data structure (if not exist)
  var event_id = this.EVENT_ID_PREFIX + event_id_suffix;
  if ( typeof(this._event.targets[event_id]) === 'undefined' ) {
    this._event.targets[event_id] = { 'listener_list':[], 'listener_param_list':[] };
  }

  this._event.targets[event_id].listener_list.push( listener_method );
  if ( typeof(listener_param) === 'undefined' ) {
    this._event.targets[event_id].listener_param_list.push( {} );
  } else {
    this._event.targets[event_id].listener_param_list.push( listener_param );
  }
}

_via_event.prototype.emit_event = function(event_id_suffix, event_payload) {
  if ( this._event.enabled ) {
    var event_id = this.EVENT_ID_PREFIX + event_id_suffix;
    if ( typeof(this._event.targets[event_id]) !== 'undefined' ) {
      var i;
      for ( i = 0; i < this._event.targets[event_id].listener_list.length; ++i ) {
        this._event.targets[event_id].listener_list[i].call(this, this._event.targets[event_id].listener_param_list[i], event_payload);
      }
    }
  }
}

_via_event.prototype.disable = function() {
  this._event.enabled = false;
}

_via_event.prototype.enable = function() {
  this._event.enabled = true;
}

_via_event.prototype.clear = function() {
  this._event.targets = {};
}
</script>
<!-- End of file: js/_via_event.js-->
<!-- Start of file: js/_via_metadata.js-->
<script>
/**
 *
 * @class
 * @classdesc Metadata
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 * @param {Array} z an array of temporal locations (e.g. time, frame index, etc.)
 * @param {Array} xy an array consisting of type and extent of spatial region (e.g. [1, 10, 10, 50, 50] denotes a 50x50 rectangle at (10,10)
 * @param {Object} metadata an associative array mapping attribute-id to its value
 */

'use strict';

const _VIA_SHAPE  = { 'RECT':1, 'CIRCLE':2, 'ELLIPSE':3, 'POINT':4, 'POLYLINE':5, 'POLYGON':6, 'FILE':7 };

function _via_metadata(z, xy, v) {
  this.z  = z;  // time or frame index
  this.xy = xy; // [shape_id, shape_coordinates, ...]
  this.v  = v;  // attribute-value pair e.g. {attribute_id : attribute_value, ...}
}

</script>
<!-- End of file: js/_via_metadata.js-->
<!-- Start of file: js/_via_file.js-->
<script>
/**
 *
 * @class
 * @classdesc Implementation of manual annotator for image, video and audio
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 23 Dec. 2018
 *
 * @param {number} fid a globally unique identifier
 * @param {string} filename filename
 * @param {number} type the file type as defined by _VIA_FILE_TYPE in file _via_const.js
 * @param {string} loc location of file as defined by _VIA_FILE_LOC in file _via_const.js
 * @param {string} src URI of the file or base64 data
 */

'use strict'

const _VIA_FILE_TYPE = { IMAGE:1, VIDEO:2, AUDIO:3, TEXT:4, JSON:5 };
const _VIA_FILE_LOC  = { LOCAL:1, URIHTTP:2, URIFILE:3, INLINE:4 };

function _via_file(fid, filename, type, loc, src) {
  this.fid      = fid;
  this.filename = filename;
  this.type     = type;
  this.loc      = loc;
  this.src      = src;
}

</script>
<!-- End of file: js/_via_file.js-->
<!-- Start of file: js/_via_attribute.js-->
<script>
/**
 *
 * @class
 * @classdesc Attribute
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 */

'use strict'

//const _VIA_ATTRIBUTE_TYPE = { 'TEXT':1, 'CHECKBOX':2, 'RADIO':3, 'SELECT':4, 'IMAGE':5 };
const _VIA_ATTRIBUTE_TYPE = { 'TEXT':1, 'SELECT':4 };

function _via_attribute(id, name, type, options, default_option_id) {
  this.id = id;
  this.aname = name;
  this.type = type;
  this.options = options;
  this.default_option_id = default_option_id;
}

_via_attribute.prototype.option_add = function(option_id, option_value, is_default=false) {
  this.options[option_id] = option_value;
  if ( is_default ) {
    this.default_option_id = option_id;
  }
}

_via_attribute.prototype.options_to_csv = function() {
  var csv = [];
  var oid;
  for ( oid in this.options ) {
    if ( oid === this.default_option_id ) {
      csv.push( '*' + this.options[oid] );
    } else {
      csv.push( this.options[oid] );
    }
  }
  return csv.join(',');
}

_via_attribute.prototype.html_element = function() {
  switch(this.type) {
  case _VIA_ATTRIBUTE_TYPE.TEXT:
    var el = document.createElement('textarea');
    return el;
    break;

  case _VIA_ATTRIBUTE_TYPE.SELECT:
    var el = document.createElement('select');
    var oid;
    for ( oid in this.options ) {
      var oi = document.createElement('option');
      oi.setAttribute('value', oid);
      oi.innerHTML = this.options[oid];
      if ( oid == this.default_option_id ) {
        oi.setAttribute('selected', '');
      }
      el.appendChild(oi);
    }
    return el;
    break;
  }
}

</script>
<!-- End of file: js/_via_attribute.js-->
<!-- Start of file: js/_via_data.js-->
<script>
/**
 *
 * @class
 * @classdesc Manages the storage and update of all data (annotations, files, etc. )
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 */

'use strict';

function _via_data() {
  this.project_store = {
    'project_id':this._uuid(),
    'project_name':'Default Project',
    'data_format_version':'3.0.0',
    'creator': 'VGG Image Annotator (http://www.robots.ox.ac.uk/~vgg/software/via)',
    'created': new Date().toString(),
    'update_history': [],
  };

  // metadata
  this.metadata_store = {};

  // attributes
  this.attribute_store = {};
  this.aid_list = [];        // to maintain ordering of attributes

  // files
  this.file_store = {};
  this.fid_list = [];        // to maintain ordering of files
  this.file_mid_store = {};   // list of all metadata associated with a file

  // data persistence
  this._store_list = {};

  // metadata_store is treated differently
  this.data_key_list = ['project_store',
                        'attribute_store',
                        'aid_list',
                        'file_store',
                        'file_mid_store',
                        'fid_list',
                       ];

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this._EVENT_ID_PREFIX = '_via_data_';
  _via_event.call(this);
}

_via_data.prototype._init = function() {
}

_via_data.prototype._hook_on_data_update = function() {
  //@todo
}

//
// data persistence
//
_via_data.prototype._store_add = function(id, store) {
  this._store_list[id] = store;
}

_via_data.prototype._store_del = function(store_id) {
  delete this._store_list[id];
}

_via_data.prototype._store_transaction = function(data_key, action, param) {
  var promise_list = [];
  var store_id;
  for ( store_id in this._store_list ) {
    promise_list.push( this._store_list[store_id].transaction(data_key, action, param) );
  }

  Promise.all(promise_list).then( function(ok) {
    //console.log('store transaction: {' + data_key + ',' + action + ', ' + JSON.stringify(param) + '} completed');
  }.bind(this), function(err) {
    console.warn('store transaction {' + data_key + ',' + action + ', ' + JSON.stringify(param) + '} failed');
  }.bind(this));
}


//
// attribute
//
_via_data.prototype._attribute_get_new_id = function() {
  var aid;
  if ( this.aid_list.length ) {
    aid = parseInt(this.aid_list[this.aid_list.length - 1]) + 1;
  } else {
    aid = 0;
  }
  return aid;
}

_via_data.prototype.attribute_is_present = function(name) {
  var aid;
  for ( aid in this.attribute_store ) {
    if ( this.attribute_store[aid].name === name ) {
      return true;
    }
  }
  return false;
}

_via_data.prototype.attribute_add = function(name, type, options, default_option_id) {
  return new Promise( function(ok_callback, err_callback) {
    if ( this.attribute_is_present(name) ) {
      err_callback('attribute already exists');
      return;
    }

    var aid = this._attribute_get_new_id();
    this.attribute_store[aid] = new _via_attribute(aid,
                                                   name,
                                                   type,
                                                   options,
                                                   default_option_id);
    this.aid_list.push(aid);
    this._store_transaction('attribute_store', 'add', {'aid':aid});
    this._hook_on_data_update();
    this.emit_event( 'attribute_add', { 'aid':aid } );
    ok_callback(aid);
  }.bind(this));
}

_via_data.prototype.attribute_del = function(aid) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.attribute_store.hasOwnProperty(aid) ) {
      err_callback('invalid aid=' + aid);
      return;
    }

    delete this.attribute_store[aid];
    var aindex = this.aid_list.indexOf( parseInt(aid) );
    this.aid_list.splice(aindex, 1);

    // @todo: delete all metadata containing this attribute
    var fid, mid;
    for ( fid in this.metadata_store ) {
      for ( mid in this.metadata_store[fid] ) {
        if ( this.metadata_store[fid][mid].what[aid] !== 'undefined' ) {
          delete this.metadata_store[fid][mid].what[aid];
        }
      }
    }
    this._store_transaction('attribute_store', 'del', {'aid':aid});
    this._hook_on_data_update();
    this.emit_event( 'attribute_del', { 'aid':aid } );
  }.bind(this));
}

_via_data.prototype.attribute_update_options = function(aid, csv_str) {
  var csv = csv_str.split(',');
  var n = csv.length;
  var i;
  this.attribute_store[aid].options = {};
  for ( i = 0; i < n; ++i ) {
    if ( csv[i].startsWith('*') ) {
      this.attribute_store[aid].default_option_id = i.toString();
      this.attribute_store[aid].options[i] = csv[i].substr(1);
    } else {
      this.attribute_store[aid].options[i] = csv[i];
    }
  }
  this._store_transaction('attribute_store', 'update', {'aid':aid});
  this._hook_on_data_update();
  this.emit_event( 'attribute_update', { 'aid':aid } );
}

_via_data.prototype.attribute_update_type = function(aid, new_type) {
  this.attribute_store[aid].type = parseInt(new_type);
  this._store_transaction('attribute_store', 'update', {'aid':aid});
  this._hook_on_data_update();
  this.emit_event( 'attribute_update', { 'aid':aid } );
}

//
// file
//
_via_data.prototype._file_get_new_id = function() {
  var fid;
  if ( this.fid_list.length ) {
    fid = parseInt(this.fid_list[this.fid_list.length - 1]) + 1;
  } else {
    fid = 0;
  }
  return fid;
}

_via_data.prototype.file_add = function(name, type, loc, src) {
  var fid = this._file_get_new_id();
  this.file_store[fid] = new _via_file(fid, name, type, loc, src);
  this.fid_list.push(fid);
  this._store_transaction('file_store', 'add', {'fid':fid});
  this._hook_on_data_update();
  this.emit_event( 'file_add', { 'fid':fid } );
  return fid;
}

_via_data.prototype.file_add_bulk = function(filelist) {
  return new Promise( function(ok_callback, err_callback) {
    var n = filelist.length;
    var added_fid_list = [];
    var i, fid;
    for ( i = 0; i < n; ++i ) {
      fid = this._file_get_new_id();
      this.file_store[fid] = new _via_file(fid,
                                           filelist[i].filename,
                                           filelist[i].type,
                                           filelist[i].loc,
                                           filelist[i].src
                                          );
      this.fid_list.push(fid);
      added_fid_list.push(fid);
    }
    this._store_transaction('file_store', 'add_bulk', {'fid_list':added_fid_list});
    this._hook_on_data_update();
    this.emit_event( 'file_add_bulk', { 'fid_list':added_fid_list } );
    ok_callback(added_fid_list);
  }.bind(this));
}

_via_data.prototype.file_remove = function(fid) {
  if ( this.has_file(fid) ) {
    // delete all metadata associated with fid
    var mid, mid_index;
    for ( mid_index in this.file_mid_store[fid] ) {
      mid = this.file_mid_store[fid][mid_index]
      delete this.metadata_store[mid];
    }
    delete this.file_mid_store[fid];

    // delete file entry
    delete this.file_store[fid];
    var findex = this.fid_list.indexOf(fid);
    this.fid_list.splice(findex, 1);
    this._store_transaction('file_store', 'remove', {'fid':fid});
    this._hook_on_data_update();
    this.emit_event( 'file_remove', { 'fid':fid } );
  }
}

_via_data.prototype.file_is_fid_valid = function(fid) {
  if ( this.file_store.hasOwnProperty(fid) ) {
    return true;
  } else {
    return false;
  }
}

_via_data.prototype.file_src2fid = function(src) {
  var fid;
  for ( fid in this.file_store ) {
    if ( this.file_store[fid].src === src ) {
      return fid;
    }
  }
  return '-1';
}

_via_data.prototype.fid2file = function(fid) {
  return this.file_store[fid];
}

//
// Metadata
//

// metadata_list = { 'mid', 'z', 'xy', 'metadata' }
_via_data.prototype.metadata_add_bulk = function(metadata_list) {
  return new Promise( function(ok_callback, err_callback) {
    var n = metadata_list.length;
    var added_mid_list = {};
    var fid, mid;
    var i;
    for ( i = 0; i < n; ++i ) {
      fid = metadata_list[i].fid;

      if ( ! this.file_store.hasOwnProperty(fid) ) {
        err_callback('fid=' + fid + ' does not exist!');
        return;
      }

      mid = this._uuid();
      this.metadata_store[mid] = new _via_metadata(metadata_list[i].z,
                                                   metadata_list[i].xy,
                                                   metadata_list[i].v
                                                  );
      if ( typeof(this.file_mid_store[fid]) === 'undefined' ) {
        this.file_mid_store[fid] = [];
      }
      this.file_mid_store[fid].push(mid);

      if ( typeof(added_mid_list[fid]) === 'undefined' ) {
        added_mid_list[fid] = [];
      }
      added_mid_list[fid].push(mid);
      this._store_transaction('metadata_store', 'add', {'fid':fid, 'mid':mid});
    }

    this._hook_on_data_update();
    this.emit_event( 'metadata_add_bulk', { 'added_mid_list':added_mid_list } );
    ok_callback({'added_mid_list':added_mid_list});
  }.bind(this));
}

_via_data.prototype.metadata_add = function(fid, z, xy, metadata) {
  return new Promise( function(ok_callback, err_callback) {
    if ( typeof(this.file_store[fid]) === 'undefined' ) {
      err_callback({'fid':fid});
      return;
    }

    var mid = this._uuid();
    this.metadata_store[mid] = new _via_metadata(z, xy, metadata);
    if ( typeof(this.file_mid_store[fid]) === 'undefined' ) {
      this.file_mid_store[fid] = [];
    }
    this.file_mid_store[fid].push(mid);
    this._store_transaction('metadata_store', 'add', {'fid':fid, 'mid':mid});
    this._hook_on_data_update();
    this.emit_event( 'metadata_add', { 'fid':fid, 'mid':mid } );
    ok_callback({'fid':fid, 'mid':mid});
  }.bind(this));
}

_via_data.prototype.metadata_update = function(fid, mid, z, xy, metadata) {
  return new Promise( function(ok_callback, err_callback) {
    if ( typeof(this.file_store[fid]) === 'undefined' ) {
      err_callback('undefined fid=' + fid);
      return;
    }

    if ( typeof(this.metadata_store[mid]) === 'undefined' ) {
      err_callback('undefined mid=' + mid);
    }

    this.metadata_store[mid] = new _via_metadata(z, xy, metadata);
    this._store_transaction('metadata_store', 'update', {'fid':fid, 'mid':mid});
    this._hook_on_data_update();
    this.emit_event( 'metadata_update', { 'fid':fid, 'mid':mid } );
    ok_callback({'fid':fid, 'mid':mid});
  }.bind(this));
}

_via_data.prototype.metadata_update_zi = function(fid, mid, zindex, zvalue) {
  return new Promise( function(ok_callback, err_callback) {
    if ( typeof(this.file_store[fid]) === 'undefined' ) {
      err_callback('undefined fid=' + fid);
      return;
    }

    if ( typeof(this.metadata_store[mid]) === 'undefined' ) {
      err_callback('undefined mid=' + mid);
    }

    this.metadata_store[mid].z[zindex] = zvalue;
    this._store_transaction('metadata_store', 'update', {'fid':fid, 'mid':mid});
    this._hook_on_data_update();
    this.emit_event( 'metadata_update', { 'fid':fid, 'mid':mid } );
    ok_callback({'fid':fid, 'mid':mid});
  }.bind(this));
}

_via_data.prototype.metadata_update_z = function(fid, mid, z) {
  return new Promise( function(ok_callback, err_callback) {
    if ( typeof(this.file_store[fid]) === 'undefined' ) {
      err_callback('undefined fid=' + fid);
      return;
    }

    if ( typeof(this.metadata_store[mid]) === 'undefined' ) {
      err_callback('undefined mid=' + mid);
    }

    this.metadata_store[mid].z = z;
    this._store_transaction('metadata_store', 'update', {'fid':fid, 'mid':mid});
    this._hook_on_data_update();
    this.emit_event( 'metadata_update', { 'fid':fid, 'mid':mid } );
    ok_callback({'fid':fid, 'mid':mid});
  }.bind(this));
}

_via_data.prototype.metadata_update_attribute_value = function(fid, mid, aid, value) {
  // @todo: add checks
  this.metadata_store[mid].metadata[aid] = value;
  this._store_transaction('metadata_store', 'update', {'fid':fid, 'mid':mid});
  this._hook_on_data_update();
  this.emit_event( 'metadata_update', { 'fid':fid, 'mid':mid } );
}

_via_data.prototype.metadata_update_attribute_value_bulk = function(fid, value_list) {
  var mid_list = [];
  var i;
  for ( i in value_list ) {
    this.metadata_store[ value_list[i].mid ].metadata[ value_list[i].aid ] = value_list[i].value;
    this._store_transaction('metadata_store', 'update', {'fid':fid, 'mid':value_list[i].mid});
    mid_list.push(value_list[i].mid);
  }
  this._hook_on_data_update();
  this.emit_event( 'metadata_update_bulk', { 'fid':fid, 'mid_list':mid_list } );
}

_via_data.prototype.metadata_del = function(fid, mid) {
  return new Promise( function(ok_callback, err_callback) {
    if ( typeof(this.file_store[fid]) === 'undefined' ) {
      err_callback('invalid fid=' + fid);
      return;
    }

    if ( typeof(this.metadata_store[mid]) === 'undefined' ) {
      err_callback('invalid mid=' + mid);
    }
    delete this.metadata_store[mid];

    var mid_index = this.file_mid_store[fid].indexOf(mid);
    this.file_mid_store[fid].splice(mid_index, 1);
    this._store_transaction('metadata_store', 'del', {'fid':fid, 'mid':mid});
    this._hook_on_data_update();
    this.emit_event( 'metadata_del', { 'fid':fid, 'mid':mid } );
    ok_callback({'fid':fid, 'mid':mid});
  }.bind(this));
}

_via_data.prototype.metadata_del_bulk = function(fid, mid_list, emit) {
  return new Promise( function(ok_callback, err_callback) {
    if ( typeof(this.file_store[fid]) === 'undefined' ) {
      err_callback('invalid fid=' + fid);
      return;
    }
    var mindex, mid, findex;
    for ( mindex in mid_list ) {
      mid = mid_list[mindex];
      delete this.metadata_store[mid];
      findex = this.file_mid_store[fid].indexOf(mid);
      if ( findex !== -1 ) {
        this.file_mid_store[fid].splice(findex, 1);
      }
      this._store_transaction('metadata_store', 'del', {'fid':fid, 'mid':mid});
    }
    this._hook_on_data_update();
    if ( typeof(emit) !== 'undefined' && emit === true ) {
      this.emit_event( 'metadata_del_bulk', { 'fid':fid, 'mid_list':mid_list } );
    }

    ok_callback({'fid':fid, 'mid':mid});
  }.bind(this));
}

//
// Project
//
_via_data.prototype._project_load_json = function(e) {
  _via_util_load_text_file(e.target.files[0], this._project_import_from_json.bind(this));
}

_via_data.prototype._project_import_from_json = function(json_str) {
  if ( json_str === '' || typeof(json_str) === 'undefined') {
    console.log('_via_data._project_import_from_json() failed as json_str=' + json_str);
    return;
  }

  var data = JSON.parse(json_str);
  this._project_load(data);
}

_via_data.prototype._project_load = function(data) {
  // clear everything
  this.project_store = {};
  this.metadata_store = {};
  this.attribute_store = {};
  this.aid_list = [];        // to maintain ordering of attributes
  this.file_store = {};
  this.fid_list = [];        // to maintain ordering of files
  this.file_mid_store = {};   // list of all metadata associated with a file

  // project
  this.project_store = data.project_store;

  // add all files
  var fid;
  for ( fid in data.file_store ) {
    this.file_store[fid] = new _via_file(fid,
                                         data.file_store[fid].filename,
                                         data.file_store[fid].type,
                                         data.file_store[fid].loc,
                                         data.file_store[fid].src
                                        );
  }

  // copy list of file id (fid)
  var findex;
  for ( findex in data.fid_list ) {
    this.fid_list[findex] = data.fid_list[findex].toString(); // fid is always string
  }

  // copy map of mid associated with each fid
  this.file_mid_store = data.file_mid_store;

  // add all attributes
  var aid;
  for ( aid in data.attribute_store ) {
    this.attribute_store[aid] = new _via_attribute(aid,
                                                   data.attribute_store[aid].aname,
                                                   data.attribute_store[aid].type,
                                                   data.attribute_store[aid].options,
                                                   data.attribute_store[aid].default_option_id
                                                  );
  }

  // copy list of attribute id (aid)
  var aindex;
  for ( aindex in data.aid_list ) {
    this.aid_list[aindex] = data.aid_list[aindex].toString(); // aid is always string
  }

  // add all metadata
  var mid;
  for ( mid in data.metadata_store ) {
    this.metadata_store[mid] = new _via_metadata(data.metadata_store[mid].z,
                                                 data.metadata_store[mid].xy,
                                                 data.metadata_store[mid].v
                                                );
  }

  if ( data.hasOwnProperty('_id') && data.hasOwnProperty('_rev') ) {
    this.couchdb_id = data['_id'];
    this.couchdb_rev = data['_rev'];
  }

  // initialise all the stores
  var store_id;
  for ( store_id in this._store_list ) {
    this._store_list[store_id]._init();
  }

  _via_util_msg_show('Loaded project [' + this.project_store['project_name'] + ']');
  this.emit_event( 'project_load', {}  );
}

_via_data.prototype._project_pack_data = function() {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var data = {
        'project_store':this.project_store,
        'metadata_store':this.metadata_store,
        'attribute_store':this.attribute_store,
        'aid_list':this.aid_list,
        'file_store':this.file_store,
        'fid_list':this.fid_list,
        'file_mid_store':this.file_mid_store,
      };

      var data_str = JSON.stringify(data);
      var filename = data.project_store.project_name;
      ok_callback({'project_id':data.project_store.project_id,
                   'project_name':data.project_store.project_name,
                   'data_str':data_str
                  });
    } catch(err) {
      _via_util_msg_show('Failed to convert project data to JSON', true);
      console.log(err)
    }
  }.bind(this));
}

_via_data.prototype.save_local = function() {
  this._project_pack_data().then( function(payload) {
    var blob = new Blob( [payload.data_str], {type:'text/json;charset=utf-8'} );
    var filename = payload.project_name + '.json';
    _via_util_download_as_file(blob, filename);
  }.bind(this), function(err) {
    console.log(err)
  }.bind(this));
}

// temporary method for voxceleb data annotation - Abhishek (20 Mar. 2019)
_via_data.prototype.save_remote = function(username) {
  if ( ! this.couchdb_id || ! this.couchdb_rev ) {
    _via_util_msg_show('Upload feature not available!', true);
    return;
  }

  var username = document.getElementById('remote_push_username').value;
  username = username.trim();
  if ( username === '' ) {
    _via_util_msg_show('To upload, you must enter your username!', true);
    return;
  }
  var constraint = new RegExp("^([a-z0-9]{5,})$");
  if ( ! constraint.test(username) ) {
    _via_util_msg_show('Username must be 5 characters long and cannot contain spaces or special characters.', true);
    return;
  }

  var commit_msg = [];
  commit_msg.push(username);
  if ( window.localStorage ) {
    var browser_id = window.localStorage.getItem('_VIA_BROWSER_ID');
    if ( browser_id === null ) {
      browser_id = this._uuid();
      window.localStorage.setItem('_VIA_BROWSER_ID', browser_id);
    }
    commit_msg.push(browser_id);
  } else {
    commit_msg.push('unknown');
  }
  commit_msg.push( new Date().toJSON() );
  commit_msg.push(this.couchdb_rev);

  this.project_store['update_history'].push( commit_msg.join(',') );

  var data = {
    'project_store':this.project_store,
    'metadata_store':this.metadata_store,
    'attribute_store':this.attribute_store,
    'aid_list':this.aid_list,
    'file_store':this.file_store,
    'fid_list':this.fid_list,
    'file_mid_store':this.file_mid_store,
  };

  var uri = _VIA_PROJECT_DS_URI + this.couchdb_id + '?rev=' + this.couchdb_rev;
  var xhr = new XMLHttpRequest();
  xhr.open('PUT', uri);
  xhr.addEventListener('error', function(e) {
    _via_util_msg_show('Failed to upload!', true);
  }.bind(this));
  xhr.addEventListener('abort', function(e) {
    _via_util_msg_show('Upload aborted!', true);
    err_callback(false);
  }.bind(this));
  xhr.addEventListener('load', function(e) {
    switch(xhr.statusText) {
    case 'Created':
    case 'Accepted':
      try {
        var response = JSON.parse(xhr.responseText);
        if ( response.ok ) {
          this.couchdb_rev = response.rev;
          this.couchdb_id = response.id;
          var revision = this.couchdb_rev.split('-')[0];
          _via_util_msg_show('Upload successful (revision = ' + revision + ')', true);
        } else {
          _via_util_msg_show('Upload failed. Please report this: ' + xhr.responseText + ')', true);
        }
      }
      catch(e) {
        _via_util_msg_show('Malformed server response. Please report this: ' + xhr.responseText, true);
      }
      break;
    default:
      _via_util_msg_show('Upload failed with response [' + xhr.statusText + ':' + xhr.responseText + ']', true);
      break;
    }
  }.bind(this));
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.setRequestHeader('Accept', 'application/json');
  xhr.send( JSON.stringify(data) );
}

_via_data.prototype.load_local = function() {
  _via_util_file_select_local(_VIA_FILE_TYPE.JSON, this._project_load_json.bind(this), false);
}

_via_data.prototype.on_event_file_show = function() {

}

//
// Unique Id
//

// URL.createObjectURL() produces a unique id every time it is invoked.
// We use this functionality to generate unique id required by VIA
// @todo: Replace with a true UUID generator if it can be efficiently generated
// using pure JS (no dependencies)
_via_data.prototype._uuid = function() {
  var temp_url = URL.createObjectURL(new Blob())
  var uuid = temp_url.toString();
  URL.revokeObjectURL(temp_url);
  var slash_index = uuid.lastIndexOf('/');
  if ( uuid !== -1 ) {
    // remove any prefix (e.g. blob:null/, blob:www.test.com/, ...)
    uuid = uuid.substr(slash_index + 1);
    uuid = uuid.replace(/-/g, '');
  }
  return uuid;
}
</script>
<!-- End of file: js/_via_data.js-->

<!-- Start of file: js/_via_store_localstorage.js-->
<script>
/**
 *
 * @class
 * @classdesc Provided persistence of data using browser's localStorage
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 27 Feb. 2019
 *
 */

'use strict';

function _via_store_localstorage(data) {
  this.d = data;

  this.store = window.localStorage;
  this.store_available = false;

  this.prev_session_available = false;
  this.prev_session_data = {};
  this.prev_session_timestamp = '';
  this.prev_session_timestamp_str = '';

  this.BROWSER_ID_KEY = '_via_browser_id';
  this.BROWSER_ID_VALUE = '';
  this.event_prefix = '_via_store_localstorage_';
  _via_event.call( this );
}

_via_store_localstorage.prototype._init = function() {
  if ( this.is_store_available() ) {
    this.BROWSER_ID_VALUE = this.store.getItem(this.BROWSER_ID_KEY);
    this.store.clear();
    this.store_available = true;
    if ( this.BROWSER_ID_VALUE === null ) {
      this.BROWSER_ID_VALUE = this.d._uuid();
    }
    this.store.setItem(this.BROWSER_ID_KEY, this.BROWSER_ID_VALUE);
    this._push_all();
    return true;
  } else {
    return false;
  }
}

_via_store_localstorage.prototype.prev_session_data_init = function() {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var existing_project_store_str = this.store.getItem('_via_project_store');
      if ( existing_project_store_str !== null ) {
        // save a copy of previous session's data
        this._pack_store_data().then( function(ok) {
          this.prev_session_data = ok;
          this.prev_session_data_blob = new Blob( [ JSON.stringify(this.prev_session_data) ],
                                                  {type:'text/json;charset=utf-8'} );

          this.prev_session_timestamp_str = _via_util_date_to_filename_str(this.prev_session_data.project_store.created);
          this.prev_session_timestamp = new Date(this.prev_session_data.project_store.created);
          this.prev_session_available = true;
          ok_callback();
        }.bind(this), function(err) {
          err_callback();
        }.bind(this))
      } else {
        console.log('_via_store_localstorage.prev_session_data_init() failed');
        err_callback();
      }
    }
    catch(ex) {
      console.log('exception in _via_store_localstorage.prev_session_data_init()');
      console.log(ex)
      err_callback(ex);
    }
  }.bind(this));
}

_via_store_localstorage.prototype.prev_session_is_available = function() {
  return this.prev_session_available;
}

_via_store_localstorage.prototype.prev_session_get_size = function() {
  return this.prev_session_data_blob.size;
}

_via_store_localstorage.prototype.prev_session_get_timestamp = function() {
  return this.prev_session_timestamp.toString();
}

_via_store_localstorage.prototype.prev_session_load = function() {
  if ( this.prev_session_available ) {
    this.d._project_load(this.prev_session_data);
  }
}

_via_store_localstorage.prototype.prev_session_save = function() {
  if ( this.prev_session_available ) {
    _via_util_download_as_file(this.prev_session_data_blob,
                               'via_project_' +
                               this.prev_session_timestamp_str + '.json');
  }
}

_via_store_localstorage.prototype._push_all = function() {
  var data_key, store_key;
  var data_key_index;
  for( data_key_index in this.d.data_key_list ) {
    data_key = this.d.data_key_list[data_key_index];
    this._push_data(data_key);
  }
  this._push_metadata();
}

_via_store_localstorage.prototype._push_data = function(data_key) {
  var store_key = this._datakey_to_storekey(data_key);
  this.store.setItem(store_key, JSON.stringify(this.d[data_key]));
}

_via_store_localstorage.prototype._push_metadata = function() {
  var mid, mid_storekey;
  for ( mid in this.d.metadata_store ) {
    mid_storekey = this._datakey_to_storekey(mid);
    this.store.setItem(mid_storekey, JSON.stringify(this.d.metadata_store[mid]));
  }
}

_via_store_localstorage.prototype._storekey_to_datakey = function(store_key) {
  if ( store_key.startsWith('_via_') ) {
    return store_key.substring( '_via_'.length ); // remove prefix '_via_'
  } else {
    return store_key;
  }
}

_via_store_localstorage.prototype._datakey_to_storekey = function(data_key) {
  return '_via_' + data_key;
}


_via_store_localstorage.prototype._pack_store_data = function() {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var data = { 'metadata_store':{} };
      var store_items = Object.keys(this.store);
      var store_key, store_key_index, data_key;

      for ( store_key_index in store_items ) {
        store_key = store_items[store_key_index];
        data_key = this._storekey_to_datakey(store_key);
        if ( this.d.data_key_list.includes(data_key) ) {
          data[data_key] = JSON.parse( this.store.getItem(store_key) );
        } else {
          try {
            var metadata_str = this.store.getItem(store_key);
            var metadata = JSON.parse(metadata_str);
            if ( typeof(metadata.z)  !== 'undefined' &&
                 typeof(metadata.xy) !== 'undefined' &&
                 typeof(metadata.v)  !== 'undefined'
               ) {
              data['metadata_store'][data_key] = metadata;
            } else {
              console.log('malformed metadata : [' + metadata_str + ']');
            }
          } catch(e) {
            if ( store_key !== this.BROWSER_ID_KEY ) {
              console.log('Failed to parse data for store_key=[' + store_key + '], data_key=[' + data_key + ']');
              console.log(this.store.getItem(store_key));
            }
          }
        }
      }

      ok_callback(data);
    }
    catch(e) {
      err_callback();
    }
  }.bind(this));
}

//
// Public methods
//

// source: https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
_via_store_localstorage.prototype.is_store_available = function() {
  try {
    var storage = window['localStorage'],
        x = '__storage_test__';
    storage.setItem(x, x);
    storage.removeItem(x);
    return true;
  }
  catch(e) {
    return e instanceof DOMException && (
      // everything except Firefox
      e.code === 22 ||
        // Firefox
      e.code === 1014 ||
        // test name field too, because code might not be present
      // everything except Firefox
      e.name === 'QuotaExceededError' ||
        // Firefox
      e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
      // acknowledge QuotaExceededError only if there's something already stored
    storage.length !== 0;
  }
}

//
// public interface
//
_via_store_localstorage.prototype.transaction = function(data_key, action, param) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store_available ) {
      err_callback('store not available');
      return;
    }
    try {
      switch(data_key) {
      case 'metadata_store':
        var fid = param.fid;
        var mid = param.mid;
        var mid_store_key = this._datakey_to_storekey(mid);
        switch(action) {
        case 'add':
          this.store.setItem(mid_store_key, JSON.stringify(this.d.metadata_store[mid]));
          this._push_data('file_mid_store');
          break;
        case 'del':
          this.store.removeItem(mid_store_key);
          this._push_data('file_mid_store');
          break;
        case 'update':
          this.store.setItem(mid_store_key, JSON.stringify(this.d.metadata_store[mid]));
          break;
        }
        ok_callback();
        break;
      case 'attribute_store':
        this._push_data('attribute_store');
        this._push_data('aid_list');
        ok_callback();
        break;
      case 'file_store':
        this._push_data('file_store');
        this._push_data('fid_list');
        ok_callback();
        break;
      default:
        err_callback('unknown data_key=' + data_key);
      }
    } catch(e) {
      err_callback(e);
    }

  }.bind(this));
}

//
// Self Test
//
_via_store_localstorage.prototype._self_test = function() {
  var fid1 = this.d.file_add('test123.jpg', _VIA_FILE_TYPE.IMAGE, _VIA_FILE_LOC.LOCAL, '');
  var fid2 = this.d.file_add('testXYZ.jpg', _VIA_FILE_TYPE.IMAGE, _VIA_FILE_LOC.URIHTTP, 'http://somerandurl.com/files/testXYZ.jpg');

  var aid1 = this.d.attribute_add('attribute1', _VIA_ATTRIBUTE_TYPE.TEXT);
  var aid2 = this.d.attribute_add('attribute2', _VIA_ATTRIBUTE_TYPE.TEXT);
  this.d.metadata_add( fid1, [], [ _VIA_SHAPE.RECT, 10, 20, 50, 100 ], { aid1:'value1', aid2:'value2'}).then( function(ok) {
    this._pack_store_data().then( function(ok) {
      console.assert( d.file_mid_store[0][0] === Object.keys(d.metadata_store)[0] );
      console.assert( d.fid_list.length === 2 );
      console.assert( d.aid_list.length === 2 );
      console.assert( d.file_store[1].filename === 'testXYZ.jpg' );
      console.assert( d.file_store[0].filename === 'test123.jpg' );
      console.assert( d.attribute_store[0].attr_name === 'attribute1' );
      console.assert( d.attribute_store[1].attr_name === 'attribute2' );
      console.log('_via_store_localstorage : self test done');
    }.bind(this), function(err) {
      console.error('_via_store_localstorage : self test failed');
    }.bind(this));
  }.bind(this), function(err) {
    console.error('failed');
  });
}
</script>
<!-- End of file: js/_via_store_localstorage.js-->

<!-- Start of file: js/_via_io.js-->
<script>
/**
 *
 * @class
 * @classdesc VIA data input/output
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 3 Feb. 2019
 *
 */

'use strict';

function _via_io(data) {
  this.d = data;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this.event_prefix = '_via_io_';
  _via_event.call( this );
}

_via_io.prototype.speaker_diarisation_export_csv = function() {
  var csvd = [];
  csvd.push('file,speaker,tstart,tend');

  var fid, mindex, mid, filename, avalue, t0, t1;
  for ( fid in this.d.file_mid_store ) {
    filename = this.d.file_store[fid].filename;
    for ( mindex in this.d.file_mid_store[fid] ) {
      mid = this.d.file_mid_store[fid][mindex];
      avalue = this.d.metadata_store[mid].v['0'];
      t0 = this.d.metadata_store[mid].z[0];
      t1 = this.d.metadata_store[mid].z[1];
      csvd.push( filename + ',' + avalue + ',' + t0 + ',' + t1);
    }
  }

  var blob = new Blob( [csvd.join('\n')], {type:'text/csv;charset=utf-8'} );
  _via_util_download_as_file(blob, 'via_speaker_diarisation_' + this.d.project_store.project_id + '.csv');
}
</script>
<!-- End of file: js/_via_io.js-->

<!-- Start of file: js/_via_project.js-->
<script>
/**
 *
 * @class
 * @classdesc VIA Project
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 18 Jan. 2019
 *
 */

'use strict';

function _via_project(container, data, annotator) {
  this.c = container;
  this.d = data;
  this.a = annotator;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this.event_prefix = '_via_project_';
  _via_event.call( this );

  // attach event listeners
  this.a.on_event('file_show', this._on_file_show.bind(this));

  this._init();
}

_via_project.prototype._init = function() {
  this.info = document.createElement('table');
  var tbody = document.createElement('tbody');
  this.info.appendChild(tbody);

  var tr_name = document.createElement('tr');
  var td_name_label = document.createElement('td');
  var label = document.createElement('label');
  label.setAttribute('for', 'project_name');
  label.innerHTML = 'Project';
  td_name_label.appendChild(label);

  var td_name_input = document.createElement('td');
  this.input_project_name = document.createElement('input');
  this.input_project_name.setAttribute('name', 'project_name');
  this.input_project_name.setAttribute('type', 'text');
  this.input_project_name.setAttribute('placeholder', 'Enter name of this project');
  td_name_input.appendChild(this.input_project_name);
  tr_name.appendChild(td_name_label);
  tr_name.appendChild(td_name_input);
  tbody.appendChild(tr_name);

  this.filelist = document.createElement('ol');
  this.filelist_container = document.createElement('div');
  this.filelist_container.setAttribute('class', 'filelist_container');
  this.filelist_regex = document.createElement('input');
  this.filelist_regex.setAttribute('placeholder', 'Filter file list');
  this.filelist_regex.addEventListener('input', this.on_filelist_regex.bind(this));

  this.filelist_container.appendChild(this.filelist_regex);
  this.filelist_container.appendChild(this.filelist);

  this.tools = document.createElement('div');
  this.tools.setAttribute('class', 'tools');
  var addbtn1 = document.createElement('button');
  addbtn1.setAttribute('class', 'text_button');
  addbtn1.innerHTML = 'Add URL';
  var addbtn2 = document.createElement('button');
  addbtn2.setAttribute('class', 'text_button');
  addbtn2.innerHTML = 'Add Local';
  var delbtn = document.createElement('button');
  delbtn.setAttribute('class', 'text_button');
  delbtn.innerHTML = 'Delete';
  this.tools.appendChild(addbtn1);
  this.tools.appendChild(addbtn2);
  this.tools.appendChild(delbtn);

  this.project = document.createElement('div');
  this.project.setAttribute('class', 'project');
  this.project.appendChild(this.info);
  //this.project.appendChild(this.filter);
  this.project.appendChild(this.filelist_container);
  this.project.appendChild(this.tools);
  this.c.appendChild(this.project);

  // trigger update of filelist (for the first time)
  this._update_filelist();
}

_via_project.prototype._clear_filelist = function() {
  this.filelist.innerHTML = '';
}

_via_project.prototype._filelist_html_element = function(fid) {
  var li = document.createElement('li');
  li.setAttribute('data-fid', fid);
  li.setAttribute('title', this.d.file_store[fid].uri);
  li.addEventListener('click', this._switch_to_file.bind(this));
  if ( this.d.has_file(fid) ) {
    li.innerHTML = '[' + (fid+1) + '] ' + this.d.file_store[fid].uri;
  }

  if ( typeof(this.a.now.file) !== 'undefined' ) {
    if ( this.a.now.file.id === fid ) {
      li.classList.add('sel');
    }
  }

  return li;
}

_via_project.prototype._update_filelist_regex = function(regex) {
  this._clear_filelist();
  var i, uri;
  for ( i = 0; i < this.d.file_store.length; ++i ) {
    uri = this.d.file_store[i].uri;
    if ( uri.match(regex) !== null ) {
      this.filelist.appendChild( this._filelist_html_element(i) );
    }
  }
}

_via_project.prototype._update_filelist = function() {
  this._clear_filelist();
  this.filelist_regex.value = '';
  var i;
  for ( i = 0; i < this.d.file_store.length; ++i ) {
    this.filelist.appendChild( this._filelist_html_element(i) );
  }
}

_via_project.prototype._switch_to_file = function(el) {
  var fid = el.target.dataset.fid;
  this.a.file_show_fid(fid);
}

_via_project.prototype._on_file_show = function(data, event_payload) {
  /*
  var current_fid = event_payload.id.toString();
  var n = this.filelist.childNodes.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    if ( this.filelist.childNodes[i].dataset.fid === current_fid ) {
      this.filelist.childNodes[i].classList.add('current_file');
      console.log('added to ')
      console.log(this.filelist.childNodes[i])
    } else {
      if ( this.filelist.childNodes[i].classList.contains('current_file') ) {
        this.filelist.childNodes[i].classList.remove('current_file');
      }
    }
  }
  */
  // @todo: recompute is not need when you know the current_fid!
  this._update_filelist();
}

_via_project.prototype.on_filelist_regex = function(el) {
  this._update_filelist_regex(el.target.value);
}
</script>
<!-- End of file: js/_via_project.js-->

<!-- Start of file: js/_via_video_thumbnail.js-->
<script>
/**
 * @class
 * @classdesc Extracts thumbnail sized frames from a video
 *
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 5 Feb. 2019
 * @param {_via_file} an instance of _via_file corresponding to a video file
 */

'use strict';

function _via_video_thumbnail(file) {
  this.file = file;
  this.fwidth = 160;
  this.file_object_url = undefined; // file contents are in this the object url
  this.frames = {}; // indexed by second

  if ( this.file.type !== _VIA_FILE_TYPE.VIDEO ) {
    console.log('_via_video_thumbnail() : file type must be ' +
                _VIA_FILE_TYPE.VIDEO + ' (got ' + this.file.type + ')');
    return;
  }

  // state
  this.is_thumbnail_read_ongoing = false;
  this.thumbnail_time = 0;
  this.thumbnail_canvas = document.createElement('canvas');

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this._EVENT_ID_PREFIX = '_via_video_thumbnail_';
  _via_event.call( this );

  this._init();
}

_via_video_thumbnail.prototype._init = function() {
}

// WARNING: not invoking this method will result in
// resources being allocated to things that are no longer needed
_via_video_thumbnail.prototype._on_event_destroy = function() {
  if ( typeof(this.file_object_url) !== 'undefined' ) {
    console.log('_via_video_thumbnail(): revoking object uri for fid=' + this.file.fid);
    URL.revokeObjectURL(this.file_object_url);
  }
}

_via_video_thumbnail.prototype.start = function() {
  return new Promise( function(ok_callback, err_callback) {
    if ( this.file.src instanceof File ) {
      this._read_file().then( function(file_src_ok) {
        this._load_video(file_src_ok).then( function() {
          this.video.currentTime = 0.0;
          ok_callback();
        }.bind(this), function(err) {
          console.log(err);
          err_callback();
        }.bind(this));
      }.bind(this), function(file_src_err) {
        console.log(file_src_err);
        err_callback();
      }.bind(this));
    } else {
      this._load_video(this.file.src).then( function() {
        this.video.currentTime = 0.0;
        ok_callback();
      }.bind(this), function(err) {
        console.log(err);
        err_callback();
      }.bind(this));
    }
  }.bind(this));
}

_via_video_thumbnail.prototype._read_file = function() {
  return new Promise( function(ok_callback, err_callback) {
    var file_reader = new FileReader();
    file_reader.addEventListener('error', function() {
      console.log('_via_video_thumbnail._read_file() error');
      err_callback('error');
    }.bind(this));
    file_reader.addEventListener('abort', function() {
      console.log('_via_video_thumbnail._read_file() abort');
      err_callback('abort')
    }.bind(this));
    file_reader.addEventListener('load', function() {
      var blob = new Blob( [ file_reader.result ],
                           { type: this.file.src.type }
                         );
      // we keep a reference of file object URL so that we can revoke it when not needed
      // WARNING: ensure that this._destructor() gets called when "this" not needed
      this.file_object_url = URL.createObjectURL(blob);
      console.log(this.file_object_url)
      ok_callback(this.file_object_url);
    }.bind(this));
    console.log(this.file.src)
    file_reader.readAsArrayBuffer( this.file.src );
  }.bind(this));
}

_via_video_thumbnail.prototype._load_video = function(src) {
  return new Promise( function(ok_callback, err_callback) {
    this.video = document.createElement('video');
    this.video.setAttribute('src', src);
    //this.video.setAttribute('autoplay', false);
    //this.video.setAttribute('loop', false);
    //this.video.setAttribute('controls', '');
    this.video.setAttribute('preload', 'auto');
    //this.video.setAttribute('crossorigin', 'anonymous');

    this.video.addEventListener('loadeddata', function() {
      var aspect_ratio = this.video.videoHeight / this.video.videoWidth;
      this.fheight = Math.floor(this.fwidth * aspect_ratio);
      this.thumbnail_canvas.width = this.fwidth;
      this.thumbnail_canvas.height = this.fheight;
      this.thumbnail_context = this.thumbnail_canvas.getContext('2d', { alpha:false });
      ok_callback();
    }.bind(this));
    this.video.addEventListener('error', function() {
      console.log('_via_video_thumnnail._load_video() error')
      err_callback('error');
    }.bind(this));
    this.video.addEventListener('abort', function() {
      console.log('_via_video_thumbnail._load_video() abort')
      err_callback('abort');
    }.bind(this));

    this.video.addEventListener('seeked', this._on_seeked.bind(this));
  }.bind(this));
}

_via_video_thumbnail.prototype.get_thumbnail = function(time_float) {
  this.is_thumbnail_read_ongoing = true;
  this.thumbnail_time = parseInt(time_float);
  this.video.currentTime = this.thumbnail_time;
  return this.thumbnail_canvas;
}

_via_video_thumbnail.prototype._on_seeked = function() {
  if ( this.is_thumbnail_read_ongoing &&
       this.thumbnail_context
     ) {
    this.is_thumbnail_read_ongoing = false;
    this.thumbnail_context.drawImage(this.video,
                                     0, 0, this.video.videoWidth, this.video.videoHeight,
                                     0, 0, this.fwidth, this.fheight
                                    );
  }
}
</script>
<!-- End of file: js/_via_video_thumbnail.js-->
<!-- Start of file: js/_via_region_annotator.js-->
<script>
/**
 * @class
 * @classdesc Manages region draw and view operations on an image or video frame
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 29 Dec. 2018
 * @param {Element} container HTML container element like <div>
 * @param {Object} an instance of {@link _via_file}
 */

'use strict';

function _via_region_annotator(container, file, data) {
  this.c = container;
  this.file = file;
  this.d = data;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this._EVENT_ID_PREFIX = '_via_region_annotator_';
  _via_event.call( this );

  this._is_media_element_loaded = false;
  this.media_element_load_msg = '';

  this.VIDEO_ANNOTATOR_HEIGHT = 0.5; // remaining space used by temporal segment
  this._init();
}

_via_region_annotator.prototype._init = function() {
  this.region_annotator_container = document.createElement('div');
  this.region_annotator_container.classList.add('region_annotator_container');

  this.media = this._media_element_init();
  this.layer_region = document.createElement('canvas');
  this.layer_region.setAttribute('class', 'layer_region');

  this.region_annotator_container.appendChild(this.media);
  this.region_annotator_container.appendChild(this.layer_region);
  this.c.appendChild(this.region_annotator_container);

  this._media_element_load_promise = this._media_element_load();
}

_via_region_annotator.prototype._on_event_show = function() {
  this._media_element_load_promise.then( function(ok) {
    this._media_element_show();
  }.bind(this), function(err) {
    console.log(this.media_element_load_msg)
    _via_util_msg_show(this.media_element_load_msg, true);
  }.bind(this));
}

//
// media element (video, image, audio)
//
_via_region_annotator.prototype._media_element_show = function() {
  var maxw = this.c.clientWidth;
  var region_annotator_height = this.c.clientHeight;
  if ( this.file.type === _VIA_FILE_TYPE.VIDEO ) {
    var temporal_segmenter_height = Math.floor( (1.0 - this.VIDEO_ANNOTATOR_HEIGHT) * region_annotator_height );
    region_annotator_height = region_annotator_height - temporal_segmenter_height;
    this.temporal_segmenter_container = document.createElement('div');
    this.temporal_segmenter_container.classList.add('temporal_segmenter_container');
    this.temporal_segmenter_container.style.height = temporal_segmenter_height + 'px';
    this.c.appendChild(this.temporal_segmenter_container); // must be added to view before initialisation of _via_temporal_segmenter
    this.temporal_segmenter = new _via_temporal_segmenter(this.temporal_segmenter_container,
                                                          this.file,
                                                          this.d,
                                                          this.media);
  }
  this.region_annotator_container.style.height = region_annotator_height + 'px';
  this._media_element_set_size(maxw, region_annotator_height);
}

// this method ensures that all the layers have same size as that of the content
_via_region_annotator.prototype._media_element_set_size = function(maxw, maxh) {
  try {
    // max. dimension of the container
    // to avoid overflowing window, we artificially reduce the max. size by few pixels
    maxw = maxw - 2;
    maxh = maxh - 2;

    // original size of the content
    var cw0, ch0;
    switch( this.file.type ) {
    case _VIA_FILE_TYPE.VIDEO:
      cw0 = this.media.videoWidth;
      ch0 = this.media.videoHeight;
      break;
    case _VIA_FILE_TYPE.IMAGE:
      cw0 = this.media.naturalWidth;
      ch0 = this.media.naturalHeight;
      break;
    }
    var ar = cw0/ch0;
    var ch = maxh;
    var cw = Math.floor(ar * ch);
    if ( cw > maxw ) {
      cw = maxw;
      ch = Math.floor(cw/ar);
    }
    this.cwidth = cw;
    this.cheight = ch;
    this.original_width = cw0;
    this.original_height = ch0;
    this.content_size_css = 'width:' + cw + 'px;height:' + ch + 'px;';
    this.layer_region.width  = this.cwidth;
    this.layer_region.height = this.cheight;
    this.media.setAttribute('style', this.content_size_css);
  } catch (err) {
    console.log(err)
  }
}

_via_region_annotator.prototype._media_element_init = function() {
  var media;
  switch( this.file.type ) {
  case _VIA_FILE_TYPE.VIDEO:
    media = document.createElement('video');
    //media.setAttribute('src', src); // set by _media_element_load() method
    media.setAttribute('class', 'media_element');
    media.setAttribute('controls', '');
    // @todo : add subtitle track for video
    media.setAttribute('preload', 'auto');
    break;

  case _VIA_FILE_TYPE.IMAGE:
    media = document.createElement('image');
    console.warn('@todo');
    break;

  case _VIA_FILE_TYPE.AUDIO:
    media = document.createElement('audio');
    console.warn('@todo');
    break;

  default:
    console.warn('unknown file type = ' + this.file.type);
  }
  return media;
}

_via_region_annotator.prototype._media_element_load = function() {
  return new Promise( function(ok_callback, err_callback) {
    this._media_element_read_file().then( function(file_ok_src) {
      this.media.addEventListener('loadeddata', function() {
        this._is_media_element_loaded = true;
        this.media_element_load_msg = 'Media loaded';
        ok_callback();
      }.bind(this));
      this.media.addEventListener('error', function() {
        console.log('_via_region_annotator._media_element_load() error')
        this._is_media_element_loaded = false;
        this.media_element_load_msg = 'Error loading media [' + this.media.src + ']';
        err_callback();
      }.bind(this));
      this.media.addEventListener('stalled', function() {
        console.log('_via_region_annotator._media_element_load() stalled')
        this._is_media_element_loaded = false;
        this.media_element_load_msg = 'Error loading media [' + this.media.src + ']';
        err_callback();
      }.bind(this));
      this.media.addEventListener('suspend', function() {
        //console.log('_via_region_annotator._media_element_load() suspend')
      }.bind(this));
      this.media.addEventListener('abort', function() {
        console.log('_via_region_annotator._media_element_load() abort')
        this._is_media_element_loaded = false;
        this.media_element_load_msg = 'Error loading media [' + this.media.src + ']';
        err_callback();
      }.bind(this));
      this.media.setAttribute('src', file_ok_src);
    }.bind(this), function(file_err) {
      this.media.setAttribute('src', '');
      this._is_media_element_loaded = false;
      this.media_element_load_msg = 'Error loading media.';
      err_callback();
    }.bind(this));
  }.bind(this));
}

_via_region_annotator.prototype._media_element_read_file = function() {
  return new Promise( function(ok_callback, err_callback) {
    if ( this.file.src instanceof File ) {
      var file_reader = new FileReader();
      file_reader.addEventListener('error', function(e) {
        console.log('_via_region_annotator._read_media_file() error');
        console.warn(e.target.error)
        err_callback(this.file);
      }.bind(this));
      file_reader.addEventListener('abort', function() {
        console.log('_via_region_annotator._read_media_file() abort');
        err_callback(this.file)
      }.bind(this));
      file_reader.addEventListener('load', function() {
        var blob = new Blob( [ file_reader.result ],
                             { type: this.file.src.type }
                           );
        // we keep a reference of file object URL so that we can revoke it when not needed
        // WARNING: ensure that this._destroy_file_object_url() gets called when "this" not needed
        this.file_object_url = URL.createObjectURL(blob);
        ok_callback(this.file_object_url);
      }.bind(this));
      file_reader.readAsArrayBuffer( this.file.src );
    } else {
      ok_callback(this.file.src); // read from URL
    }
  }.bind(this));
}

_via_region_annotator.prototype._on_event_destroy = function() {
  if ( typeof(this.file_object_url) !== 'undefined' ) {
    console.log('_via_region_annotator(): revoked file object url for fid=' + this.file.fid)
    URL.revokeObjectURL(this.file_object_url);
  }

  if ( this.temporal_segmenter ) {
    if ( this.temporal_segmenter.thumbnail ) {
        this.temporal_segmenter.thumbnail._on_event_destroy();
    }
  }
}

//
// external events
//
_via_region_annotator.prototype._on_event_attribute_del = function(aid) {
}

_via_region_annotator.prototype._on_event_attribute_add = function(aid) {
}

_via_region_annotator.prototype._on_event_metadata_add = function(fid, mid) {
  if ( this.temporal_segmenter ) {
    this.temporal_segmenter._on_event_metadata_add(fid,mid);
  }
}

_via_region_annotator.prototype._on_event_metadata_del = function(fid, mid) {
}

_via_region_annotator.prototype._on_event_metadata_update = function(fid, mid) {
}
</script>
<!-- End of file: js/_via_region_annotator.js-->
<!-- Start of file: js/_via_temporal_segmenter.js-->
<script>
/**
 * @class
 * @classdesc Marks time segments of a {@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement|HTMLMediaElement}
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 5 Mar. 2019
 * @fires _via_temporal_segmenter#segment_add
 * @fires _via_temporal_segmenter#segment_del
 * @fires _via_temporal_segmenter#segment_edit
 * @param {Element} container HTML container element like <div>
 * @param {HTMLMediaElement} media_element HTML video of audio
 */

'use strict';

function _via_temporal_segmenter(container, file, data, media_element) {
  this.c = container;
  this.file = file;
  this.d = data;
  this.m = media_element;

  this.groupby = false;
  this.groupby_aid = '';
  this.group = {};
  this.gid_list = ['laughter', 'music'];
  this.selected_gindex = -1;
  this.selected_mindex = -1;
  this.edge_show_time = -1;
  this.group_default_gid_list = [];

  this.DRAW_LINE_WIDTH = 2;
  this.EDGE_UPDATE_TIME_DELTA = 1/50;  // in sec
  this.TEMPORAL_SEG_MOVE_OFFSET = 1;   // in sec
  this.DEFAULT_TEMPORAL_SEG_LEN = 1;   // in sec
  this.GTIMELINE_HEIGHT = 5;           // units of char width
  this.GTIMELINE_ZOOM_OFFSET = 4;      // in pixels
  this.DEFAULT_WIDTH_PER_SEC = 6;      // units of char width
  this.GID_COL_WIDTH = 15;             // units of char width
  this.METADATA_CONTAINER_HEIGHT = 22; // units of char width
  this.METADATA_EDGE_TOL = 0.1;

  this.PLAYBACK_MODE = { NORMAL:'1', REVIEW_SEGMENT:'2', REVIEW_GAP:'3' };
  this.current_playback_mode = this.PLAYBACK_MODE.NORMAL;

  this.metadata_move_is_ongoing = false;
  this.metadata_resize_is_ongoing = false;
  this.metadata_resize_edge_index = -1;
  this.metadata_ongoing_update_x = [0, 0];
  this.metadata_move_start_x = 0;
  this.metadata_move_dx = 0;
  this.metadata_last_added_mid = '';

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this._EVENT_ID_PREFIX = '_via_temporal_segmenter_';
  _via_event.call( this );

  if ( ! this.m instanceof HTMLMediaElement ) {
    throw 'media element must be an instance of HTMLMediaElement!';
  }

  // colour
  this.COLOR_LIST = ["#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7", "#F0E442"];
  this.NCOLOR = this.COLOR_LIST.length;

  this.current_playback_mode = this.PLAYBACK_MODE.NORMAL;

  this._init();
}

_via_temporal_segmenter.prototype._init = function() {
  try {
    this.group_default_gid_list = _VIA_GROUP_DEFAULT_GID_LIST;
    this._group_init('0'); // for debug

    this._thumbview_init();
    this._vtimeline_init();
    this._tmetadata_init();
    this._toolbar_init();

    // trigger the update of animation frames
    this._redraw_all();
    this._redraw_timeline();
  } catch(err) {
    console.log(err);
  }
}

//
// All animation frame routines
//
_via_temporal_segmenter.prototype._redraw_all = function() {
  window.requestAnimationFrame(this._redraw_all.bind(this));
  var tnow = this.m.currentTime;
  this._update_playback_rate(tnow);

  if ( tnow < this.tmetadata_gtimeline_tstart ||
       tnow > this.tmetadata_gtimeline_tend
     ) {
    if ( ! this.m.paused ) {
      var new_tstart = Math.floor(tnow);
      this._tmetadata_boundary_update(new_tstart)
      this._tmetadata_gtimeline_draw();
    } else {
      //this.m.currentTime = this.tmetadata_gtimeline_tstart;
    }
  }

  // lock playback in the selected temporal segment
  if ( this.selected_mindex !== -1 ) {
    if ( ! this.m.paused ) {
      var t = this.d.metadata_store[this.selected_mid].z;
      if ( tnow > t[1] ) {
        this.m.currentTime = t[0];
      }
      if ( tnow < t[0] ) {
        this.m.currentTime = t[0];
      }
    }
  }

  this._redraw_timeline();

  // draw marker to show current time in group timeline and group metadata
  this._tmetadata_draw_currenttime_mark(tnow);
}

_via_temporal_segmenter.prototype._update_playback_rate = function(t) {
  //console.log(this.current_playback_mode + ':' + t)
  if ( this.current_playback_mode !== this.PLAYBACK_MODE.NORMAL ) {
    var mindex = this._tmetadata_group_gid_metadata_at_time(t);
    if ( mindex !== -1 ) {
      if ( this.current_playback_mode === this.PLAYBACK_MODE.REVIEW_SEGMENT ) {
        this._toolbar_playback_rate_set(1);
      } else {
        this._toolbar_playback_rate_set(10);
      }
    } else {
      if ( this.current_playback_mode === this.PLAYBACK_MODE.REVIEW_GAP ) {
        this._toolbar_playback_rate_set(1);
      } else {
        this._toolbar_playback_rate_set(10);
      }
    }
  } else {
    //this._toolbar_playback_rate_set(1);
  }
}

_via_temporal_segmenter.prototype._redraw_timeline = function() {
  // draw the full video timeline (on the top)
  this._vtimeline_mark_draw();
  // draw group timeline
  this._tmetadata_gtimeline_draw();
}

//
// thumbnail viewer
//
_via_temporal_segmenter.prototype._thumbview_init = function() {
  this.thumbnail_container = document.createElement('div');
  this.thumbnail_container.setAttribute('class', 'thumbnail_container');
  this.thumbnail_container.setAttribute('style', 'display:none; position:absolute; top:0; left:0;');
  this.c.appendChild(this.thumbnail_container);

  // initialise thumbnail viewer
  this.thumbnail = new _via_video_thumbnail(this.file);
  this.thumbnail.start();
}

_via_temporal_segmenter.prototype._thumbview_show = function(time, x, y) {
  this.thumbnail_container.innerHTML = '';
  this.thumbnail_container.appendChild(this.thumbnail.get_thumbnail(time));
  this.thumbnail_container.style.display = 'inline-block';

  this.thumbnail_container.style.left = x + this.linehn[2] + 'px';
  this.thumbnail_container.style.top  = y + this.linehn[4] + 'px';
}

_via_temporal_segmenter.prototype._thumbview_hide = function(t) {
  this.thumbnail_container.style.display = 'none';
}

//
// Full video timeline
//
_via_temporal_segmenter.prototype._vtimeline_init = function() {
  this.vtimeline = document.createElement('canvas');
  this.vtimeline.setAttribute('class', 'video_timeline');
  this.vtimeline.style.cursor = 'pointer';
  this.vtimeline.addEventListener('mousedown', this._vtimeline_on_mousedown.bind(this));
  this.vtimeline.addEventListener('mousemove', this._vtimeline_on_mousemove.bind(this));
  this.vtimeline.addEventListener('mouseout', this._vtimeline_on_mouseout.bind(this));

  var ctx = this.vtimeline.getContext('2d', {alpha:false});
  ctx.font = '10px Sans';
  this.char_width = ctx.measureText('M').width;
  this.vtimeline.width = this.c.clientWidth;
  this.vtimeline.height = Math.floor(2*this.char_width);
  this.padx = this.char_width;
  this.pady = this.char_width;
  this.lineh = Math.floor(this.char_width);
  this.linehn = []; // contains multiples of line_height for future ref.
  for ( var i = 0; i < 20; ++i ) {
    this.linehn[i] = i * this.lineh;
  }
  this.linehb2 = Math.floor(this.char_width/2);
  this.vtimelinew = Math.floor(this.vtimeline.width - 2*this.padx);

  // clear
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, this.vtimeline.width, this.vtimeline.height);

  // draw line
  ctx.strokeStyle = '#999999';
  ctx.fillStyle = '#999999';
  ctx.lineWidth = this.DRAW_LINE_WIDTH;
  ctx.beginPath();
  ctx.moveTo(this.padx, 1);
  ctx.lineTo(this.padx + this.vtimelinew, 1);
  ctx.stroke();

  // draw time gratings and corresponding label
  var start = this.padx;
  var time = 0;
  var width_per_tick = 10 * this.char_width;
  var end = this.vtimelinew - width_per_tick;
  var width_per_sec  = this._vtimeline_time2canvas(1);

  ctx.beginPath();
  while ( start <end && time < this.m.duration ) {
    ctx.moveTo(start, 1);
    ctx.lineTo(start, this.lineh - 1);

    time = this._vtimeline_canvas2time(start);
    if ( width_per_sec > width_per_tick ) {
      ctx.fillText(this._time2strms(time), start, this.linehn[2] - 1);
    } else {
      ctx.fillText(this._time2str(time), start, this.linehn[2] - 1);
    }

    start = start + 10*this.char_width;
  }
  ctx.stroke();

  // draw the end mark
  var endx = this._vtimeline_time2canvas(this.m.duration);
  ctx.beginPath();
  ctx.moveTo(endx, 1);
  ctx.lineTo(endx, this.lineh - 1);
  ctx.stroke();
  var tendstr = this._time2strms(this.m.duration);
  var tendstr_width = ctx.measureText(tendstr).width;
  ctx.fillStyle = '#999999';
  ctx.fillText(tendstr, endx - tendstr_width, this.linehn[2] - 1);

  //// timeline mark showing the current video time
  //// and placed just above the full video timeline
  this.vtimeline_mark = document.createElement('canvas');
  this.vtimeline_mark.setAttribute('class', 'video_timeline_mark');
  this.vtimeline_mark_ctx = this.vtimeline_mark.getContext('2d', {alpha:false});
  this.vtimeline_mark.width = this.vtimeline.width;
  this.vtimeline_mark.height = this.linehn[2];

  this.c.appendChild(this.vtimeline_mark);
  this.c.appendChild(this.vtimeline);
}

_via_temporal_segmenter.prototype._vtimeline_time2canvas = function(t) {
  return Math.floor( ( ( this.vtimelinew * t ) / this.m.duration ) + this.padx );
}

_via_temporal_segmenter.prototype._vtimeline_canvas2time = function(x) {
  var t = ( ( x - this.padx ) / this.vtimelinew ) * this.m.duration;
  return Math.max(0, Math.min(t, this.m.duration) );
}

_via_temporal_segmenter.prototype._vtimeline_mark_draw = function() {
  var time = this.m.currentTime;
  var cx = this._vtimeline_time2canvas(time);

  // clear
  this.vtimeline_mark_ctx.font = '16px Mono';
  this.vtimeline_mark_ctx.fillStyle = 'white';
  this.vtimeline_mark_ctx.fillRect(0, 0,
                                   this.vtimeline_mark.width,
                                   this.vtimeline_mark.height);

  // draw arrow
  this.vtimeline_mark_ctx.fillStyle = 'black';
  this.vtimeline_mark_ctx.beginPath();
  this.vtimeline_mark_ctx.moveTo(cx, this.linehn[2]);
  this.vtimeline_mark_ctx.lineTo(cx - this.linehb2, this.lineh);
  this.vtimeline_mark_ctx.lineTo(cx + this.linehb2, this.lineh);
  this.vtimeline_mark_ctx.moveTo(cx, this.linehn[2]);
  this.vtimeline_mark_ctx.fill();

  // draw current time
  this.vtimeline_mark_ctx.fillStyle = '#666666';
  var tstr = this._time2strms(time);
  var twidth = this.vtimeline_mark_ctx.measureText(tstr).width;
  var tx = cx + this.lineh;
  if ( cx + twidth > this.vtimelinew ) {
    tx = tx - twidth - this.linehn[2];
  }
  this.vtimeline_mark_ctx.fillText(tstr, tx, this.linehn[2] - 2);
}

_via_temporal_segmenter.prototype._vtimeline_on_mousedown = function(e) {
  var canvas_x = e.offsetX;
  var time = this._vtimeline_canvas2time(canvas_x);
  this.m.currentTime = time;

  var new_tstart = Math.floor(time);
  this._tmetadata_boundary_update(new_tstart)
  this._tmetadata_gtimeline_draw();
}

_via_temporal_segmenter.prototype._vtimeline_on_mousemove = function(e) {
  var time = this._vtimeline_canvas2time(e.offsetX);
  this._thumbview_show(time, e.offsetX, e.offsetY);
}

_via_temporal_segmenter.prototype._vtimeline_on_mouseout = function(e) {
  this._thumbview_hide();
}

//
// Metadata Panel
//
_via_temporal_segmenter.prototype._tmetadata_init = function(e) {
  this.tmetadata_container = document.createElement('div');
  this.tmetadata_container.setAttribute('class', 'tmetadata_container');

  var cw = this.c.clientWidth;
  this.gid_width = this.linehn[15];
  this.timeline_container_width = cw - this.gid_width - this.linehn[3];
  this.tmetadata_timelinew = this.timeline_container_width - Math.floor(2 * this.padx);
  this.tmetadata_width_per_sec = this.linehn[this.DEFAULT_WIDTH_PER_SEC];
  this._tmetadata_boundary_update(0); // determine the boundary of gtimeline

  // header
  var header_container = document.createElement('div');
  header_container.setAttribute('class', 'header_container');
  var header = document.createElement('table');
  var hrow = document.createElement('tr');
  var groupvar_col = document.createElement('td');
  groupvar_col.setAttribute('style', 'width:' + this.gid_width + 'px;');
  //groupvar_col.innerHTML = this.d.attribute_store[this.groupby_aid].aname;
  /* // hide as not needed now
  this.groupby_select = document.createElement('select');
  this.groupby_select.setAttribute('title', 'Group creates multiple slices of the timeline where each slice corresponds to one unique value of the group attribute.')
  var aindex, aid;
  for ( aindex in this.d.aid_list ) {
    var oi = document.createElement('option');
    oi.setAttribute('value', this.d.aid_list[aindex]);
    oi.innerHTML = this.d.attribute_store[ this.d.aid_list[aindex] ].aname;
    this.groupby_select.appendChild(oi);
  }
  this.groupby_select.addEventListener('change', function(e) {
    var aid = e.target.options[e.target.selectedIndex];
    this._group_init(aid);
  }.bind(this));
  groupvar_col.appendChild(this.groupby_select);
  */

  var gtimeline_col = document.createElement('td');
  this._tmetadata_gtimeline_init();
  gtimeline_col.appendChild(this.gtimeline);
  hrow.appendChild(groupvar_col);
  hrow.appendChild(gtimeline_col);
  header.appendChild(hrow);
  header_container.appendChild(header);
  this.tmetadata_container.appendChild(header_container);

  // metadata
  this.metadata_container = document.createElement('div');
  this.metadata_container.setAttribute('class', 'metadata_container');
  this.metadata_container.setAttribute('style', 'display:inline-block; max-height:' +
                                       this.lineh * this.METADATA_CONTAINER_HEIGHT +
                                       'px; width:100%; overflow:auto;');

  this._tmetadata_update();
  this.tmetadata_container.appendChild(this.metadata_container);
  this.c.appendChild(this.tmetadata_container);

  if ( this.gid_list.length ) {
    this._tmetadata_group_gid_sel(0);
  }
}

_via_temporal_segmenter.prototype._tmetadata_update = function() {
  // metadata
  this.metadata_container.innerHTML = '';

  var metadata_table = document.createElement('table');
  this.metadata_tbody = document.createElement('tbody');

  this.gcanvas = {}; // contains a list of canvas for each group
  this.gctx = {};    // contains the corresponding drawing context
  var gindex, gid;
  for ( gindex in this.gid_list ) {
    gid = this.gid_list[gindex];
    this.metadata_tbody.appendChild( this._tmetadata_group_gid_html(gid) );
  }
  metadata_table.appendChild(this.metadata_tbody);
  this.metadata_container.appendChild(metadata_table);
}

_via_temporal_segmenter.prototype._tmetadata_boundary_move = function(dt) {
  var new_start = Math.floor(this.tmetadata_gtimeline_tstart + dt);
  if ( new_start >= 0 &&
       new_start < this.m.duration
     ) {
    this._tmetadata_boundary_update(new_start);
    if ( this.m.currentTime < this.tmetadata_gtimeline_tstart ) {
      this.m.currentTime = this.tmetadata_gtimeline_tstart;
    } else {
      if ( this.m.currentTime > this.tmetadata_gtimeline_tend ) {
        this.m.currentTime = this.tmetadata_gtimeline_tend;
      }
    }
  } else {
    _via_util_msg_show('Cannot move beyond the video timeline boundary!');
  }
}

_via_temporal_segmenter.prototype._tmetadata_boundary_update = function(tstart) {
  this.tmetadata_gtimeline_tstart = tstart;
  this.tmetadata_gtimeline_xstart = this.padx;

  var t = this.tmetadata_gtimeline_tstart;
  var tx = this.tmetadata_gtimeline_xstart;
  var endx = tx + this.tmetadata_timelinew;
  this.tmetadata_gtimeline_mark_x = [];
  this.tmetadata_gtimeline_mark_time_str = [];
  while ( tx <= endx && t <= this.m.duration ) {
    this.tmetadata_gtimeline_mark_x.push(tx);
    this.tmetadata_gtimeline_mark_time_str.push( this._time2str(t) );

    t = t + 1;
    tx = tx + this.tmetadata_width_per_sec;
    //console.log('t='+t + ',tx=' + tx+', dur='+this.m.duration+',endx='+endx);
  }
  if ( t >= this.m.duration ) {
    this.tmetadata_gtimeline_tend = this.m.duration;
  } else {
    this.tmetadata_gtimeline_tend = t - 1;
  }
  this.tmetadata_gtimeline_xend = this.tmetadata_gtimeline_xstart + (this.tmetadata_gtimeline_tend - this.tmetadata_gtimeline_tstart) * this.tmetadata_width_per_sec;

  //console.log(this.tmetadata_gtimeline_xstart+':'+this.tmetadata_gtimeline_tstart+' - ' + this.tmetadata_gtimeline_xend + ':' + this.tmetadata_gtimeline_tend);

  // asynchronously pull out the metadata in the current group timeline boundary
  this.tmetadata_gtimeline_mid = {};
  setTimeout( this._tmetadata_boundary_fetch_all_mid.bind(this), 0);
}

_via_temporal_segmenter.prototype._tmetadata_boundary_fetch_all_mid = function() {
  var gindex;
  var t0, t1;

  for ( gindex in this.gid_list ) {
    this._tmetadata_boundary_fetch_gid_mid( this.gid_list[gindex] );
    this._tmetadata_group_gid_draw( this.gid_list[gindex] );
  }
}

_via_temporal_segmenter.prototype._tmetadata_boundary_fetch_gid_mid = function(gid) {
  this.tmetadata_gtimeline_mid[gid] = [];
  var mid_list = [];
  var mindex, mid, t0, t1;
  for ( mindex in this.group[gid] ) {
    mid = this.group[gid][mindex];
    t0 = this.d.metadata_store[mid].z[0];
    t1 = this.d.metadata_store[mid].z[1];

    if ( (t0 >= this.tmetadata_gtimeline_tstart &&
          t0 <= this.tmetadata_gtimeline_tend) ||
         (t1 >= this.tmetadata_gtimeline_tstart &&
          t1 <= this.tmetadata_gtimeline_tend) ||
         (t0 <= this.tmetadata_gtimeline_tstart &&
          t1 >= this.tmetadata_gtimeline_tend)
       ) {
      this.tmetadata_gtimeline_mid[gid].push(mid);
    }
  }
  this.tmetadata_gtimeline_mid[gid].sort( this._compare_mid_by_time.bind(this) );
}

//
// group timeline (common to all group-id and shown at top)
//
_via_temporal_segmenter.prototype._tmetadata_gtimeline_init = function(container) {
  this.gtimeline = document.createElement('canvas');
  this.gtimeline.setAttribute('class', 'gtimeline');
  this.gtimeline.addEventListener('mousedown', this._tmetadata_gtimeline_mousedown.bind(this));
  this.gtimeline.addEventListener('mouseup', this._tmetadata_gtimeline_mouseup.bind(this));

  this.gtimeline.width = this.timeline_container_width;
  this.gtimeline.height = this.linehn[this.GTIMELINE_HEIGHT];
  this.gtimelinectx = this.gtimeline.getContext('2d', {alpha:false});

  this.gtimeline.addEventListener('wheel', this._tmetadata_gtimeline_wheel_listener.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_wheel_listener = function(e) {
  if ( e.shiftKey ) {
    // pan temporal segment horizontally
    if (e.deltaY < 0) {
      this._tmetadata_boundary_move(this.TEMPORAL_SEG_MOVE_OFFSET);
    } else {
      this._tmetadata_boundary_move(-this.TEMPORAL_SEG_MOVE_OFFSET);
    }
  } else {
    // zoom temporal segment
    if (e.deltaY < 0) {
      this._tmetadata_gtimeline_zoomin();
    } else {
      this._tmetadata_gtimeline_zoomout();
    }
  }
  e.preventDefault();
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_zoomin = function() {
  var wps = this.tmetadata_width_per_sec + this.GTIMELINE_ZOOM_OFFSET;
  if ( wps < this.gtimeline.width ) {
    this.tmetadata_width_per_sec = wps;
    this._tmetadata_boundary_update(this.tmetadata_gtimeline_tstart);
    this._redraw_all();
  }
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_zoomout = function() {
  var wps = this.tmetadata_width_per_sec - this.GTIMELINE_ZOOM_OFFSET;
  if ( wps > 1 ) {
    this.tmetadata_width_per_sec = wps;
    this._tmetadata_boundary_update(this.tmetadata_gtimeline_tstart);
    this._redraw_all();
  }
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_clear = function() {
  this.gtimelinectx.fillStyle = '#ffffff';
  this.gtimelinectx.fillRect(0, 0, this.gtimeline.width, this.gtimeline.height);
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_draw = function() {
  this._tmetadata_gtimeline_clear();

  // draw line
  this.gtimelinectx.strokeStyle = '#707070';
  this.gtimelinectx.fillStyle = '#707070';
  this.gtimelinectx.lineWidth = this.DRAW_LINE_WIDTH;
  this.gtimelinectx.beginPath();
  this.gtimelinectx.moveTo(this.tmetadata_gtimeline_xstart, this.linehn[3]);
  this.gtimelinectx.lineTo(this.tmetadata_gtimeline_xend, this.linehn[3]);
  this.gtimelinectx.stroke();

  if ( this.tmetadata_gtimeline_mark_x.length ) {
    /*
    // draw tick marks
    this.gtimelinectx.beginPath();
    for ( var i = 0; i < this.tmetadata_gtimeline_mark_x.length; ++i ) {
      this.gtimelinectx.moveTo(this.tmetadata_gtimeline_mark_x[i], this.linehn[3]);
      this.gtimelinectx.lineTo(this.tmetadata_gtimeline_mark_x[i], this.linehn[4]);
    }
    this.gtimelinectx.stroke();
    */

    // draw tick labels
    this.gtimelinectx.fillStyle = '#666666';
    this.gtimelinectx.font = '9px Sans';
    var last_mark_x = this.tmetadata_gtimeline_mark_x[0];
    var tick_width = this.gtimelinectx.measureText(this.tmetadata_gtimeline_mark_time_str[0]).width;
    var dx;
    this.gtimelinectx.beginPath();
    for ( var i = 0; i < this.tmetadata_gtimeline_mark_x.length; ++i ) {
      dx = this.tmetadata_gtimeline_mark_x[i] - last_mark_x;
      if ( i === 0 || dx > tick_width ) {
        // draw tick
        this.gtimelinectx.moveTo(this.tmetadata_gtimeline_mark_x[i], this.linehn[3]);
        this.gtimelinectx.lineTo(this.tmetadata_gtimeline_mark_x[i], this.linehn[4]);

        // draw label
        this.gtimelinectx.fillText(this.tmetadata_gtimeline_mark_time_str[i],
                                   this.tmetadata_gtimeline_mark_x[i], this.linehn[5] );
        last_mark_x = this.tmetadata_gtimeline_mark_x[i];
      } else {
        // avoid crowding of labels
        continue;
      }
    }
    this.gtimelinectx.stroke();
  }
}

_via_temporal_segmenter.prototype._tmetadata_draw_currenttime_mark = function(tnow) {
  // clear previous mark
  this.gtimelinectx.fillStyle = '#ffffff';
  this.gtimelinectx.fillRect(0, 0, this.gtimeline.width, this.linehn[3] - 1);

  var markx = this._tmetadata_gtimeline_time2canvas(tnow);

  this.gtimelinectx.fillStyle = 'black';
  this.gtimelinectx.beginPath();
  this.gtimelinectx.moveTo(markx, this.linehn[3]);
  this.gtimelinectx.lineTo(markx - this.linehb2, this.linehn[2]);
  this.gtimelinectx.lineTo(markx + this.linehb2, this.linehn[2]);
  this.gtimelinectx.moveTo(markx, this.linehn[3]);
  this.gtimelinectx.fill();

  // show playback rate
  this.gtimelinectx.font = '10px Sans';
  var rate = this.m.playbackRate.toFixed(1) + 'X';
  this.gtimelinectx.fillText(rate, this.tmetadata_gtimeline_xend - this.linehn[3], this.linehn[3] - 2);
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_canvas2time = function(x) {
  var T = this.tmetadata_gtimeline_tend - this.tmetadata_gtimeline_tstart;
  var W = this.tmetadata_gtimeline_xend - this.tmetadata_gtimeline_xstart;
  var dx = x - this.padx;
  return this.tmetadata_gtimeline_tstart + ((T * dx) / W);
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_time2canvas = function(t) {
  var canvas_x;
  if ( t < this.tmetadata_gtimeline_tstart ||
       t > this.tmetadata_gtimeline_tend ) {
    // clamp to canvas boundary
    if ( t < this.tmetadata_gtimeline_tstart ) {
      canvas_x = this.tmetadata_gtimeline_xstart;
    } else {
      canvas_x = this.tmetadata_gtimeline_xend;
    }
  } else {
    var sec = Math.floor(t);
    var sec_mark_index = sec - this.tmetadata_gtimeline_tstart;
    var ms = t - sec;
    var ms_x = Math.ceil(ms * this.tmetadata_width_per_sec);
    canvas_x = this.tmetadata_gtimeline_mark_x[sec_mark_index] + ms_x;
  }
  return canvas_x;
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_mousedown = function(e) {
  var t = this._tmetadata_gtimeline_canvas2time(e.offsetX);
  this.m.currentTime = t;
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_mouseup = function(e) {
}

//
// metadata for a given group-id
//
_via_temporal_segmenter.prototype._tmetadata_group_update_gid = function(e) {
  var old_gid = e.target.dataset.gid;
  var new_gid = e.target.value.trim();
  var mindex, mid;
  var update_list = [];
  for ( mindex in this.group[old_gid] ) {
    mid = this.group[old_gid][mindex]
    update_list.push( {'mid':mid,
                       'aid':this.groupby_aid,
                       'value':new_gid,
                      } );
  }
  this.d.metadata_update_attribute_value_bulk(this.file.fid, update_list);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_html = function(gid) {
  var tr = document.createElement('tr');
  tr.setAttribute('data-gid', gid);
  var gid_col = document.createElement('td');
  gid_col.setAttribute('style', 'width:' + this.gid_width + 'px; padding:0.2em 0.5em;');
  var gid_label = document.createElement('input');
  gid_label.setAttribute('type', 'text');
  gid_label.setAttribute('value', gid);
  gid_label.setAttribute('data-gid', gid);
  gid_label.addEventListener('change', this._tmetadata_group_update_gid.bind(this));
  gid_col.appendChild(gid_label);
  tr.appendChild(gid_col);

  var gidtimeline = document.createElement('td');
  this._tmetadata_group_gid_init(gid);
  gidtimeline.appendChild( this.gcanvas[gid] );
  tr.appendChild(gidtimeline);
  return tr;
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_html_del = function(gid) {
  var tr_list = this.metadata_tbody.getElementsByTagName('tr');
  var i;
  for ( i = 0; i < tr_list.length; ++i ) {
    if ( tr_list[i].dataset.gid === gid ) {
      this.metadata_tbody.removeChild(tr_list[i]);
      break;
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_init = function(gid) {
  this.gcanvas[gid] = document.createElement('canvas');
  this.gcanvas[gid].setAttribute('data-gid', gid);
  this.gcanvas[gid].setAttribute('data-gindex', this.gid_list.indexOf(gid));
  this.gcanvas[gid].width = this.timeline_container_width;
  this.gcanvas[gid].height = this.linehn[4];
  this.gctx[gid] = this.gcanvas[gid].getContext('2d', {alpha:false});

  this.gcanvas[gid].addEventListener('mousemove', this._tmetadata_group_gid_mousemove.bind(this));
  this.gcanvas[gid].addEventListener('mousedown', this._tmetadata_group_gid_mousedown.bind(this));
  this.gcanvas[gid].addEventListener('mouseup', this._tmetadata_group_gid_mouseup.bind(this));
  this._tmetadata_group_gid_draw(gid);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_clear = function(gid) {
  if ( gid === this.selected_gid ) {
    this.gctx[gid].fillStyle = '#e6e6e6';
  } else {
    this.gctx[gid].fillStyle = '#ffffff';
  }
  this.gctx[gid].fillRect(0, 0, this.gcanvas[gid].width, this.gcanvas[gid].height);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw = function(gid) {
  this._tmetadata_group_gid_clear(gid);
  this._tmetadata_group_gid_draw_boundary(gid);
  this._tmetadata_group_gid_draw_metadata(gid);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_boundary = function(gid) {
  var gindex = this.gid_list.indexOf(gid);
  var bcolor = this.COLOR_LIST[ gindex % this.NCOLOR ];
  // draw line
  this.gctx[gid].strokeStyle = bcolor;
  this.gctx[gid].fillStyle = '#ffffff';
  this.gctx[gid].lineWidth = this.DRAW_LINE_WIDTH;

  this.gctx[gid].beginPath();
  this.gctx[gid].moveTo(this.tmetadata_gtimeline_xstart, this.linehn[1]);
  this.gctx[gid].lineTo(this.tmetadata_gtimeline_xend, this.linehn[1]);
  this.gctx[gid].lineTo(this.tmetadata_gtimeline_xend, this.linehn[3]);
  this.gctx[gid].lineTo(this.tmetadata_gtimeline_xstart, this.linehn[3]);
  this.gctx[gid].lineTo(this.tmetadata_gtimeline_xstart, this.linehn[1]);
  this.gctx[gid].stroke();
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mark_selected = function() {
  var gid = this.selected_gid;
  var mid = this.selected_mid;
  var t0, t1, x0, x1;
  t0 = this.d.metadata_store[mid].z[0];
  t1 = this.d.metadata_store[mid].z[1];
  x0 = this._tmetadata_gtimeline_time2canvas(t0);
  x1 = this._tmetadata_gtimeline_time2canvas(t1);

  // draw arrow extending to the edges of temporal segment
  this.gctx[gid].fillStyle = '#f2f2f2';
  this.gctx[gid].strokeStyle = '#e6e6e6';

  this.gctx[gid].lineWidth = this.DRAW_LINE_WIDTH;
  this.gctx[gid].beginPath();
  this.gctx[gid].moveTo(x0 + 2, this.linehn[2]);
  this.gctx[gid].lineTo(x0 + this.linehb2 + 2, this.linehn[2] - this.linehb2);
  this.gctx[gid].lineTo(x0 + this.linehb2 + 2, this.linehn[2] + this.linehb2);
  this.gctx[gid].lineTo(x0 + 2, this.linehn[2]);
  this.gctx[gid].lineTo(x1 - 1, this.linehn[2]);
  this.gctx[gid].lineTo(x1 - this.linehb2 - 1, this.linehn[2] - this.linehb2);
  this.gctx[gid].lineTo(x1 - this.linehb2 - 1, this.linehn[2] + this.linehb2);
  this.gctx[gid].lineTo(x1 - 1, this.linehn[2]);
  this.gctx[gid].stroke();
  this.gctx[gid].fill();

  // draw edge time if an edge is being updated
  if ( this.edge_show_time !== -1 ) {
    this.gctx[gid].font = '10px Sans';
    this.gctx[gid].fillStyle = '#000000';

    var time_str = this.d.metadata_store[this.selected_mid].z[this.edge_show_time].toFixed(3);
    if ( this.edge_show_time === 0 ) {
      this.gctx[gid].fillText(time_str, x0 + 1, this.linehn[4]);
    } else {
      var twidth = this.gctx[gid].measureText(time_str).width;
      this.gctx[gid].fillText(time_str, x1 - twidth, this.linehn[4]);
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_metadata = function(gid) {
  if ( this.tmetadata_gtimeline_mid.hasOwnProperty(gid) ) {
    var mindex, mid;
    for ( mindex in this.tmetadata_gtimeline_mid[gid] ) {
      mid = this.tmetadata_gtimeline_mid[gid][mindex];
      this._tmetadata_group_gid_draw_mid(gid, mid);
    }

    if ( this.selected_gid === gid &&
         this.selected_mindex !== -1
       ) {
      this._tmetadata_group_gid_mark_selected();
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_mid = function(gid, mid) {
  var t0, t1, x0, x1;
  t0 = this.d.metadata_store[mid].z[0];
  t1 = this.d.metadata_store[mid].z[1];
  x0 = this._tmetadata_gtimeline_time2canvas(t0);
  x1 = this._tmetadata_gtimeline_time2canvas(t1);

  // draw metadata block
  if ( gid === this.selected_gid &&
       mid === this.selected_mid ) {
    this.gctx[gid].fillStyle = '#333333';
    if ( this.metadata_resize_is_ongoing || this.metadata_move_is_ongoing ) {
      if ( this.metadata_resize_is_ongoing ) {
        x0 = this.metadata_ongoing_update_x[0];
        x1 = this.metadata_ongoing_update_x[1];
      } else {
        x0 = this.metadata_ongoing_update_x[0] + this.metadata_move_dx;
        x1 = this.metadata_ongoing_update_x[1] + this.metadata_move_dx;
      }
    }
  } else {
    var gindex = this.gid_list.indexOf(gid);
    var bcolor = this.COLOR_LIST[ gindex % this.NCOLOR ];
    this.gctx[gid].fillStyle = bcolor;
    //this.gctx[gid].fillStyle = '#808080';
  }

  this.gctx[gid].beginPath();
  this.gctx[gid].moveTo(x0, this.linehn[1] + 1);
  this.gctx[gid].lineTo(x1, this.linehn[1] + 1);
  this.gctx[gid].lineTo(x1, this.linehn[3] - 1);
  this.gctx[gid].lineTo(x0, this.linehn[3] - 1);
  this.gctx[gid].lineTo(x0, this.linehn[1] + 1);
  this.gctx[gid].fill();

  // vertical lines for edge ref.
  this.gctx[gid].strokeStyle = '#000000';
  this.gctx[gid].beginPath();
  this.gctx[gid].moveTo(x0 + 2, this.linehn[1] - 2);
  this.gctx[gid].lineTo(x0, this.linehn[1] - 2);
  this.gctx[gid].lineTo(x0, this.linehn[3] + 2);
  this.gctx[gid].lineTo(x0+2, this.linehn[3] + 2);
  this.gctx[gid].moveTo(x1 - 2, this.linehn[1] - 2);
  this.gctx[gid].lineTo(x1, this.linehn[1] - 2);
  this.gctx[gid].lineTo(x1, this.linehn[3] + 2);
  this.gctx[gid].lineTo(x1 - 2, this.linehn[3] + 2);
  this.gctx[gid].stroke();
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel = function(gindex) {
  var old_selected_gindex = this.selected_gindex;

  this.selected_gindex = gindex;
  this.selected_gid = this.gid_list[this.selected_gindex];
  this.selected_mindex = -1;
  this.selected_mid = '';

  this.edge_show_time = -1;
  this._tmetadata_group_gid_draw(this.selected_gid);
  this.gcanvas[this.selected_gid].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});

  // update old selection
  if ( old_selected_gindex !== -1 ) {
    if ( this.gid_list.hasOwnProperty(old_selected_gindex) ) {
      var old_selected_gid = this.gid_list[old_selected_gindex];
      this._tmetadata_group_gid_draw(old_selected_gid);
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_metadata = function(mindex) {
  var old_selected_mindex = this.selected_mindex;
  this.selected_mindex = mindex;
  this.selected_mid = this.tmetadata_gtimeline_mid[this.selected_gid][mindex];
  this.m.currentTime = this.d.metadata_store[this.selected_mid].z[0];
  this._tmetadata_group_gid_draw(this.selected_gid);
  _via_util_msg_show('Metadata selected. ' +
                     'Use <span class="key">l</span> or <span class="key">r</span> to expand and ' +
                     '<span class="key">L</span> or <span class="key">R</span> to reduce segment. ' +
                     'Press <span class="key">&larr;</span>&nbsp;<span class="key">&rarr;</span> to move, ' +
                     '<span class="key">Backspace</span> to delete and ' +
                     '<span class="key">Esc</span> to unselect.', true);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_remove_mid_sel = function(mindex) {
  this.selected_mindex = -1;
  this.selected_mid = '';
  this.edge_show_time = -1;
  this._tmetadata_group_gid_draw(this.selected_gid);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_metadata_at_time = function() {
  var t = this.m.currentTime;
  var mindex = this._tmetadata_group_gid_metadata_at_time(t);
  if ( mindex !== -1 ) {
    this._tmetadata_group_gid_sel_metadata(mindex);
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_metadata_at_time = function(t) {
  var mindex, mid;
  for ( mindex in this.tmetadata_gtimeline_mid[this.selected_gid] ) {
    mid = this.tmetadata_gtimeline_mid[this.selected_gid][mindex];
    if ( t >= this.d.metadata_store[mid].z[0] &&
         t <= this.d.metadata_store[mid].z[1]
       ) {
      return parseInt(mindex);
    }
  }
  return -1;
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_next_metadata = function() {
  var sgid = this.gid_list[this.selected_gindex];
  if ( this.selected_mindex === -1 ) {
    if ( this.tmetadata_gtimeline_mid.hasOwnProperty(sgid) ) {
      if ( this.tmetadata_gtimeline_mid[sgid].length ) {
        // select first mid
        this._tmetadata_group_gid_sel_metadata(0);
      }
    }
  } else {
    var next_mindex = this.selected_mindex + 1;
    if ( next_mindex >= this.tmetadata_gtimeline_mid[sgid].length ) {
      next_mindex = 0;
    }
    this._tmetadata_group_gid_sel_metadata(next_mindex);
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_prev_metadata = function() {
  var sgid = this.gid_list[this.selected_gindex];
  if ( this.selected_mindex === -1 ) {
    if ( this.tmetadata_gtimeline_mid.hasOwnProperty(sgid) ) {
      if ( this.tmetadata_gtimeline_mid[sgid].length ) {
        this._tmetadata_group_gid_sel_metadata(this.tmetadata_gtimeline_mid[sgid].length - 1);
      }
    }
  } else {
    var prev_mindex = this.selected_mindex - 1;
    if ( prev_mindex < 0 ) {
      prev_mindex =  this.tmetadata_gtimeline_mid[sgid].length - 1;
    }
    this._tmetadata_group_gid_sel_metadata(prev_mindex);
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_update_edge = function(eindex, dz) {
  this.edge_show_time = eindex;
  // to ensure only 3 decimal values are stored for time
  var new_value = this.d.metadata_store[this.selected_mid].z[eindex] + dz;
  new_value = _via_util_float_to_fixed(new_value, 3);

  // consistency check
  if ( eindex === 0 ) {
    if ( new_value >= this.d.metadata_store[this.selected_mid].z[1] ) {
      _via_util_msg_show('Cannot update left edge!');
      return;
    }
  } else {
    if ( new_value <= this.d.metadata_store[this.selected_mid].z[0] ) {
      _via_util_msg_show('Cannot update right edge!');
      return;
    }
  }
  if ( new_value < 0.0 || new_value > this.m.duration ) {
    _via_util_msg_show('Cannot update edge beyond the boundary!');
    return;
  }

  this.d.metadata_update_zi(this.file.fid,
                            this.selected_mid,
                            eindex,
                            new_value
                           );
  this.m.currentTime = new_value;
  this._tmetadata_group_gid_draw(this.selected_gid);
}

_via_temporal_segmenter.prototype._tmetadata_mid_move = function(dt) {
  var n = this.d.metadata_store[this.selected_mid].z.length;
  var newz = this.d.metadata_store[this.selected_mid].z.slice();
  for ( var i = 0; i < n; ++i ) {
    newz[i] = parseFloat((parseFloat(newz[i]) + dt).toFixed(3));
    if ( newz[i] < 0 || newz[i] > this.m.duration ) {
      _via_util_msg_show('Cannot move temporal segment beyond the boundary!');
      return;
    }
  }
  this.d.metadata_update_z(this.file.fid, this.selected_mid, newz).then( function(ok) {
    this.m.currentTime = this.d.metadata_store[this.selected_mid].z[0];

    // the move operation may have changed the sequential order of mid
    this._tmetadata_boundary_fetch_gid_mid(this.selected_gid);

    // check if we need to shift timeline to show the recently moved metadata
    if ( newz[0] <= this.tmetadata_gtimeline_tstart ||
         newz[1] >= this.tmetadata_gtimeline_tend ) {
      var new_tstart = this.tmetadata_gtimeline_tstart - 1;
      if ( newz[1] >= this.tmetadata_gtimeline_tend ) {
        new_tstart = this.tmetadata_gtimeline_tstart + 1;
      }
      if ( new_tstart >= 0 ) {
        this._tmetadata_boundary_update(new_tstart)
        this._tmetadata_gtimeline_draw();
      }
    } else {
      this._tmetadata_group_gid_draw(this.selected_gid);
    }
  }.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_mid_del_sel = function(mid) {
  this._tmetadata_mid_del(this.selected_mid);
  this._tmetadata_group_gid_remove_mid_sel();
}

_via_temporal_segmenter.prototype._tmetadata_mid_del = function(mid) {
  var mindex = this.tmetadata_gtimeline_mid[this.selected_gid].indexOf(mid);
  if ( mindex !== -1 ) {
    this.tmetadata_gtimeline_mid[this.selected_gid].splice(mindex, 1);

    this._group_gid_del_mid(this.selected_gid, mid);
    this.d.metadata_del(this.file.fid, mid);
    this._tmetadata_group_gid_draw(this.selected_gid);
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_update_last_added_end_edge_to_time = function(t) {
  if ( this.d.metadata_store.hasOwnProperty(this.metadata_last_added_mid) ) {
    var z_now = this.d.metadata_store[this.metadata_last_added_mid].z;
    var update_edge_index;
    if ( t > z_now[1] ) {
      update_edge_index = 1;
    } else {
      if ( t < z_now[0] ) {
        update_edge_index = 0;
      } else {
        var dt0 = Math.abs(z_now[0] - t);
        var dt1 = Math.abs(z_now[1] - t);
        if ( dt0 < dt1 ) {
          update_edge_index = 0;
        } else {
          update_edge_index = 1;
        }
      }
    }

    // to avoid malformed entried
    this.d.metadata_update_zi(this.file.fid,
                              this.metadata_last_added_mid,
                              update_edge_index,
                              t
                             );
    this._tmetadata_boundary_fetch_gid_mid(this.selected_gid);
    this._tmetadata_group_gid_draw(this.selected_gid);
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_add_at_time = function(t) {
  var z = [ t ];
  if ( z[0] < 0 ) {
    z[0] = 0.0;
  }

  z[1] = z[0] + this.DEFAULT_TEMPORAL_SEG_LEN;
  if ( z[1] > this.m.duration ) {
    z[1] = this.m.duration;
  }

  z = _via_util_float_arr_to_fixed(z, 3);
  // avoid adding same overlapping segments
  if ( this.d.metadata_store.hasOwnProperty(this.metadata_last_added_mid) ) {
    var z0 = this.d.metadata_store[this.metadata_last_added_mid].z;
    if ( z0[0] === z[0] && z0[1] === z[1] ) {
      _via_util_msg_show('A temporal segment of same size already exists.');
      return;
    }
  }
  var fid = this.file.fid;
  var xy = [];
  var metadata = {};
  metadata[ this.groupby_aid ] = this.selected_gid;
  this.d.metadata_add(fid, z, xy, metadata).then( function(ok) {
    this.metadata_last_added_mid = ok.mid;
    this._tmetadata_group_gid_draw(this.selected_gid);
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to add metadata!');
    console.log(err);
  }.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_mid_merge = function(eindex) {
  var merge_mid;
  if ( eindex === 0 ) {
    var left_mindex = parseInt(this.selected_mindex) - 1;
    if ( left_mindex >= 0 ) {
      merge_mid = this.tmetadata_gtimeline_mid[this.selected_gid][left_mindex];
    }
  } else {
    var right_mindex = parseInt(this.selected_mindex) + 1;
    if (right_mindex < this.tmetadata_gtimeline_mid[this.selected_gid].length ) {
      merge_mid = this.tmetadata_gtimeline_mid[this.selected_gid][right_mindex];
    }
  }

  if ( typeof(merge_mid) !== 'undefined' ) {
    var new_z = this.d.metadata_store[this.selected_mid].z;
    if ( new_z[0] > this.d.metadata_store[merge_mid].z[0] ) {
      new_z[0] = this.d.metadata_store[merge_mid].z[0];
    }
    if ( new_z[1] < this.d.metadata_store[merge_mid].z[1] ) {
      new_z[1] = this.d.metadata_store[merge_mid].z[1];
    }

    this._tmetadata_mid_del(merge_mid);
    // while selected mid remains consistent, mindex changes due to deletion
    this.selected_mindex = this.tmetadata_gtimeline_mid[this.selected_gid].indexOf(this.selected_mid);
    this.d.metadata_update_z(this.file.fid, this.selected_mid, new_z);
    this._tmetadata_group_gid_draw(this.selected_gid);
    if ( eindex === 0 ) {
      this.m.currentTime = new_z[0];
    } else {
      this.m.currentTime = new_z[1];
    }
    _via_util_msg_show('Temporal segments merged.');
  } else {
    _via_util_msg_show('Merge is not possible without temporal segments in the neighbourhood');
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mousemove = function(e) {
  var x = e.offsetX;
  var gid = e.target.dataset.gid;
  var t = this._tmetadata_gtimeline_canvas2time(x);
  if ( this.metadata_resize_is_ongoing ) {
    this.m.currentTime = t;
    this.metadata_ongoing_update_x[ this.metadata_resize_edge_index ] = x;
    this._tmetadata_group_gid_draw(gid);
    return;
  }

  if ( this.metadata_move_is_ongoing ) {
    this.metadata_move_dx = x - this.metadata_move_start_x;
    this._tmetadata_group_gid_draw(gid);
    return;
  }


  var check = this._tmetadata_group_gid_is_on_edge(gid, t);
  if ( check[0] !== -1 ) {
    this.gcanvas[gid].style.cursor = 'ew-resize';
  } else {
    this.gcanvas[gid].style.cursor = 'default';
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mousedown = function(e) {
  var x = e.offsetX;
  var gid = e.target.dataset.gid;
  var gindex = e.target.dataset.gindex;
  var t = this._tmetadata_gtimeline_canvas2time(x);

  if ( gindex !== this.selected_gindex ) {
    // select this gid
    this._tmetadata_group_gid_sel(gindex);
  }

  var edge = this._tmetadata_group_gid_is_on_edge(gid, t);
  if ( edge[0] !== -1 ) {
    // mousedown was at the edge
    this.metadata_resize_is_ongoing = true;
    this._tmetadata_group_gid_sel_metadata(edge[0]);
    this.metadata_resize_edge_index = edge[1];
    var z = this.d.metadata_store[this.selected_mid].z;
    this.metadata_ongoing_update_x = [ this._tmetadata_gtimeline_time2canvas(z[0]),
                                       this._tmetadata_gtimeline_time2canvas(z[1])
                                     ];
  } else {
    var mindex = this._tmetadata_group_gid_get_mindex_at_time(gid, t);
    if ( mindex !== -1 ) {
      // clicked on a metadata
      if ( this.selected_mindex !== -1 &&
           mindex === this.selected_mindex
         ) {
        // clicked on an already selected metadata
        // hence, start moving
        this.metadata_move_start_x = x;
        this.metadata_move_is_ongoing = true;
        var z = this.d.metadata_store[this.selected_mid].z;
        this.metadata_ongoing_update_x = [ this._tmetadata_gtimeline_time2canvas(z[0]),
                                           this._tmetadata_gtimeline_time2canvas(z[1])
                                         ];
      } else {
        // else, select metadata
        this._tmetadata_group_gid_sel_metadata(mindex);
      }
    } else {
      if ( this.selected_mindex !== -1 ) {
        // remove metadata selection
        this._tmetadata_group_gid_remove_mid_sel(this.selected_mindex);
      }
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mouseup = function(e) {
  var x = e.offsetX;
  if ( this.metadata_resize_is_ongoing ) {
    // resize metadata
    var t = this._tmetadata_gtimeline_canvas2time(e.offsetX);
    var dz = t - this.d.metadata_store[this.selected_mid].z[this.metadata_resize_edge_index];
    this._tmetadata_mid_update_edge(this.metadata_resize_edge_index, dz);
    this.metadata_resize_is_ongoing = false;
    this.metadata_resize_edge_index = -1;
    this.metadata_ongoing_update_x = [0, 0];
    return;
  }

  if ( this.metadata_move_is_ongoing ) {
    var dx = x - this.metadata_move_start_x;
    if ( Math.abs(dx) > this.DRAW_LINE_WIDTH ) {
      var dt = dx / this.tmetadata_width_per_sec;
      this._tmetadata_mid_move(dt);
    }
    this.metadata_move_is_ongoing = false;
    this.metadata_ongoing_update_x = [0, 0];
    return;
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_is_on_edge = function(gid, t) {
  var mindex, mid;
  for ( mindex in this.tmetadata_gtimeline_mid[gid] ) {
    mid = this.tmetadata_gtimeline_mid[gid][mindex];
    if ( Math.abs(t - this.d.metadata_store[mid].z[0]) < this.METADATA_EDGE_TOL ) {
      return [parseInt(mindex), 0];
    } else {
      if ( Math.abs(t - this.d.metadata_store[mid].z[1]) < this.METADATA_EDGE_TOL ) {
        return [parseInt(mindex), 1];
      }
    }
  }
  return [-1, -1];
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_get_mindex_at_time = function(gid, t) {
  var mindex, mid;
  for ( mindex in this.tmetadata_gtimeline_mid[gid] ) {
    mid = this.tmetadata_gtimeline_mid[gid][mindex];
    if ( t >= this.d.metadata_store[mid].z[0] &&
         t <= this.d.metadata_store[mid].z[1]
       ) {
      return parseInt(mindex);
    }
  }
  return -1;
}

//
// keyboard input handler
//
_via_temporal_segmenter.prototype._on_event_keydown = function(e) {
  var fid = this.file.fid;

  // play/pause
  if ( e.key === ' ' ) {
    e.preventDefault();
    if ( this.m.paused ) {
      this.m.play();
      _via_util_msg_show('Playing ...');
    } else {
      this.m.pause();
      _via_util_msg_show('Paused. Press <span class="key">a</span> to add a temporal segment, ' +
                         '<span class="key">Tab</span> to select and ' +
                         '<span class="key">&uarr;</span>&nbsp;<span class="key">&darr;</span> to select speaker.', true);
    }
  }

  // jump 1,...,9 seconds forward or backward
  if ( ['1','2','3','4','5','6','7','8','9'].includes( e.key ) ) {
    if ( e.altKey ) {
      return; // Alt + Num is used to navigated browser tabs
    }
    e.preventDefault();
    var t = this.m.currentTime;
    if ( e.ctrlKey ) {
      t += parseInt(e.key);
    } else {
      t -= parseInt(e.key);
    }
    // clamp
    t = Math.max(0, Math.min(t, this.m.duration));
    this.m.pause();
    this.m.currentTime = t;
    return;
  }

  if ( e.key === 's' || e.key === 'S' ) {
    e.preventDefault();
    this.m.pause();
    if ( e.key === 's' ) {
      if ( this.selected_mindex !== -1 ) {
        this.m.currentTime = this.d.metadata_store[this.selected_mid].z[0];
      } else {
        this.m.currentTime = this.tmetadata_gtimeline_tstart;
      }
    } else {
      this.m.currentTime = 0;
    }
    return;
  }

  if ( e.key === 'e' || e.key === 'E' ) {
    e.preventDefault();
    this.m.pause();
    if ( e.key === 'e' ) {
      if ( this.selected_mindex !== -1 ) {
        this.m.currentTime = this.d.metadata_store[this.selected_mid].z[1];
      } else {
        this.m.currentTime = this.tmetadata_gtimeline_tend;
      }
    } else {
      this.m.currentTime = this.m.duration - 1;
    }
    return;
  }

  // change playback rate
  if ( e.key === '0' ) {
    e.preventDefault();
    this.m.playbackRate = 1;
    return;
  }
  if ( e.key === '+' ) {
    if ( ! e.ctrlKey ) {
      e.preventDefault();
      this.m.playbackRate = this.m.playbackRate + 0.1;
    }
    return;
  }
  if ( e.key === '-' ) {
    if ( ! e.ctrlKey ) {
      e.preventDefault();
      if ( this.m.playbackRate > 0.1 ) {
        this.m.playbackRate = this.m.playbackRate - 0.1;
      }
    }
    return;
  }

  if ( e.key === 'a' || e.key === 'A' ) {
    e.preventDefault();
    var t = this.m.currentTime;
    if ( e.key === 'a' ) {
      this._tmetadata_mid_add_at_time(t);
    } else {
      this._tmetadata_mid_update_last_added_end_edge_to_time(t);
    }
    return;
  }

  if ( e.key === 'Backspace' ) {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      this._tmetadata_mid_del_sel();
    }
    return;
  }

  if ( e.key === 'm' ) {
    e.preventDefault();
    if ( this.m.muted ) {
      this.m.muted = false;
    } else {
      this.m.muted = true;
    }
    return;
  }

  if ( e.key === 'l' || e.key === 'L') {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      // resize left edge of selected temporal segment
      var delta = this.EDGE_UPDATE_TIME_DELTA;
      if ( e.ctrlKey ) {
        delta = 1;
      }

      if ( e.key === 'l' ) {
        this._tmetadata_mid_update_edge(0, -delta);
      } else {
        this._tmetadata_mid_update_edge(0, delta);
      }
      return;
    } else {
      if ( e.key === 'l' ) {
        this.m.currentTime = this.m.currentTime - this.EDGE_UPDATE_TIME_DELTA;
      } else {
        this.m.currentTime = this.m.currentTime - 2*this.EDGE_UPDATE_TIME_DELTA;
      }
    }
  }

  if ( e.key === 'r' || e.key === 'R') {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      // resize left edge of selected temporal segment
      var delta = this.EDGE_UPDATE_TIME_DELTA;
      if ( e.ctrlKey ) {
        delta = 1;
      }

      if ( e.key === 'r' ) {
        this._tmetadata_mid_update_edge(1, delta);
      } else {
        this._tmetadata_mid_update_edge(1, -delta);
      }
      return;
    } else {
      if ( e.key === 'r' ) {
        this.m.currentTime = this.m.currentTime + this.EDGE_UPDATE_TIME_DELTA;
      } else {
        this.m.currentTime = this.m.currentTime + 2*this.EDGE_UPDATE_TIME_DELTA;
      }
    }
  }

  // cancel ongoing action or event
  if ( e.key === 'Escape' ) {
    e.preventDefault();

    // hide info panel
    _via_util_hide_info_page();

    this._tmetadata_group_gid_remove_mid_sel();

    return;
  }

  // select temporal segments
  if ( e.key === 'Tab' ) {
    e.preventDefault();

    if ( e.shiftKey ) {
      this._tmetadata_group_gid_sel_prev_metadata();
    } else {
      this._tmetadata_group_gid_sel_next_metadata();
    }
    return;
  }

  if ( e.key === 'Enter' ) {
    e.preventDefault();
    this.m.pause();
    this._tmetadata_group_gid_sel_metadata_at_time();
    return;
  }

  if ( e.key === 'ArrowDown' || e.key === 'ArrowUp' ) {
    // update the attribute being shown below each temporal segment
    e.preventDefault();
    var selected_gindex = this.gid_list.indexOf(this.selected_gid);
    var next_gindex;
    if ( e.key === 'ArrowDown' ) {
      next_gindex = selected_gindex + 1;
      if ( next_gindex >= this.gid_list.length ) {
        next_gindex = 0;
      }
    } else {
      next_gindex = selected_gindex - 1;
      if ( next_gindex < 0 ) {
        next_gindex = this.gid_list.length - 1;
      }
    }
    this._tmetadata_group_gid_sel(next_gindex);
    _via_util_msg_show('Selected group "' + this.selected_gid + '"');
  }

  if ( e.key === 'ArrowLeft' || e.key === 'ArrowRight' ) {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      if ( e.shiftKey ) {
        // merge current region with left or right metadata
        if ( e.key === 'ArrowLeft' ) {
          this._tmetadata_mid_merge(0);
        } else {
          this._tmetadata_mid_merge(1);
        }
      } else {
        // move selected temporal segment
        var delta = this.EDGE_UPDATE_TIME_DELTA;
        if ( e.ctrlKey ) {
          delta = 1.0;
        }

        if ( e.key === 'ArrowLeft' ) {
          this._tmetadata_mid_move(-delta);
        } else {
          this._tmetadata_mid_move(delta);
        }
      }
    } else {
      // move temporal seg. timeline
      var tstart_new;
      if ( e.key === 'ArrowLeft' ) {
        if ( e.shiftKey ) {
          this._tmetadata_boundary_move(-60*this.TEMPORAL_SEG_MOVE_OFFSET);
        } else {
          this._tmetadata_boundary_move(-this.TEMPORAL_SEG_MOVE_OFFSET);
        }
      } else {
        if ( e.shiftKey ) {
          this._tmetadata_boundary_move(60*this.TEMPORAL_SEG_MOVE_OFFSET);
        } else {
          this._tmetadata_boundary_move(this.TEMPORAL_SEG_MOVE_OFFSET);
        }
      }
    }
  }

  if ( e.key === 'F2' ) {
    e.preventDefault();
    _via_util_show_info_page('keyboard_shortcuts');
    return;
  }
}

//
// group by
//

_via_temporal_segmenter.prototype._group_init = function(aid) {
  this.group = {};
  this.groupby_aid = aid;

  var mid, mindex, avalue;
  for ( mindex in this.d.file_mid_store[this.file.fid] ) {
    mid = this.d.file_mid_store[this.file.fid][mindex];
    if ( this.d.metadata_store.hasOwnProperty(mid) ) {
      avalue = this.d.metadata_store[mid].v[aid];
      if ( ! this.group.hasOwnProperty(avalue) ) {
        this.group[avalue] = [];
      }
      this.group[avalue].push(mid);
    }
  }

  this.gid_list = Object.keys(this.group).sort();

  // add a default groups
  var gid;
  for ( var i in this.group_default_gid_list ) {
    gid = this.group_default_gid_list[i];
    if ( ! this.group.hasOwnProperty(gid) ) {
      this.group[gid] = [];
      this.gid_list.push(gid);
    }
  }

  // sort each group elements based on time
  var gid;
  for ( gid in this.group ) {
    this.group[gid].sort( this._compare_mid_by_time.bind(this) );
  }
}

_via_temporal_segmenter.prototype._compare_mid_by_time = function(mid1, mid2) {
  var t00 = this.d.metadata_store[mid1].z[0];
  var t10 = this.d.metadata_store[mid2].z[0];
  var t01 = this.d.metadata_store[mid1].z[1];
  var t11 = this.d.metadata_store[mid2].z[1];

  if ( typeof(t00) === 'string' ||
       typeof(t01) === 'string' ) {
    t00 = parseFloat(t00);
    t01 = parseFloat(t01);
    t10 = parseFloat(t10);
    t11 = parseFloat(t11);
  }

  if ( (t00 === t10) && ( t01 === t11 ) ) {
    return 0;
  }

  if ( ( t00 === t10 ) || ( t01 === t11 ) ) {
    var a,b;
    if ( ( t00 === t10 ) ) {
      // same start time
      a = t01;
      b = t11;
    } else {
      // same end time
      a = t00;
      b = t10;
    }
    if ( a < b ) {
      return -1;
    } else {
      return 1;
    }
  } else {
    if ( (t00 < t10) || ( t01 < t11 ) ) {
      return -1;
    } else {
      return 1;
    }
  }
}

_via_temporal_segmenter.prototype._group_gid_add_mid = function(gid, new_mid) {
  // find the best location
  var i, mindex, mid;
  for ( mindex in this.group[gid] ) {
    mid = this.group[gid][mindex];
    if ( this.d.metadata_store[new_mid].z[0] < this.d.metadata_store[mid].z[0] ) {
      this.group[gid].splice(mindex, 0, new_mid); // insert at correct location
      return;
    }
  }

  // if the insertion was not possible, simply push at the end
  this.group[gid].push(new_mid);
  this._tmetadata_group_gid_draw(gid);
}

_via_temporal_segmenter.prototype._group_gid_del_mid = function(gid, mid) {
  var mindex = this.group[gid].indexOf(mid);
  if ( mindex !== -1 ) {
    this.group[gid].splice(mindex, 1);
  }
  this._tmetadata_group_gid_draw(gid);
}

_via_temporal_segmenter.prototype._group_del_gid = function(gid) {
  if ( Object.keys(this.group).length === 1 ) {
    _via_util_msg_show('Cannot delete the last ' +
                       this.d.attribute_store[this.groupby_aid].aname + '!');
    return;
  }


  var mid_list = this.group[gid].slice();
  delete this.group[gid];
  delete this.tmetadata_gtimeline_mid[gid];
  var gindex = this.gid_list.indexOf(gid);
  this.gid_list.splice(gindex, 1);
  this._tmetadata_update();

  // remove selection
  var selected_gindex = this.gid_list.indexOf(this.selected_gid);
  var next_gindex = selected_gindex + 1;
  if ( next_gindex >= this.gid_list.length ) {
    next_gindex = 0;
  }
  this._tmetadata_group_gid_sel(next_gindex);

  // delete from store
  this.d.metadata_del_bulk(this.file.fid, mid_list);
  _via_util_msg_show('Deleted ' + this.d.attribute_store[this.groupby_aid].aname +
                     ' [' + gid + ']');
}

_via_temporal_segmenter.prototype._group_add_gid = function(gid) {
  if ( this.group.hasOwnProperty(gid) ) {
    _via_util_msg_show(this.d.attribute_store[this.groupby_aid].aname +
                       ' [' + gid + '] already exists!');
  } else {
    this.group[gid] = [];
    this.gid_list.push(gid);
    this.metadata_tbody.appendChild( this._tmetadata_group_gid_html(gid) );
    this.new_group_id_input.value = ''; // clear input field
    _via_util_msg_show('Add ' + this.d.attribute_store[this.groupby_aid].aname +
                       ' [' + gid + ']');
  }
}

//
// Utility functions
//
_via_temporal_segmenter.prototype._time2str = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.round( t - hh*3600 - mm*60 );
  if ( hh < 10 ) {
    hh = '0' + hh;
  }
  if ( mm < 10 ) {
    mm = '0' + mm;
  }
  if ( ss < 10 ) {
    ss = '0' + ss;
  }
  return hh + ':' + mm + ':' + ss;
}

_via_temporal_segmenter.prototype._time2strms = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.floor( t - hh*3600 - mm*60 );
  var ms = Math.floor( (t - Math.floor(t) ) * 1000 );
  if ( hh < 10 ) {
    hh = '0' + hh;
  }
  if ( mm < 10 ) {
    mm = '0' + mm;
  }
  if ( ss < 10 ) {
    ss = '0' + ss;
  }
  if ( ms < 100 ) {
    ms = '0' + ms;
  }
  return hh + ':' + mm + ':' + ss + '.' + ms;
}

_via_temporal_segmenter.prototype._time2ssms = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.floor( t - hh*3600 - mm*60 );
  var ms = Math.floor( (t - Math.floor(t) ) * 1000 );
  return ss + ':' + ms;
}

_via_temporal_segmenter.prototype._vtimeline_playbackrate2str = function(t) {
  return this.m.playbackRate + 'X';
}

//
// external events
//
_via_temporal_segmenter.prototype._on_event_metadata_del = function(fid, mid) {
  _via_util_msg_show('Metadata deleted');
}

_via_temporal_segmenter.prototype._on_event_metadata_add = function(fid, mid) {
  this._group_gid_add_mid(this.selected_gid, mid); // add at correct location
  this._tmetadata_boundary_fetch_gid_mid(this.selected_gid);
  _via_util_msg_show('Metadata added');
}

//
// Toolbar
//
_via_temporal_segmenter.prototype._toolbar_init = function() {
  var toolbar_container = document.createElement('div');
  toolbar_container.setAttribute('class', 'toolbar_container');

  var pb_mode_container = document.createElement('div');
  var pb_mode_label = document.createElement('span');
  pb_mode_label.innerHTML = 'Playback Mode:';
  pb_mode_container.appendChild(pb_mode_label);

  var pb_normal = document.createElement('input');
  pb_normal.setAttribute('type', 'radio');
  pb_normal.setAttribute('id', 'playback_mode_normal');
  pb_normal.setAttribute('name', 'via_temporal_segmenter_playback_mode');
  pb_normal.setAttribute('value', this.PLAYBACK_MODE.NORMAL);
  pb_normal.setAttribute('checked', '');
  pb_normal.addEventListener('change', this._toolbar_playback_mode_on_change.bind(this));
  pb_mode_container.appendChild(pb_normal);
  var pb_normal_label = document.createElement('label');
  pb_normal_label.setAttribute('for', 'playback_mode_normal');
  pb_normal_label.innerHTML = 'Normal';
  pb_mode_container.appendChild(pb_normal_label);

  var pb_review = document.createElement('input');
  pb_review.setAttribute('type', 'radio');
  pb_review.setAttribute('id', 'playback_mode_review_segment');
  pb_review.setAttribute('name', 'via_temporal_segmenter_playback_mode');
  pb_review.setAttribute('value', this.PLAYBACK_MODE.REVIEW_SEGMENT);
  pb_review.addEventListener('change', this._toolbar_playback_mode_on_change.bind(this));
  pb_mode_container.appendChild(pb_review);
  var pb_review_label = document.createElement('label');
  pb_review_label.setAttribute('for', 'playback_mode_review_segment');
  pb_review_label.innerHTML = 'Review Segments';
  pb_mode_container.appendChild(pb_review_label);

  var pb_annotation = document.createElement('input');
  pb_annotation.setAttribute('type', 'radio');
  pb_annotation.setAttribute('id', 'playback_mode_review_gap');
  pb_annotation.setAttribute('name', 'via_temporal_segmenter_playback_mode');
  pb_annotation.setAttribute('value', this.PLAYBACK_MODE.REVIEW_GAP);
  pb_annotation.addEventListener('change', this._toolbar_playback_mode_on_change.bind(this));
  pb_mode_container.appendChild(pb_annotation);
  var pb_annotation_label = document.createElement('label');
  pb_annotation_label.setAttribute('for', 'playback_mode_review_gap');
  pb_annotation_label.innerHTML = 'Review Gaps';
  pb_mode_container.appendChild(pb_annotation_label);

  var control_container = document.createElement('div');
  var delbtn = document.createElement('button');
  delbtn.setAttribute('data-gid', this.selected_gid);
  delbtn.innerHTML = 'Delete Selected ' + this.d.attribute_store[this.groupby_aid].aname;
  delbtn.addEventListener('click', function(e) {
    e.preventDefault();
    this._group_del_gid(this.selected_gid);
  }.bind(this));

  this.new_group_id_input = document.createElement('input');
  this.new_group_id_input.setAttribute('type', 'text');
  this.new_group_id_input.setAttribute('size', '16');
  this.new_group_id_input.setAttribute('placeholder', 'New Speaker Name');

  var addbtn = document.createElement('button');
  addbtn.setAttribute('data-gid', this.selected_gid);
  addbtn.innerHTML = 'Add ' + this.d.attribute_store[this.groupby_aid].aname;
  addbtn.addEventListener('click', function(e) {
    var new_gid = this.new_group_id_input.value;
    if ( new_gid !== '' ) {
      this._group_add_gid(new_gid.trim());
    } else {
      _via_util_msg_show(this.d.attribute_store[this.groupby_aid].aname +
                         ' id cannot be empty!');
    }
  }.bind(this));

  control_container.appendChild(this.new_group_id_input);
  control_container.appendChild(addbtn);
  control_container.appendChild(delbtn);

  toolbar_container.appendChild(pb_mode_container);
  toolbar_container.appendChild(control_container);

  this.c.appendChild(toolbar_container);
}

_via_temporal_segmenter.prototype._toolbar_playback_mode_on_change = function(e) {
  e.preventDefault();
  this.current_playback_mode = e.target.value;
  if ( this.current_playback_mode === this.PLAYBACK_MODE.NORMAL ) {
    this._toolbar_playback_rate_set(1);
  }
}

_via_temporal_segmenter.prototype._toolbar_playback_rate_set = function(rate) {
  if ( this.m.playbackRate !== rate ) {
    this.m.playbackRate = rate;
  }
}
</script>
<!-- End of file: js/_via_temporal_segmenter.js-->
<!-- Start of file: js/_via_annotator.js-->
<script>
/**
 * Builds user interface and control handlers to allow
 * annotation of a file (image, video or audio)

 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 24 Dec. 2018
 *
 */

'use strict';

function _via_annotator(annotator_container, data) {
  // everything will be added to this contained
  this.c = annotator_container;
  this.d = data;

  this.file = {};
  this.region_annotator = {};
  this.file_container = {};

  this.neighbour_preload_promise_list = [];
  this.neighbour_preload_fid_list = {};

  this.PRELOAD_CACHE_SIZE = 3; // keep this many media always ready
  this.PRELOAD_NBD_SIZE = 2;
  this.PRELOAD_NBD_INDEX_LIST = [1, -1, 2, 3, -2, 4, 5, 6]; // 1 => next image, -1 => previous image

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this.event_prefix = '_via_annotator_';
  _via_event.call( this );

  this.on_event('container_resize', this._on_event_container_resize.bind(this));
  this.d.on_event('file_remove', this._on_event_file_remove.bind(this));
  this.d.on_event('attribute_del', this._on_event_attribute_del.bind(this));
  this.d.on_event('attribute_add', this._on_event_attribute_add.bind(this));
  this.d.on_event('metadata_add', this._on_event_metadata_add.bind(this));
  this.d.on_event('metadata_add_bulk', this._on_event_metadata_add_bulk.bind(this));
  this.d.on_event('metadata_del', this._on_event_metadata_del.bind(this));
  this.d.on_event('metadata_update', this._on_event_metadata_update.bind(this));
  this.d.on_event('project_load', this._on_event_project_load.bind(this));
}

_via_annotator.prototype.annotate_fid = function(fid) {
  //console.log('annotate_fid(): fid=' + fid);
  // check if file has already been loaded
  if ( fid in this.file_container ) {

    // remove any previously visible files
    if ( this.file.fid && fid !== this.file.fid ) {
      if ( this.file_container.hasOwnProperty(this.file.fid) ) {
        this._file_container_hide(this.file.fid);
      }
    }

    this.file = this.d.file_store[fid];
    this._file_container_show(fid);
    this.region_annotator[fid]._on_event_show();
    this.emit_event('file_show', this.file);

    /* // disable preload to avoid overloading a browser
    // trigger preload of neighbours
    Promise.all(this.neighbour_preload_promise_list).then( function(ok) {
      this._preload_limit_overflow();
      this._preload_neighbours();
    }.bind(this), function(err) {
      this.neighbour_preload_promise_list = [];
      this.neighbour_preload_fid_list = {};
    }.bind(this));
    */
  } else {
    // we first need to preload this file
    this._preload_fid(fid).then( function(ok_fid) {
      this.annotate_fid(ok_fid);
    }.bind(this), function(err_fid) {
      _via_util_msg_show('Failed to load media + [' + this.d.file_store[err_fid].filename + ']');
      // show blank page to allow move to next/prev media
      if ( this.file.fid ) {
        this._file_container_hide(this.file.fid);
      }
      this.file = this.d.file_store[fid];
      this._file_container_show(fid);

      this.emit_event('file_show', this.file);
      console.log('Failed to preload file');
    }.bind(this));
  }
}

_via_annotator.prototype._file_container_init = function(fid) {
  var fc = document.createElement('div');
  fc.classList.add('file_container');
  fc.setAttribute('data-fid', fid);
  return fc;
}

_via_annotator.prototype._file_container_hide = function(fid) {
  if ( this.file_container[fid].classList.contains('file_show') ) {
    this.file_container[fid].classList.remove('file_show');
    this._preload_del(fid);
  }
}

_via_annotator.prototype._file_container_show = function(fid) {
  this.file_container[fid].classList.add('file_show');
  this.file_container[fid].style.height = this.c.clientHeight + 'px';
  this.file_container[fid].style.width = this.c.clientWidth + 'px';

  this.c.appendChild(this.file_container[fid]);
}

//
// Preload
//
_via_annotator.prototype._preload_fid = function(fid) {
  return new Promise( function(ok_callback, err_callback) {
    this.file_container[fid] = this._file_container_init(fid);
    this.c.appendChild(this.file_container[fid]);
    try {
      this.region_annotator[fid] = new _via_region_annotator(this.file_container[fid],
                                                             this.d.file_store[fid],
                                                             this.d
                                                            );
      ok_callback(fid);
    }
    catch(e) {
      err_callback(fid);
    }
  }.bind(this));
}

_via_annotator.prototype._preload_del = function(fid) {
  //console.log('_preload_del() : fid=' + fid);
  if ( fid in this.file_container ) {
    if ( this.file_container[fid].classList.contains('file_show') ) {
      this.file_container[fid].classList.remove('file_show');
    }
    delete this.file_container[fid];

    if ( this.region_annotator[fid] ) {
      this.region_annotator[fid]._on_event_destroy();
      delete this.region_annotator[fid];
    }

    // remove node from HTML DOM( i.e. view)
    var child_index;
    for ( child_index in this.c.childNodes ) {
      if ( this.c.childNodes[child_index].dataset.fid === fid ) {
        this.c.removeChild(this.c.childNodes[child_index]);
        break;
      }
    }
  }
}

_via_annotator.prototype._preload_limit_overflow = function(fid) {
  var preload_size = Object.keys(this.file_container).length;
  if ( preload_size > this.PRELOAD_CACHE_SIZE ) {
    console.log('_preload_limit_overflow(): containing overflow ' + preload_size + ':' + this.PRELOAD_CACHE_SIZE);
    var to_remove = preload_size - this.PRELOAD_CACHE_SIZE;
    var i, furthest_fid;
    for ( i = 0; i < to_remove; ++i ) {
      furthest_fid = this._preload_get_furthest_fid();
      this._preload_del(furthest_fid);
    }
  } else {
    //console.log('_preload_limit_overflow(): no overflow yet');
  }
}

_via_annotator.prototype._preload_get_furthest_fid = function() {
  var now_findex = this.d.fid_list.indexOf(this.file.fid);
  var furthest_fid = -1;
  if ( now_findex !== -1 ) {
    var fid, findex, dist, dist1, dist2;
    var max_dist = 0;
    for ( fid in this.file_container ) {
      if ( fid !== this.file.fid ) { // we do not want to remove current file
        findex = this.d.fid_list.indexOf(fid);
        dist1 = Math.abs(findex - now_findex);
        dist2 = this.d.fid_list.length - dist1;
        dist = Math.min(dist1, dist2);

        if ( dist > max_dist ) {
          max_dist = dist;
          furthest_fid = fid;
        }
      }
    }
  }
  return furthest_fid;
}

_via_annotator.prototype._preload_get_neighbours_fid = function(fid) {
  var n = this.d.fid_list.length;
  var findex = this.d.fid_list.indexOf(fid);

  var nbd_fid_list = [];
  var i, nbd_findex, nbd_fid;
  for ( i = 0; i < this.PRELOAD_NBD_SIZE; ++i ) {
    nbd_findex = findex + this.PRELOAD_NBD_INDEX_LIST[i];
    if ( nbd_findex < 0 ||
         nbd_findex >= n ) {
      if ( nbd_findex < 0 ) {
        nbd_findex = n + nbd_findex;
      } else {
        nbd_findex = nbd_findex - n;
      }
    }
    //console.log(i + ':' + nbd_findex+':' + this.d.fid_list[nbd_findex]);
    nbd_fid = this.d.fid_list[nbd_findex];
    nbd_fid_list.push(nbd_fid);
  }
  return nbd_fid_list;
}

_via_annotator.prototype._preload_neighbours = function() {
  this.neighbour_preload_promise_list = [];
  this.neighbour_preload_fid_list = [];
  var fid = this.file.fid;

  var nbd_fid_list = this._preload_get_neighbours_fid(fid);
  var nbd_length = nbd_fid_list.length;
  var i, nbd_fid;
  for ( i = 0; i < nbd_length; ++i ) {
    nbd_fid = nbd_fid_list[i];
    //console.log(nbd_fid + ':' + typeof(nbd_fid) + ':' + (this.file_container.hasOwnProperty(nbd_fid)) + ':' + Object.keys(this.file_container))
    if ( ! (nbd_fid in this.file_container) ) {
      this.neighbour_preload_fid_list.push(nbd_fid);
      this.neighbour_preload_promise_list.push( this._preload_fid(nbd_fid) );
    }
  }
  //console.log('_preload_neighbours() : ' + JSON.stringify(this.neighbour_preload_fid_list));
}

//
// External events
//
_via_annotator.prototype._on_event_project_load = function(data, event_payload) {
  if ( this.file.fid ) {
    this._preload_del(this.file.fid);
  }

  if ( this.d.fid_list.length ) {
    this.annotate_fid( this.d.fid_list[0] );
  }
}

_via_annotator.prototype._on_event_container_resize = function(data, event_payload) {
  if ( this.file.fid ) {
    this._preload_del(this.file.fid);
    this.annotate_fid(this.file.fid);
  }
}

_via_annotator.prototype._on_event_file_remove = function(data, event_payload) {
}

_via_annotator.prototype._on_event_attribute_del = function(data, event_payload) {
}

_via_annotator.prototype._on_event_attribute_add = function(data, event_payload) {
}

_via_annotator.prototype._on_event_metadata_add = function(data, event_payload) {
  var fid = event_payload.fid;
  var mid = event_payload.mid;

  if ( this.file.fid ) {
    if ( this.region_annotator[this.file.fid] ) {
      this.region_annotator[this.file.fid]._on_event_metadata_add(fid,mid);
    }
  }
}

_via_annotator.prototype._on_event_metadata_add_bulk = function(data, event_payload) {
}

_via_annotator.prototype._on_event_metadata_del = function(data, event_payload) {
}

_via_annotator.prototype._on_event_metadata_update = function(data, event_payload) {
}

//
// keyboard input handler
//
_via_annotator.prototype._on_event_keydown = function(e) {
  if ( this.file.fid ) {
    if ( this.region_annotator[this.file.fid] ) {
      if ( this.region_annotator[this.file.fid].temporal_segmenter ) {
        this.region_annotator[this.file.fid].temporal_segmenter._on_event_keydown(e);
      }
    }
  }
}
</script>
<!-- End of file: js/_via_annotator.js-->

<!-- Start of file: js/_via_file_manager.js-->
<script>
/**
 *
 * @class
 * @classdesc File manager
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 30 Jan. 2019
 *
 */

'use strict';

function _via_file_manager(data, annotator, filelist_element, project_name_element, project_rev_selector) {
  this.d = data;
  this.a = annotator;
  this.filelist = filelist_element;
  this.project_name_element = project_name_element;
  this.project_rev_selector = project_rev_selector;

  var is_filelist_regex_active = false;
  this.filelist_fid_list = [];

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this.event_prefix = '_via_file_manager_';
  _via_event.call( this );

  // attach event listeners
  this.a.on_event('file_show', this._on_event_file_show.bind(this));
  this.d.on_event('file_remove', this._on_event_file_remove.bind(this));
  this.d.on_event('file_add', this._on_event_file_add.bind(this));
  this.d.on_event('file_add_bulk', this._on_event_file_add_bulk.bind(this));
  this.d.on_event('project_load', this._on_event_project_load.bind(this));

  this.filelist.addEventListener('change', this._filelist_switch_to_file.bind(this));
}

_via_file_manager.prototype._init = function() {
  this.project_name_element.innerHTML = "Video: " + this.d.project_store.project_name;
  if ( typeof(this.d.couchdb_id) !== 'undefined' &&
       this.project_rev_selector
     ) {
    this.project_rev_selector.innerHTML = '';
    this._project_revs_info_fetch();
  }

  // trigger update of filelist (for the first time)
  this._filelist_update();
}

_via_file_manager.prototype._project_revs_info_fetch = function() {
  var project_uri = _VIA_PROJECT_DS_URI + this.d.project_store.project_id + '?revs_info=true';
  _via_util_remote_get(project_uri).then( function(file_content) {
    try {
      var project_data = JSON.parse(file_content);
      this.d.couchdb_revs_info = project_data['_revs_info'];
      this.d.couchdb_update_history = project_data['project_store']['update_history'];
      this._project_rev_update();
    }
    catch(err) {
      _via_util_msg_show('Failed to parse project revisions [' + project_id + '] from malformed json data!', true);
      console.log(err)
    }
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to load project revisions [' + project_id + ']', true);
  }.bind(this));

}

_via_file_manager.prototype._project_rev_update = function() {
  if ( typeof(this.d.couchdb_revs_info) === 'undefined' ) {
    this.project_rev_selector.setAttribute('title', 'Past versions of this project not available!');
    return;
  } else {
    this.project_rev_selector.setAttribute('title', 'Past revision of this project.');
    this.project_rev_selector.setAttribute('style', 'width:24em;');
  }

  this.project_rev_selector.innerHTML = '';
  var options_count = 0;
  for ( var revindex in this.d.couchdb_revs_info ) {
    if ( this.d.couchdb_revs_info[revindex].status === 'available' ) {
      var oi = document.createElement('option');
      var revid = this.d.couchdb_revs_info[revindex]['rev'];
      var author = this._project_rev_find_author(revid);

      oi.setAttribute('data-rev', revid);
      oi.setAttribute('data-id', this.d.project_store.project_id);
      if ( author !== '' ) {
        if ( revindex === '0' ) {
          oi.innerHTML = author + ' (latest)';
        } else {
          oi.innerHTML = author;
        }
        if ( revid === this.d.couchdb_rev ) {
          oi.setAttribute('selected', 'true');
        }

        this.project_rev_selector.appendChild(oi);
        options_count = options_count + 1;
      }
    }
  }

  if ( options_count ) {
    this.project_rev_selector.addEventListener('change', function(e) {
      var id = e.target.options[e.target.selectedIndex].dataset['id'];
      var rev = e.target.options[e.target.selectedIndex].dataset['rev'];
      _via_project_load_remote(id, rev);
    }.bind(this));
  }
}

_via_file_manager.prototype._project_rev_find_author = function(revid) {
  var prev_revid = '';
  for ( var revindex in this.d.couchdb_revs_info ) {
    if ( this.d.couchdb_revs_info[revindex]['rev'] === revid ) {
      var next_index = parseInt(revindex) + 1;
      if ( this.d.couchdb_revs_info.hasOwnProperty(next_index) ) {
        prev_revid = this.d.couchdb_revs_info[next_index]['rev'];
        break;
      }
    }
  }
  if ( prev_revid === '' ) {
    return '';
  }

  for ( var i in this.d.couchdb_update_history ) {
    var tokens = this.d.couchdb_update_history[i].split(',');
    if ( prev_revid === tokens[3] ) {
      return tokens[2] + ' : ' + tokens[0];
    }
  }
  return '';
}

_via_file_manager.prototype._filelist_clear = function() {
  this.filelist.innerHTML = '';
  this.filelist_fid_list = [];
}

_via_file_manager.prototype._filelist_html_element = function(findex, fid) {
  var oi = document.createElement('option');
  if ( this.d.file_is_fid_valid(fid) ) {
    var oi = document.createElement('option');
    oi.setAttribute('data-fid', fid);
    oi.setAttribute('value', fid);
    oi.setAttribute('title', decodeURI(this.d.file_store[fid].src));
    oi.innerHTML = '[' + (parseInt(findex)+1) + '] ' + decodeURI(this.d.file_store[fid].filename);
  } else {
    console.log('_via_file_manager._filelist_html_element() : not found fid=' + fid);
  }
  return oi;
}

_via_file_manager.prototype._filelist_update = function() {
  if ( this.is_filelist_regex_active ) {
    this._filelist_update_regex();
  } else {
    this._filelist_update_showall();
  }
}

_via_file_manager.prototype._filelist_update_regex = function(regex) {
  if ( regex === '' ||
       typeof(regex) === 'undefined'
     ) {
    this._filelist_update_showall();
  } else {
    this._filelist_clear();
    var i, uri;
    var fid, uri, src;
    var findex;
    for ( findex in this.d.fid_list ) {
      fid = this.d.fid_list[findex];
      src = this.d.file_store[fid].src;
      if ( src.match(regex) !== null ) {
        this.filelist.appendChild( this._filelist_html_element(findex, fid) );
        this.filelist_fid_list.push(fid);
      }
    }
    this.is_filelist_regex_active = true;
  }
}

_via_file_manager.prototype._filelist_update_showall = function() {
  this._filelist_clear();
  var fid;
  var findex;
  for ( findex in this.d.fid_list ) {
    fid = this.d.fid_list[findex];
    this.filelist.appendChild( this._filelist_html_element(findex, fid) );
    this.filelist_fid_list.push(fid);
  }
  this._filelist_set_selected_to_current_file();
  this.is_filelist_regex_active = false;
}

_via_file_manager.prototype._filelist_set_selected_to_current_file = function() {
  if ( typeof(this.a.file) !== 'undefined' ) {
    var n = this.filelist.options.length;
    var i;
    for ( i = 0; i < n; ++i ) {
      if ( this.filelist.options[i].dataset.fid == this.a.file.fid ) {
        this.filelist.selectedIndex = i;
        //this.filelist.title = this.d.file_store[ this.a.file.fid.toString() ].src;
      }
    }
  }
}

_via_file_manager.prototype._filelist_switch_to_file = function() {
  var fid = this.filelist.options[this.filelist.selectedIndex].dataset.fid;
  console.log('_via_file_manager(): triggering annotated_fid() fid='+fid);
  this.a.annotate_fid(fid);
}

//
// File Selector and Readers
//
_via_file_manager.prototype._file_add_local_video = function(e) {
  var files = e.target.files;
  var n = files.length;
  var i;
  var filelist = [];
  for ( i = 0; i < n; ++i ) {
    if ( files[i].type.startsWith('video') ) {
      filelist.push( {
        'filename':files[i].name,
        'type':_VIA_FILE_TYPE.VIDEO,
        'loc':_VIA_FILE_LOC.LOCAL,
        'src':files[i],
      });
    }
  }

  if ( filelist.length ) {
    var added_fid_list = this.d.file_add_bulk(filelist);
    console.log(added_fid_list);
  }
}

_via_file_manager.prototype._file_add_bulk_from_text_file = function(e) {
  _via_util_load_text_file(e.target.files[0], this._file_add_bulk.bind(this));
}

_via_file_manager.prototype._file_add_bulk = function(data) {
  if ( data === '' || typeof(data) === 'undefined') {
    console.log('_via_file_manager._file_add_bulk() failed as data=' + data);
    return;
  }

  var line_split_regex = new RegExp('\n|\r|\r\n', 'g');
  var csvdata = data.split(line_split_regex);
  var n = csvdata.length;
  if ( n > 0 ) {
    var i, fid, first_fid;
    var filelist = [];
    for ( i=0; i < n; ++i ) {
      // ignore blank lines
      if (csvdata[i].charAt(0) === '\n' || csvdata[i].charAt(0) === '') {
        continue;
      } else {
        filelist.push( {
          'filename': _via_util_get_filename_from_uri(csvdata[i]),
          'type': _via_util_infer_file_type_from_filename(csvdata[i]),
          'loc':  _via_util_infer_file_loc_from_filename(csvdata[i]),
          'src':  csvdata[i],
        });
      }
    }
  }

  if ( filelist.length ) {
    var added_fid_list = this.d.file_add_bulk(filelist);
  }
}

//
// Events and actions
//
_via_file_manager.prototype.on_file_select_local_video = function() {
  _via_util_file_select_local(_VIA_FILE_TYPE.VIDEO, this._file_add_local_video.bind(this));
}

_via_file_manager.prototype.on_file_bulk_add_uri = function() {
  _via_util_file_select_local(_VIA_FILE_TYPE.TEXT, this._file_add_bulk_from_text_file.bind(this), false);
}

_via_file_manager.prototype.on_filelist_regex = function(el) {
  this._filelist_update_regex(el.value);
}

_via_file_manager.prototype.on_file_show_next = function() {
  if ( this.d.fid_list.length &&
       this.filelist_fid_list.length // to account for filelist update made by regex
     ) {
    var index_now = this.filelist_fid_list.indexOf(this.a.file.fid);
    if ( index_now !== -1 ) {
      var index_next = index_now + 1;
      if ( index_next >= this.filelist_fid_list.length ) {
        index_next = 0;

      }
      this.a.annotate_fid( this.filelist_fid_list[index_next] );
    } else {
      // show the first file in the regex list
      this.a.annotate_fid( this.filelist_fid_list[0] );
    }
  }
}

_via_file_manager.prototype.on_file_show_prev = function() {
  if ( this.d.fid_list.length &&
       this.filelist_fid_list.length // to account for filelist update made by regex
     ) {
    var index_now = this.filelist_fid_list.indexOf(this.a.file.fid);

    if ( index_now !== -1 ) {
      var index_prev = index_now - 1;
      if ( index_prev < 0 ) {
        index_prev = this.filelist_fid_list.length - 1;
      }
      this.a.annotate_fid( this.filelist_fid_list[index_prev] );
    } else {
      // show the last file in the regex list
      this.a.annotate_fid( this.filelist_fid_list[ this.filelist_fid_list.length - 1 ] );
    }
  }
}

_via_file_manager.prototype.on_file_remove_current = function() {
  if ( this.d.fid_list.length ) {
    var index_now = this.filelist_fid_list.indexOf(this.a.file.fid);
    if ( index_now !== -1 ) {
      this.d.file_remove( this.filelist_fid_list[index_now] );
    }
  }
}

_via_file_manager.prototype._on_event_file_show = function(data, event_payload) {
  this._filelist_set_selected_to_current_file();
}

_via_file_manager.prototype._on_event_file_remove = function(data, event_payload) {
  var fid = event_payload.fid;
  var index_now = this.filelist_fid_list.indexOf(this.a.file.fid);
  this._filelist_update();

  if ( fid === this.a.file.fid ) {
    var move_to = index_now - 1;
    if ( move_to < 0 ) {
      move_to = index_now + 1;
      if ( move_to >= this.filelist_fid_list.length ) {
        // no move possible
        this.a.file_show_none();
      } else {
        var new_fid = this.filelist_fid_list[ move_to ];
        this.a.annotate_fid( new_fid );
      }
    } else {
      var new_fid = this.filelist_fid_list[ move_to ];
      this.a.annotate_fid( new_fid );
    }
  }
}

_via_file_manager.prototype._on_event_file_add = function(data, event_payload) {
  this._filelist_update();
  this.a.annotate_fid( event_payload.fid );
}

_via_file_manager.prototype._on_event_file_add_bulk = function(data, event_payload) {
  this._filelist_update();
  var first_added_fid = event_payload.fid_list[0];
  this.a.annotate_fid( first_added_fid );
}

_via_file_manager.prototype._on_event_project_load = function(data, event_payload) {
  this._init();
}
</script>
<!-- End of file: js/_via_file_manager.js-->

<!-- Start of file: js/_via_editor.js-->
<script>
/**
 * @class
 * @classdesc Editor for metadata and attributes
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 14 Jan. 2019
 */
function _via_editor(container, data, annotator) {
  this.c = container;
  this.d = data;
  this.a = annotator;

  this.now = {};

  if ( typeof(this.c.innerHTML) === 'undefined' ) {
    throw 'invalid html container or media element!';
  }

  this.init();

  // initialise event listeners
  this.d.on_event('file_show', this.on_event_file_show.bind(this));
  this.d.on_event('metadata_add', this.on_event_metadata_add.bind(this));
  this.d.on_event('metadata_del', this.on_event_metadata_del.bind(this));
  this.d.on_event('attribute_update', this.on_event_attribute_update.bind(this));
  this.d.on_event('attribute_del', this.on_event_attribute_del.bind(this));
  this.d.on_event('attribute_add', this.on_event_attribute_add.bind(this));
}

_via_editor.prototype.TYPE = { 'METADATA':2, 'ATTRIBUTE':3 };

_via_editor.prototype.init = function() {
  // top line: editor content selector {metadata, attribute}
  this.editor_content_selector = document.createElement('div');
  this.editor_content_selector.setAttribute('class', 'editor_content_selector');
  var title = document.createElement('span');
  title.innerHTML = 'Show: ';
  this.edit_metadata_checkbox = document.createElement('input');
  this.edit_metadata_checkbox.setAttribute('name', 'metadata');
  this.edit_metadata_checkbox.setAttribute('type', 'checkbox');
  this.edit_metadata_checkbox.addEventListener('change', this.on_editor_content_select.bind(this));
  var edit_metadata_label = document.createElement('label');
  edit_metadata_label.innerHTML = 'Metadata';
  edit_metadata_label.setAttribute('for', 'metadata');
  edit_metadata_label.setAttribute('title', 'Metadata corresponds to values assigned by user for the attributes.');

  this.edit_attribute_checkbox = document.createElement('input');
  this.edit_attribute_checkbox.setAttribute('name', 'attribute');
  this.edit_attribute_checkbox.setAttribute('type', 'checkbox');
  this.edit_attribute_checkbox.addEventListener('change', this.on_editor_content_select.bind(this));
  var edit_attribute_label = document.createElement('label');
  edit_attribute_label.innerHTML = 'Attribute';
  edit_attribute_label.setAttribute('for', 'attribute');
  edit_attribute_label.setAttribute('title', 'Attribute corresponds to fields like name, color, etc. required to describe the region of interest');

  this.editor_content_selector.appendChild(title);
  this.editor_content_selector.appendChild(this.edit_metadata_checkbox);
  this.editor_content_selector.appendChild(edit_metadata_label);
  this.editor_content_selector.appendChild(this.edit_attribute_checkbox);
  this.editor_content_selector.appendChild(edit_attribute_label);

  // metadata
  this.metadata_container = document.createElement('div');
  this.metadata_container.setAttribute('id', 'metadata_container');
  this.metadata_container.setAttribute('class', 'metadata_container');
  this.metadata_view = document.createElement('table');
  var metadata_title = document.createElement('h2');
  metadata_title.innerHTML = 'Metadata';
  this.metadata_container.appendChild( metadata_title );
  this.metadata_container.appendChild( this.metadata_view );

  // attribute
  this.attribute_container = document.createElement('div');
  this.attribute_container.setAttribute('id', 'attribute_container');
  this.attribute_container.setAttribute('class', 'attribute_container');
  this.attribute_view = document.createElement('table');
  var attribute_title = document.createElement('h2');
  attribute_title.innerHTML = 'Attributes';

  this.attribute_container.appendChild( attribute_title );
  this.attribute_container.appendChild( this.get_attribute_name_entry_panel() );
  this.attribute_container.appendChild( this.attribute_view );

  this.content_container = document.createElement('div');
  this.content_container.setAttribute('class', 'content_container');
  this.content_container.appendChild(this.metadata_container);
  this.content_container.appendChild(this.attribute_container);

  // add everything to container
  this.c.appendChild(this.editor_content_selector);
  this.c.appendChild(this.content_container);

  this.metadata_update();
  this.attributes_update();

  // initial state of content
  this.edit_metadata_checkbox.checked = true;
  this.metadata_container.classList.remove('hide');
  this.edit_attribute_checkbox.checked = false;
  this.attribute_container.classList.add('hide');
}

//
// Editor content selector
//
_via_editor.prototype.on_editor_content_select = function(selector) {
  var element;
  switch(selector.target.name) {
  case 'metadata':
    element = this.metadata_container;
    break;
  case 'attribute':
    element = this.attribute_container;
    break;
  }

  if ( selector.target.checked ) {
    element.classList.remove('hide');
  } else {
    element.classList.add('hide');
  }
}

//
// metadata
//
_via_editor.prototype.metadata_clear = function() {
  this.metadata_view.innerHTML = '';
}

_via_editor.prototype.metadata_update = function() {
  this.metadata_clear();

  if ( this.a.now.file ) {
    var fid = this.a.now.file.fid;
    if ( typeof(this.d.metadata_store[fid]) === 'undefined' ) {
      return;
    }

    var metadata_count = Object.keys(this.d.metadata_store[fid]).length;
    if ( metadata_count ) {
      // add header
      this.metadata_view.appendChild( this.get_metadata_header() );

      // add each metadata
      var tbody = document.createElement('tbody');
      var metadata_index = 1;
      var mid;
      for ( mid in this.d.metadata_store[fid] ) {
        tbody.appendChild( this.metadata_get(fid, mid, metadata_index) );
        metadata_index = metadata_index + 1;
      }
      this.metadata_view.appendChild(tbody);
    } else {
      this.metadata_view.innerHTML = '<tr><td>No metadata added yet!</td></tr>';
    }
  } else {
    this.metadata_view.innerHTML = '<tr><td><i>No metadata added yet!</i></td></tr>';
  }
}

_via_editor.prototype.metadata_get = function(fid, mid, metadata_index) {
  var tr = document.createElement('tr');
  tr.setAttribute('data-fid', fid);
  tr.setAttribute('data-mid', mid);

  // first column: the action tools for metadata (like delete)
  var action_tools_container = document.createElement('td');
  this.get_metadata_action_tools(action_tools_container, fid, mid);
  tr.appendChild( action_tools_container );

  // second column: index of this metadata
  var metadata_index_container = document.createElement('td');
  metadata_index_container.innerHTML = metadata_index;
  tr.appendChild(metadata_index_container);

  // third column: where (i.e. location of metadata)
  var location = document.createElement('td');
  var where_type = document.createElement('span');
  location.appendChild(where_type);
  if ( this.d.metadata_store[fid][mid].where_target() === _VIA_WHERE_TARGET.SEGMENT &&
       this.d.metadata_store[fid][mid].where_target() === _VIA_WHERE_SHAPE.TIME
     ) {
    var n = this.d.metadata_store[fid][mid].where.length;
    var i;
    var ul = document.createElement('ul');
    for ( i = 2; i < n; i = i + 2 ) { // the time coordinates are stored in array[2,...]
      var li = document.createElement('li');
      // only one segment
      var t1 = document.createElement('button');
      t1.setAttribute('class', 'text_button');
      t1.setAttribute('data-fid', fid);
      t1.setAttribute('data-mid', mid);
      t1.setAttribute('data-where_index', 2);
      t1.innerHTML = this.d.metadata_store[fid][mid].where[i].toFixed(3).toString();
      t1.addEventListener('click', this.jump_to_metadata.bind(this));

      var arrow = document.createElement('span');
      arrow.innerHTML = '&rarr;';

      var t2 = t1.cloneNode();
      t2.setAttribute('data-where_index', 3);
      t2.innerHTML = this.d.metadata_store[fid][mid].where[i+1].toFixed(3).toString();
      t2.addEventListener('click', this.jump_to_metadata.bind(this));

      li.appendChild(t1);
      li.appendChild(arrow);
      li.appendChild(t2);
      ul.appendChild(li);
    }
    location.appendChild(ul);
  }
  tr.appendChild(location);

  // subsequent columns: what (i.e. the attributes for this metadata)
  var aid;
  for ( aid in this.d.attribute_store ) {
    var td = document.createElement('td');
    td.setAttribute('data-aid', aid);
    td.appendChild( this.get_attribute_html_element(fid, mid, aid) );
    tr.appendChild(td);
  }

  return tr;
}

_via_editor.prototype.get_metadata_action_tools = function(container, fid, mid) {
  var del = _via_util_get_svg_button('micon_delete', 'Delete Metadata');
  del.setAttribute('data-fid', fid);
  del.setAttribute('data-mid', mid);
  del.addEventListener('click', this.metadata_del.bind(this));
  container.appendChild(del);

  /*
  var edit = _via_util_get_svg_button('micon_edit', 'Select Metadata for Editing');
  edit.setAttribute('data-fid', fid);
  edit.setAttribute('data-mid', mid);
  edit.addEventListener('click', this.metadata_edit.bind(this));
  container.appendChild(edit);
  */
}

_via_editor.prototype.get_attribute_html_element = function(fid, mid, aid) {
  var aval  = this.d.metadata_store[fid][mid].what[aid];
  var dval  = this.d.attribute_store[aid].default_option_id;
  var atype = this.d.attribute_store[aid].type;
  var el    = this.d.attribute_store[aid].html_element();
  el.setAttribute('data-fid', fid);
  el.setAttribute('data-mid', mid);
  el.setAttribute('data-aid', aid);

  switch(atype) {
  case _VIA_ATTRIBUTE_TYPE.TEXT:
    if ( typeof(aval) === 'undefined' ) {
      aval = dval;
    }
    el.innerHTML = aval;

    break;

  case _VIA_ATTRIBUTE_TYPE.SELECT:
    // set the selected option corresponding to atype
    var n = el.options.length;
    var i;
    if ( typeof(aval) === 'undefined' ) {
      aval = dval;
    }
    for ( i = 0; i < n; ++i ) {
      if ( el.options[i].value === aval ) {
        el.options[i].setAttribute('selected', 'true');
      } else {
        el.options[i].removeAttribute('selected');
      }
    }
    break;

  default:
    console.log('attribute type ' + atype + ' not implemented yet!');
    var el = document.createElement('span');
    el.innerHTML = aval;
    return el;
  }
  return el;
}

_via_editor.prototype.get_metadata_header = function() {
  var tr = document.createElement('tr');
  tr.appendChild( this.html_element('th', '') );
    tr.appendChild( this.html_element('th', 'Id') );
  tr.appendChild( this.html_element('th', 'Location') );

  var aid;
  for ( aid in this.d.attribute_store ) {
    tr.appendChild( this.html_element('th',
                                      this.d.attribute_store[aid].attr_name)
                  );
  }

  var thead = document.createElement('thead');
  thead.appendChild(tr);
  return thead;
}

_via_editor.prototype.html_element = function(name, text) {
  var e = document.createElement(name);
  e.innerHTML = text;
  return e;
}

//
// Metadata preview
//

_via_editor.prototype.jump_to_metadata = function(e) {
  var fid = e.target.dataset.fid;
  var mid = e.target.dataset.mid;
  var where_index = e.target.dataset.where_index;
  if ( this.d.metadata_store[fid][mid].where_target() === _VIA_WHERE_TARGET.SEGMENT &&
       this.d.metadata_store[fid][mid].where_target() === _VIA_WHERE_SHAPE.TIME
     ) {
    this.a.preload[fid].media_annotator.media.currentTime = this.d.metadata_store[fid][mid].where[where_index];
  }
}

//
// attribute
//
_via_editor.prototype.attribute_clear = function() {
  this.attribute_view.innerHTML = '';
}

_via_editor.prototype.attributes_update = function() {
  this.attribute_clear();

  if ( this.d.aid_list.length ) {
    this.attribute_view.appendChild( this.get_attribute_header() );

    // add each metadata
    var tbody = document.createElement('tbody');
    var aindex;
    for ( aindex in this.d.aid_list ) {
      var aid = this.d.aid_list[aindex];
      tbody.appendChild( this.get_attribute(aid) );
    }
    this.attribute_view.appendChild(tbody);
  }
}

_via_editor.prototype.get_attribute_header = function() {
  var tr = document.createElement('tr');
  tr.appendChild( this.html_element('th', '') );
  tr.appendChild( this.html_element('th', 'Id') );
  tr.appendChild( this.html_element('th', 'Name') );
  tr.appendChild( this.html_element('th', 'Type') );
  tr.appendChild( this.html_element('th', 'Default Value') );
  tr.appendChild( this.html_element('th', 'Options') );
  tr.appendChild( this.html_element('th', 'Preview') );

  var thead = document.createElement('thead');
  thead.appendChild(tr);
  return thead;
}

_via_editor.prototype.get_attribute = function(aid) {
  var tr = document.createElement('tr');
  tr.setAttribute('data-aid', aid);

  // first column: the action tools for metadata (like delete)
  var action_tools_container = document.createElement('td');
  this.get_attribute_action_tools(action_tools_container, aid);
  tr.appendChild( action_tools_container );

  // second column: aid (i.e. attribute id)
  tr.appendChild( this.html_element('td', aid) );

  // third column: name
  tr.appendChild( this.html_element('td', this.d.attribute_store[aid].attr_name) );

  // fourth column: type
  var type_select = document.createElement('select');
  type_select.setAttribute('data-aid', aid);
  type_select.addEventListener('change', this.attribute_update_type.bind(this));
  var type_str;
  for ( type_str in _VIA_ATTRIBUTE_TYPE ) {
    var oi = document.createElement('option');
    oi.setAttribute('value', _VIA_ATTRIBUTE_TYPE[type_str]);
    oi.innerHTML = type_str;

    if ( _VIA_ATTRIBUTE_TYPE[type_str] === this.d.attribute_store[aid].type ) {
      oi.setAttribute('selected', '');
    }
    type_select.appendChild(oi);
  }
  var type = document.createElement('td');
  type.appendChild( type_select );
  tr.appendChild( type );

  // fifth column: default value (only if other than TEXT)
  if ( this.d.attribute_store[aid].type === _VIA_ATTRIBUTE_TYPE.TEXT ) {
    // text has no defaults
    tr.appendChild( this.html_element('td', '-') );
  } else {
    var option = this.d.attribute_store[aid].options[ this.d.attribute_store[aid].default_option_id ];
    tr.appendChild( this.html_element('td', option) );
  }

  // sixth column: options
  if ( this.d.attribute_store[aid].type === _VIA_ATTRIBUTE_TYPE.TEXT ) {
    // text has no defaults
    tr.appendChild( this.html_element('td', '-') );
  } else {
    var option_input = document.createElement('textarea');
    option_input.setAttribute('data-aid', aid);
    option_input.setAttribute('title', 'Enter options as comma separated value with the default option prefixed using an *. For example: "a,*b,c"');
    option_input.addEventListener('change', this.attribute_update_options.bind(this));
    option_input.innerHTML = this.d.attribute_store[aid].options_to_csv();
    tr.appendChild( option_input );
  }

  // sixth column: preview of attribute
  var preview = document.createElement('td');
  preview.appendChild( this.d.attribute_store[aid].html_element() );
  tr.appendChild(preview);

  return tr;
}

_via_editor.prototype.get_attribute_name_entry_panel = function() {
  var c = document.createElement('div');
  c.setAttribute('class', 'attribute_entry');

  this.new_attribute_name_input = document.createElement('input');
  this.new_attribute_name_input.setAttribute('type', 'text');
  this.new_attribute_name_input.setAttribute('placeholder', 'name of new attribute');
  c.appendChild(this.new_attribute_name_input);

  var add = document.createElement('button');
  add.setAttribute('class', 'text-button');
  add.innerHTML = 'Create';
  add.addEventListener('click', this.on_attribute_create.bind(this));
  c.appendChild(add);

  return c;
}

_via_editor.prototype.get_attribute_action_tools = function(container, aid) {
  var del = _via_util_get_svg_button('micon_delete', 'Delete Attribute');
  del.setAttribute('data-aid', aid);
  del.addEventListener('click', this.attribute_del.bind(this));
  container.appendChild(del);
}

_via_editor.prototype.update_attribute_for = function(aid) {
  var tbody = this.attribute_view.getElementsByTagName('tbody')[0];
  var n = tbody.childNodes.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    if ( tbody.childNodes[i].dataset.aid === aid ) {
      var new_attribute = this.get_attribute(aid);
      tbody.replaceChild( new_attribute, tbody.childNodes[i] );
      break;
    }
  }
}

//
// Listeners for data update events
//
_via_editor.prototype.metadata_del = function(e) {
  var fid = e.currentTarget.dataset.fid;
  var mid = e.currentTarget.dataset.mid;
  this.d.metadata_del(fid, mid).then( function(ok) {
    // we don't need to do anything when metadata delete is successful
  }.bind(this), function(err) {
    console.log(err)
  }.bind(this));
}

_via_editor.prototype.metadata_edit = function(e) {
  var fid = e.target.parentNode.dataset.fid;
  var mid = e.target.parentNode.dataset.mid;
  console.log('@todo: edit metadata: fid=' + fid + ', mid=' + mid);
}

_via_editor.prototype.on_attribute_create = function(e) {
  var new_attribute_name = this.new_attribute_name_input.value;
  this.d.attribute_add(new_attribute_name,
                       _VIA_ATTRIBUTE_TYPE.TEXT
                      ).then( function(ok) {
                        // attribute was added
                      }.bind(this), function(err) {
                        console.log(err);
                      }.bind(this));
}

_via_editor.prototype.attribute_del = function(e) {
  var aid = e.currentTarget.dataset.aid;
  this.d.attribute_del(aid).then( function(ok) {
    // we don't need to do anything when attribute delete is successful
  }.bind(this), function(err) {
    console.log(err)
  }.bind(this));
}

_via_editor.prototype.attribute_update_options = function(e) {
  var aid = e.target.dataset.aid;
  var new_options_csv = e.target.value;
  console.log(e.target.innerHTML)
  this.d.attribute_update_options(aid, new_options_csv);
  console.log('aid='+aid+', new_options_csv='+new_options_csv);
}

_via_editor.prototype.attribute_update_type = function(e) {
  var aid = e.target.dataset.aid;
  var new_type = e.target.options[ e.target.selectedIndex ].value;
  this.d.attribute_update_type(aid, new_type);
  console.log('aid='+aid+', new_type='+new_type);
}

_via_editor.prototype.on_event_attribute_update = function(data, event_payload) {
  this.update_attribute_for(event_payload.aid);
}

_via_editor.prototype.on_event_attribute_del = function(data, event_payload) {
  this.metadata_update();
  this.attributes_update();
}

_via_editor.prototype.on_event_attribute_add = function(data, event_payload) {
  this.metadata_update();
  this.attributes_update();
}

_via_editor.prototype.on_event_metadata_add = function(data, event_payload) {
  this.metadata_update();
}

_via_editor.prototype.on_event_metadata_del = function(data, event_payload) {
  this.metadata_update();
}

_via_editor.prototype.on_event_file_show = function(data, event_payload) {
  console.log(event_payload)
  //this.now.file = event
  this.metadata_update();
}
</script>
<!-- End of file: js/_via_editor.js-->

<!-- Start of file: js/_via_diarise_test_set.js-->
<script>
'use strict'

var _VIA_PROJECT_DS_URI = 'http://zeus.robots.ox.ac.uk/via/ds/voxceleb_test_737/';
var _VIA_GROUP_DEFAULT_GID_LIST = ['spk1', 'laughter', 'music'];

var data = new _via_data();
var io = new _via_io(data);

_via_restore_deactivate();
/*
var store = new _via_store_localstorage(data);
if ( store.is_store_available() ) {
  store.prev_session_data_init().then( function(ok) {
    if ( store.prev_session_is_available() ) {
      _via_restore_activate();
    } else {
      _via_restore_deactivate();
    }
    if ( store._init() ) {
      data._store_add('localStorage', store);
    }
  }.bind(this), function(err) {
    _via_restore_deactivate();
    if ( store._init() ) {
      data._store_add('localStorage', store);
    }
  }.bind(this));
}
*/

function _via_restore_activate() {
  var button_container = document.getElementById('restore');
  var svg_child = button_container.getElementsByTagName('svg');
  var n = svg_child.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    svg_child[i].getElementsByTagName('title')[0].innerHTML += ' [' + store.prev_session_get_size() + ' bytes saved on ' + store.prev_session_get_timestamp() + ']';
  }
}

function _via_restore_deactivate() {
  var button_container = document.getElementById('restore');
  var svg_child = button_container.getElementsByTagName('svg');
  var n = svg_child.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    svg_child[i].classList.add('disabled_button');
    svg_child[i].setAttribute('onclick', '');
    svg_child[i].getElementsByTagName('title')[0].innerHTML = 'Restore feature disabled because your browser does not allow access to localStorage';
  }
}

var annotator_container = document.getElementById('annotator_container');
var annotator = new _via_annotator(annotator_container, data);
window.addEventListener('keydown', function(e) {
  // avoid handling events when text input field is in focus
  if ( e.target.type !== 'text' ) {
    annotator._on_event_keydown(e);
  }
});

var filelist_element = document.getElementById('file_manager_filelist');
var project_name_element = document.getElementById('_via_filemanager_project_name');
var project_rev_selector = document.getElementById('_via_filemanager_project_rev_selector');
var file_manager = new _via_file_manager(data, annotator, filelist_element, project_name_element, project_rev_selector);
file_manager._init();

function _via_on_browser_resize() {
  annotator.emit_event('container_resize', {});
}

if ( true ) {
  var project_list = document.getElementById('project_list');
  for ( var i = 1; i < 737; ++i ) {
    var o = document.createElement('option');
    var label = i;
    if ( i > 0 && i < 10 ) {
      label = '00' + i;
    } else {
      if ( i > 9 && i < 100 ) {
        label = '0' + i;
      }
    }
    o.innerHTML = "Load Test Video: " + label;
    o.setAttribute('value', 'voxceleb_test_737_' + label);
    project_list.appendChild(o);
  }
  _via_project_load_remote('voxceleb_test_737_001'); // default project

  project_list.addEventListener('change', function(e) {
    _via_project_load_remote(e.target.options[e.target.selectedIndex].value);
  }.bind(this));
}

function _via_project_load_remote(project_id, revid) {
  var project_uri = _VIA_PROJECT_DS_URI + project_id;
  if ( typeof(revid) !== 'undefined' ) {
    project_uri = project_uri + '?rev=' + revid;
  }

  _via_util_remote_get(project_uri).then( function(file_content) {
    try {
      var project_data = JSON.parse(file_content);
      data._project_load( project_data );
    }
    catch(err) {
      _via_util_msg_show('Failed to load project [' + project_id + '] from malformed json data!', true);
      console.log(err)
    }
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to load project [' + project_id + ']', true);
  }.bind(this));
}
</script>
<!-- End of file: js/_via_diarise_test_set.js-->

    <!--
        SVG icons
        Icons prefixed with "micon_" are downloaded from https://material.io/icons
      -->
    <svg style="display:none;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <symbol id="shape_rectangle">
          <rect width="20" height="14" x="2" y="5" ></rect>
        </symbol>
        <symbol id="shape_circle">
          <circle r="10" cx="12" cy="12"></circle>
        </symbol>
        <symbol id="shape_ellipse">
          <ellipse rx="10" ry="8" cx="12" cy="12"></ellipse>
        </symbol>
        <symbol id="shape_point">
          <circle r="3" cx="12" cy="12"></circle>
        </symbol>
        <symbol id="shape_polygon">
          <path d="M 4 12 L 10 2 L 20 6 L 18 16 L 8 20 z"></path>
        </symbol>
        <symbol id="shape_polyline" stroke-width="1" stroke="black">
          <line x1="3" y1="4" x2="8" y2="18"/>
          <line x1="8" y1="18" x2="14" y2="6"/>
          <line x1="14" y1="6" x2="20" y2="14"/>
          <circle r="2" cx="3" cy="4"></circle>
          <circle r="2" cx="8" cy="18"></circle>
          <circle r="2" cx="14" cy="6"></circle>
          <circle r="2" cx="20" cy="14"></circle>
        </symbol>

        <symbol id="micon_settings">
          <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path>
        </symbol>
        <symbol id="micon_save">
          <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path>
        </symbol>
        <symbol id="micon_open">
          <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"></path>
        </symbol>
        <symbol id="micon_upload">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
        </symbol>
        <symbol id="micon_download">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
        </symbol>
        <symbol id="micon_zoomin">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
          <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/>
        </symbol>
        <symbol id="micon_zoomout">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"></path>
        </symbol>
        <symbol id="micon_delete">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </symbol>
        <symbol id="micon_copy">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path>
        </symbol>
        <symbol id="micon_paste">
          <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"></path>
        </symbol>
        <symbol id="micon_insertcomment">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path>
        </symbol>
        <symbol id="micon_edit">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
        </symbol>

        <!-- File Manager -->
        <symbol id="micon_lib_add">
          <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
        </symbol>
        <symbol id="micon_add_circle">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
        </symbol>
        <symbol id="micon_remove_circle">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"/>
        </symbol>
        <symbol id="micon_navigate_next">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
        </symbol>
        <symbol id="micon_navigate_prev">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </symbol>
        <symbol id="micon_search">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </symbol>
        <!-- Import/Export -->
        <symbol id="icon_import">
          <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"></path>
        </symbol>
        <symbol id="icon_export">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
        </symbol>

        <!-- composed by Abhishek Dutta from existing materian icons, 31 Jan. 2019 -->
        <symbol id="micon_add_image">
          <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3z"/>
          <path transform="translate(-9,-12) scale(1.8 1.8)" d="M5 19l3-4 2 3 3-4 4 5H5z"/>
        </symbol>
        <!-- composed by Abhishek Dutta from existing materian icons, 31 Jan. 2019 -->
        <symbol id="micon_add_video">
          <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3z"/>
          <path transform="translate(-8,-4) scale(1.6 1.6)" d="M10 16.5l6-4.5-6-4.5v9z"/>
        </symbol>
        <!-- composed by Abhishek Dutta from existing materian icons, 31 Jan. 2019 -->
        <symbol id="micon_add_audio">
          <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3z"/>
          <path transform="translate(-11,-4) scale(1.4 1.4)" d="M8 15c0-1.66 1.34-3 3-3 .35 0 .69.07 1 .18V6h5v2h-3v7.03c-.02 1.64-1.35 2.97-3 2.97-1.66 0-3-1.34-3-3z"/>
        </symbol>

        <!-- Video player controls -->
        <symbol id="micon_play">
          <path d="M8 5v14l11-7z"/>
        </symbol>
        <symbol id="micon_pause">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </symbol>
        <symbol id="micon_mark_start">
          <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"/>
        </symbol>
        <symbol id="micon_mark_end">
          <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"/>
        </symbol>

        <!-- Temporal Segments -->
        <symbol id="micon_add">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </symbol>

        <!-- Help -->
        <symbol id="micon_help">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
        </symbol>

        <!-- Restore -->
        <symbol id="micon_restore_load">
          <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm-2 16c-2.05 0-3.81-1.24-4.58-3h1.71c.63.9 1.68 1.5 2.87 1.5 1.93 0 3.5-1.57 3.5-3.5S13.93 9.5 12 9.5c-1.35 0-2.52.78-3.1 1.9l1.6 1.6h-4V9l1.3 1.3C8.69 8.92 10.23 8 12 8c2.76 0 5 2.24 5 5s-2.24 5-5 5z"/>
        </symbol>
        <symbol id="micon_restore_save">
<path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
        </symbol>

      </defs>
    </svg>
  </body>
</html>
