<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chimpanzee Video Annotation : VIA</title>
  <meta name="author" content="Abhishek Dutta">
  <meta name="description" content="VIA is a standalone image annotator application packaged as a single HTML file (< 400 KB) that runs on most modern web browsers.">
  <style>
.toolbar { display:block; }
#stat_content table { border-collapse:collapse; border:1px solid #cccccc; }
#stat_content td, #stat_content th { border:1px solid #cccccc; padding:0.4em 0.5em; }
  </style>
</head>

<body>
<h1>Annotation Upload Statistics for [chimp_2012_2013] Dataset</h1>
<div class="toolbar"></div>

<div id="stat_content">Loading ...</div>

<script>
var VOXCELEB_DS_URI = 'http://zeus.robots.ox.ac.uk/via/ds/chimp_2012_2013';

try {
  var project_data = { '2012': [1,18], '2013': [1,9] };
  var payload = { 'docs':[] };
  var label;
  for ( var year in project_data ) {
    var start = project_data[year][0];
    var end = project_data[year][1];
    for ( var i = start; i <= end; ++i ) {
      var project_index = i;
      if ( i > 0 && i < 10 ) {
        project_index = '00' + i;
      } else {
        if ( i > 9 && i < 100 ) {
          project_index = '0' + i;
        }
      }
      var label = year + '_' + project_index;
      payload['docs'].push( { 'id': 'chimp_' + label} );
    }
  }

  _via_util_stat_fetch(payload).then( function(ok) {
    _via_util_stat_show(ok);
  }.bind(this), function(err) {
    document.getElementById('stat_content').innerHTML = 'Error';
    console.warn('Error');
  }.bind(this));
}
catch(err) {
  console.log(err)
}

function _via_util_stat_show(stat_str) {
  var c = document.getElementById('stat_content');
  var t = document.createElement('table');

  var thead = document.createElement('thead');
  var headr = document.createElement('tr');
  var cols = [ 'Video', 'Upload Count', 'Last Commit', 'Commit List' ];
  for ( var i in cols ) {
    var col = document.createElement('th');
    col.innerHTML = cols[i];
    headr.appendChild(col);
  }
  thead.appendChild(headr);
  t.appendChild(thead);

  var tbody = document.createElement('tbody');
  var d = JSON.parse(stat_str);
  for ( var i in d.results ) {
    var commit = d.results[i]['docs'][0]['ok']['project_store']['update_history'];
    var row = document.createElement('tr');
    var id = document.createElement('td');
    id.innerHTML = d.results[i]['docs'][0]['ok']['project_store']['project_name'];
    var upload_count = document.createElement('td');
    upload_count.innerHTML = commit.length;
    row.appendChild(id);
    row.appendChild(upload_count);
    
    var lcommit = document.createElement('td');
    var clist = document.createElement('td');
    var chistory = {};
    var n = commit.length;
    if ( n ) {
      var ltokens = commit[n-1].split(',');
      lcommit.innerHTML = ltokens[2];

      var username;
      for ( var i = 0; i < n; ++i ) {
        username = commit[i].split(',')[0];
        if ( chistory.hasOwnProperty(username) ) {
          chistory[username] += 1;
        } else {
          chistory[username] = 1;
        }
      }
      clist.innerHTML = JSON.stringify(chistory);
    }
    row.appendChild(lcommit);
    row.appendChild(clist);

    tbody.appendChild(row);  
  }
  t.appendChild(tbody);

  c.innerHTML = '';
  c.appendChild(t)
}

function _via_util_stat_fetch(payload) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', VOXCELEB_DS_URI + '/_bulk_get');
    xhr.addEventListener('error', function(e) {
      err_callback();
    }.bind(this));
    xhr.addEventListener('abort', function(e) {
      err_callback();
    }.bind(this));
    xhr.addEventListener('load', function(e) {
      console.log(xhr.status)
      switch(xhr.status) {
        case 200:
          ok_callback(xhr.responseText);
          break;
        default:
          err_callback();
          break;
      }
    }.bind(this));
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.send( JSON.stringify(payload) );
  }.bind(this));
}
</script>
</body>
</html>
